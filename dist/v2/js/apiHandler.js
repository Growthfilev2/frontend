var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},deviceInfo=void 0,currentDevice=void 0,meta=void 0,requestFunctionCaller={statusChange:statusChange,share:share,update:update,create:create,backblaze:backblaze,updateAuth:updateAuth,comment:comment,changePhoneNumber:changePhoneNumber,newBankAccount:newBankAccount,removeBankAccount:removeBankAccount,idProof:idProof,device:device,acquisition:acquisition,fcmToken:fcmToken,pan:pan,aadhar:aadhar,profile:profile,shareLink:shareLink},sendSuccessRequestToMainThread=function(e,t){self.postMessage({response:e,success:!0,id:t})},sendErrorRequestToMainThread=function(e){var t={message:e.message,body:e,apiRejection:!1,success:!1,id:e.id,requestType:e.requestType,stack:e.stack||""};e.code?t.apiRejection=!0:instant(JSON.stringify(t),meta),self.postMessage(t)};function handleNow(n,r){fetchServerTime(n.meta,r).then(function(t){var e=r.transaction(["root"],"readwrite"),o=e.objectStore("root");o.get(n.meta.user.uid).onsuccess=function(e){rootRecord=e.target.result,rootRecord.serverTime=t.timestamp-Date.now(),o.put(rootRecord)},e.oncomplete=function(){if(!t.removeFromOffice)return self.postMessage({response:t,success:!0,id:n.id});Array.isArray(t.removeFromOffice)&&t.removeFromOffice.length&&removeFromOffice(t.removeFromOffice,n.meta,r).then(function(e){sendSuccessRequestToMainThread(e,workerId)}).catch(function(e){e.id=n.id,e.requestType=n.type,sendErrorRequestToMainThread(e)})}}).catch(function(e){e.id=n.id,e.requestType=n.type,sendErrorRequestToMainThread(e)})}function http(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return new Promise(function(o,n){var r=new XMLHttpRequest;r.open(e.method,e.url,!0),t&&(r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Authorization","Bearer "+e.token)),r.onreadystatechange=function(){if(4===r.readyState){if(!r.status||226<r.status){if(!r.response)return;var e=JSON.parse(r.response),t={message:e.message,code:e.code};return n(t)}r.responseText?o(JSON.parse(r.responseText)):o("success")}},r.send(e.body||null)})}function fetchServerTime(i,a){return new Promise(function(e,t){var o=i.apiUrl+"now",n=a.transaction(["root"],"readwrite"),r=n.objectStore("root");r.get(i.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved&&(t.officesRemoved.forEach(function(e){o=o+"&removeFromOffice="+e.replace(" ","%20")}),delete t.officesRemoved),r.put(t))},n.oncomplete=function(){http({method:"GET",url:o,body:null,token:i.user.token}).then(e).catch(t)}})}function instant(e,t){http({method:"POST",url:t.apiUrl+"services/logs",body:e,token:t.user.token}).then(console.log).catch(console.log)}function comment(e,t){return http({method:"POST",url:t.apiUrl+"activities/comment",body:JSON.stringify(e),token:t.user.token,timeout:15e3})}function changePhoneNumber(e,t){return console.log("change number"),http({method:"POST",url:t.apiUrl+"changePhoneNumber",body:JSON.stringify(e),token:t.user.token,timeout:null})}function removeBankAccount(e,t){return http({method:"DELETE",url:t.apiUrl+"services/accounts",body:JSON.stringify(e),token:t.user.token,timeout:null})}function newBankAccount(e,t){return http({method:"PUT",url:t.apiUrl+"profile/linkedAccount",body:JSON.stringify(e),token:t.user.token,timeout:null})}function searchOffice(e,t){return http({method:"GET",url:t.apiUrl+"services/search?q="+e.query,body:JSON.stringify(e),token:t.user.token,timeout:null})}function checkIns(e,t){return http({method:"POST",url:t.apiUrl+"services/checkIns",body:JSON.stringify(e),token:t.user.token,timeout:null})}function idProof(e,t){return http({method:"POST",url:t.apiUrl+"services/idProof",body:JSON.stringify(e),token:t.user.token,timeout:null})}function device(e,t){return http({method:"PUT",url:t.apiUrl+"profile/device",body:JSON.stringify(e),token:t.user.token,timeout:null})}function acquisition(e,t){return http({method:"PUT",url:t.apiUrl+"profile/acquisition",body:JSON.stringify(e),token:t.user.token,timeout:null})}function fcmToken(e,t){return http({method:"PUT",url:t.apiUrl+"profile/fcmToken",body:JSON.stringify(e),token:t.user.token,timeout:null})}function pan(e,t){return http({method:"PUT",url:t.apiUrl+"profile/pan",body:JSON.stringify(e),token:t.user.token,timeout:null})}function aadhar(e,t){return http({method:"PUT",url:t.apiUrl+"profile/aadhar",body:JSON.stringify(e),token:t.user.token,timeout:null})}function profile(e,t){return http({method:"GET",url:t.apiUrl+"profile/",body:null,token:t.user.token,timeout:null})}function shareLink(e,t){return http({method:"POST",url:t.apiUrl+"services/shareLink",body:JSON.stringify(e),token:t.user.token,timeout:null})}function createSubscription(e,t){return http({method:"POST",url:t.apiUrl+"services/subscription",body:JSON.stringify(e),token:t.user.token,timeout:null})}function dm(e,t){return console.log(e),http({method:"POST",url:t.apiUrl+"dm",body:JSON.stringify(e),token:t.user.token,timeout:15e3})}function statusChange(e,t){return http({method:"PATCH",url:t.apiUrl+"activities/change-status",body:JSON.stringify(e),token:t.user.token,timeout:15e3})}function share(e,t){return http({method:"PATCH",url:t.apiUrl+"activities/share",body:JSON.stringify(e),token:t.user.token,timeout:15e3})}function update(e,t){return http({method:"PATCH",url:t.apiUrl+"activities/update",body:JSON.stringify(e),token:t.user.token,timeout:15e3})}function create(e,t){return http({method:"POST",url:t.apiUrl+"activities/create",body:JSON.stringify(e),token:t.user.token,timeout:null})}function acquisition(e,t){return http({method:"PUT",url:t.apiUrl+"profile/acquisition",body:JSON.stringify(e),token:t.user.token,timeout:null})}function geolocationApi(r,i,a){return new Promise(function(t,o){var n=new XMLHttpRequest;n.open("POST","https://www.googleapis.com/geolocation/v1/geolocate?key="+i.mapKey,!0),n.setRequestHeader("Content-Type","application/json"),n.onreadystatechange=function(){if(4===n.readyState){if(400<=n.status)return 0<a?void setTimeout(function(){geolocationApi(r,i,a-=1).then(t).catch(o)},1e3):o({message:JSON.parse(n.response).error.message,body:{geolocationResponse:JSON.parse(n.response),geolocationBody:r}});var e=JSON.parse(n.response);return e?t({latitude:e.location.lat,longitude:e.location.lng,accuracy:e.accuracy,provider:r,lastLocationTime:Date.now()}):0<a?void setTimeout(function(){geolocationApi(r,i,a-=1).then(t).catch(o)},1e3):o({message:"Response From geolocation Api "+e,body:r})}},n.onerror=function(){if(!(0<a))return o({message:n});setTimeout(function(){geolocationApi(r,i,a-=1).then(t).catch(o)},1e3)},n.send(JSON.stringify(r))})}function removeFromOffice(r,i,a){return new Promise(function(t,n){var e=a.transaction(["map","calendar","children","subscriptions","activity"],"readwrite");e.oncomplete=function(){var e=a.transaction(["root"],"readwrite"),o=e.objectStore("root");o.get(i.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved=r,o.put(t))},e.oncomplete=function(){console.log("run read after removal"),t({response:"Office Removed",success:!0})},e.onerror=function(e){n({response:e,success:!1})}},e.onerror=function(){console.log(tx.error)},removeActivity(r,e)})}function removeActivity(o,n){["activity","children","map","calendar","subscriptions"].forEach(function(e){var t=n.objectStore(e).index("office");o.forEach(function(e){removeByIndex(t,e)})})}function removeByIndex(e,t){e.openCursor(t).onsuccess=function(e){var t=e.target.result;t&&(t.delete(),t.continue())}}function updateAuth(e,t){return http({method:"POST",url:"https://growthfile.com/json?action=update-auth",body:JSON.stringify(e),token:t.user.token,timeout:15e3})}function backblaze(e,t){return http({method:"POST",url:t.apiUrl+"services/images",body:JSON.stringify(e),token:t.user.token,timeout:3e4})}function updateAttendance(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1];e.forEach(function(e){e.id&&(e.editable=1,t.put(e))})}function updateReimbursements(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1];e.forEach(function(e){e.id&&t.put(e)})}function updatePayments(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1];e.forEach(function(e){e.id&&t.put(e)})}function updateCalendar(n,e){var r=e.objectStore("calendar");r.index("activityId").openCursor(n.activityId).onsuccess=function(e){var t=e.target.result;if(t){var o=t.delete();t.continue(),o.onsuccess=function(){console.log("remove calendar")},o.onerror=function(){instant(JSON.stringify({message:o.error.message}),meta)}}else{if(!Array.isArray(n.schedule))return;n.schedule.forEach(function(e){if("object"===(void 0===e?"undefined":_typeof(e))){var t={activityId:n.activityId,scheduleName:e.name,timestamp:n.timestamp,template:n.template,hidden:n.hidden,start:e.startTime,end:e.endTime,status:n.status,office:n.office};r.add(t)}})}}}function putMap(e,t){e.activityId&&t.objectStore("map").put(e)}function putAttachment(e,t,o){if(e.activityId){var n=t.objectStore("children"),r={activityId:e.activityId,status:e.status,template:e.template,office:e.office,attachment:e.attachment},i=o.user.phoneNumber;"employee"===e.template&&(e.attachment.hasOwnProperty("Employee Contact")&&(r.employee=e.attachment["Employee Contact"].value),e.attachment.hasOwnProperty("Phone Number")&&(r.employee=e.attachment["Phone Number"].value),e.attachment.hasOwnProperty("First Supervisor")&&e.attachment["First Supervisor"].value===i&&(r.team=1)),n.put(r)}}function removeUserFromAssigneeInActivity(n,e){removeByIndex(e.objectStore("addendum").index("user"),n.user);var r=e.objectStore("activity");r.get(n.activityId).onsuccess=function(e){var t=e.target.result;if(t){var o=t.assignees.findIndex(function(e){return e.phoneNumber===n.user});-1<o&&(t.assignees.splice(o,1),r.put(t))}}}function removeActivityFromDB(t,o){if(t){var e=o.objectStore("activity"),n=o.objectStore("children");e.delete(t),n.delete(t),["calendar","map","addendum"].forEach(function(e){removeByIndex(o.objectStore(e).index("activityId"),t)})}}function putSubscription(e,t){t.objectStore("subscriptions").put(e)}function successResponse(e,a,t,o,n){var r=t.transaction(["map","calendar","children","subscriptions","activity","addendum","root","users","attendance","reimbursement","payment"],"readwrite"),c=r.objectStore("addendum"),u=r.objectStore("activity"),d=r.objectStore("users"),i=r.objectStore("attendance"),s=r.objectStore("reimbursement"),m=r.objectStore("payment");e.addendum.forEach(function(e){e.hasOwnProperty("user")&&(e.unassign&&(e.user==a.user.phoneNumber?removeActivityFromDB(e.activityId,r):removeUserFromAssigneeInActivity(e,r)),c.put(e))}),e.locations.forEach(function(e){putMap(e,r)}),console.log({}),console.log({}),updateAttendance(e.attendances,i),updateReimbursements(e.reimbursements,s),updatePayments(e.payments,m),e.activities.forEach(function(i){var o,n;i.activityId&&(i.canEdit,i.editable,"duty"===i.template?(o=i,(n=r.objectStore("activity")).get(o.activityId).onsuccess=function(e){var t=e.target.result;t&&(o.timer=t.timer),n.put(o)}):u.put(i),updateCalendar(i,r),putAttachment(i,r,a),c.index("activityId").getAll(i.activityId).onsuccess=function(e){var t,o,u,s,n,r=(e.target.result||[]).sort(function(e,t){return t.timestamp-e.timestamp})[0];t=r,o=i.assignees,u=a,s=d,n=Promise.resolve(),o.forEach(function(e){n=n.then(function(){return n=s,r=e,i=t,a=u,new Promise(function(o,e){n.get(r.phoneNumber).onsuccess=function(e){var t=e.target.result||{};t.displayName=r.displayName,t.mobile=r.phoneNumber,t.photoURL=r.photoURL,t.NAME_SEARCH=r.displayName.toLowerCase(),i&&(t.mobile!==a.user.phoneNumber&&(console.log("increment count"),t.count?t.count+=1:t.count=1),t.timestamp=i.timestamp,t.comment=i.comment,i.key=a.user.phoneNumber+r.phoneNumber,c.put(i)),n.put(t).onsuccess=function(){o(!0)}}});var n,r,i,a})})})}),e.products&&e.products.forEach(function(e){putAttachment(e,r,a)}),e.templates.forEach(function(e){e.activityId?putSubscription(e,r):instant(JSON.stringify({message:"activityId missing from template object",body:e}),a)}),updateRoot(e,r,a.user.uid),r.oncomplete=function(){return console.log("all completed"),o(e)},r.onerror=function(){return n(r.error)}}function updateUserStore(o,n,r,i){o.get(n).onsuccess=function(e){var t=e.target.result||{count:0,displayName:"",photoURL:"",mobile:n,comment:"",timestamp:"",NAME_SEARCH:i.displayName.toLowerCase()};if(t.comment=r.comment,t.timestamp=r.timestamp,t.mobile=i.phoneNumber,t.displayName=i.displayName,t.photoURL||(t.photoURL=i.photoURL),t.NAME_SEARCH=i.displayName.toLowerCase(),r.isComment&&!counter[n])return o.put(t);t.count?t.count+=counter[n]:t.count=counter[n],o.put(t)}}function updateRoot(o,e,t){var n=e.objectStore("root");n.get(t).onsuccess=function(e){var t=e.target.result;t.fromTime=o.upto,console.log("start adding upto"),n.put(t)}}function updateIDB(a){return new Promise(function(t,o){var e=a.db.transaction(["root"]),n=e.objectStore("root"),r=void 0,i=void 0;n.get(a.payload.meta.user.uid).onsuccess=function(e){r=e.target.result,i=r.fromTime},e.oncomplete=function(){http({method:"GET",url:a.payload.meta.apiUrl+"read1?from="+i,data:null,token:a.payload.meta.user.token}).then(function(e){return console.log("read completed"),successResponse(e,a.payload.meta,a.db,t,o)}).catch(function(e){return o(e)})}})}self.onmessage=function(t){console.log(t),meta=t.data.meta;var o=t.data.id;if("geolocationApi"!==t.data.type){var n=indexedDB.open(t.data.meta.user.uid);n.onsuccess=function(){var e=n.result;return"now"===t.data.type?handleNow(t.data,e):"instant"===t.data.type?instant(t.data.body,t.data.meta):void("Null"!==t.data.type?requestFunctionCaller[t.data.type](t.data.body,t.data.meta).then(function(e){sendSuccessRequestToMainThread(e,o)}).catch(function(e){e.id=o,e.requestType=t.data.type,sendErrorRequestToMainThread(e)}):updateIDB({payload:t.data,db:e}).then(function(e){sendSuccessRequestToMainThread(e,o)}).catch(function(e){e.id=o,e.requestType=t.data.type,sendErrorRequestToMainThread(e)}))}}else geolocationApi(t.data.body,t.data.meta,3).then(function(e){sendSuccessRequestToMainThread(e,o)}).catch(function(e){e.id=o,self.postMessage(e)})};