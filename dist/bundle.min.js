var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function conversation(id,pushState){window.removeEventListener("scroll",handleScroll,false);checkIfRecordExists("activity",id).then(function(id){if(id){if(pushState){history.pushState(["conversation",id],null,null)}fetchAddendumForComment(id)}else{listView()}}).catch(handleError)}function checkIfRecordExists(store,id){return new Promise(function(resolve,reject){var user=firebase.auth().currentUser;var req=window.indexedDB.open(user.uid);req.onsuccess=function(){var db=req.result;var objectStore=db.transaction(store).objectStore(store);objectStore.get(id).onsuccess=function(event){var record=event.target.result;if(record){resolve(id)}else{resolve(false)}}};req.onerror=function(){reject({message:req.error.message+" from checkIfRecordExists"})}})}function fetchAddendumForComment(id){if(!id)return;var user=firebase.auth().currentUser;var req=window.indexedDB.open(user.uid);req.onsuccess=function(){var db=req.result;var transaction=db.transaction(["addendum"],"readonly");var addendumIndex=transaction.objectStore("addendum").index("activityId");createHeaderContent(db,id);commentPanel(id);statusChange(db,id);sendCurrentViewNameToAndroid("conversation");reinitCount(db,id);addendumIndex.openCursor(id).onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;if(!document.getElementById(cursor.value.addendumId)){createComment(db,cursor.value,user).then(function(comment){if(document.getElementById("chat-container")){document.getElementById("chat-container").appendChild(comment)}})}cursor.continue()};transaction.oncomplete=function(){if(document.querySelector(".activity--chat-card-container")){document.querySelector(".activity--chat-card-container").scrollTop=document.querySelector(".activity--chat-card-container").scrollHeight}}}}function commentPanel(id){if(document.querySelector(".activity--chat-card-container")){return}var commentPanel=document.createElement("div");commentPanel.className="activity--chat-card-container  mdc-top-app-bar--fixed-adjust panel-card";var chatCont=document.createElement("div");chatCont.id="chat-container";chatCont.className="mdc-card reverser-parent";var userCommentCont=document.createElement("div");userCommentCont.className="user-comment--container";var statusChangeContainer=document.createElement("div");statusChangeContainer.className="status--change-cont";var commentCont=document.createElement("div");commentCont.className="comment--container";var inputField=document.createElement("div");inputField.className="input--text-padding mdc-text-field mdc-text-field--dense";inputField.id="write--comment";inputField.style.width="100%";var input=document.createElement("input");input.className="mdc-text-field__input comment-field mdc-elevation--z4";input.type="text";inputField.appendChild(input);commentCont.appendChild(inputField);var btn=document.createElement("button");btn.classList.add("mdc-fab","mdc-fab--mini","hidden");btn.id="send-chat--input";var btnIcon=document.createElement("span");btnIcon.classList.add("mdc-fac__icon","material-icons");btnIcon.textContent="send";btn.appendChild(btnIcon);commentCont.appendChild(btn);commentPanel.appendChild(chatCont);userCommentCont.appendChild(commentCont);document.getElementById("app-current-panel").innerHTML=commentPanel.outerHTML+statusChangeContainer.outerHTML+userCommentCont.outerHTML;document.querySelector(".comment-field").oninput=function(evt){if(!evt.target.value||!evt.target.value.replace(/\s/g,"").length){hideSendCommentButton()}else{showSendCommentButton()}};document.getElementById("send-chat--input").onclick=function(){if(isLocationStatusWorking()){sendComment(id)}}}function sendComment(id){var comment=document.querySelector(".comment-field").value;var reqBody={activityId:id,comment:comment};requestCreator("comment",reqBody);document.querySelector(".comment-field").value="";hideSendCommentButton()}function hideSendCommentButton(){document.getElementById("send-chat--input").classList.add("hidden");document.getElementById("write--comment").style.width="100%";document.getElementById("write--comment").style.transition="0.3s ease";document.querySelector(".status--change-cont").style.transition="0.3s ease";document.querySelector(".status--change-cont").style.opacity="1"}function showSendCommentButton(){document.getElementById("send-chat--input").classList.remove("hidden");document.getElementById("write--comment").style.width="80%";document.querySelector(".status--change-cont").style.opacity="0"}function statusChange(db,id){var label=document.createElement("label");label.setAttribute("for","toggle-status");label.textContent="Done";var activityStore=db.transaction("activity").objectStore("activity");activityStore.get(id).onsuccess=function(event){var container=document.querySelector(".status--change-cont");var record=event.target.result;if(!record.canEdit||record.status==="CANCELLED"){var statusSpan=document.createElement("span");var _record=event.target.result;statusSpan.textContent="Activity "+_record.status.toLowerCase();if(container){container.innerHTML=statusSpan.outerHTML;container.style.textAlign="center"}return}if(record.editable==0){container?container.innerHTML=label.outerHTML+loader("status-loader").outerHTML:"";return}if(!document.querySelector(".status-check")){var div=document.createElement("div");div.className="mdc-form-field form-field-status";var checkbox=document.createElement("div");checkbox.className="mdc-checkbox status-check";var input=document.createElement("input");input.className="mdc-checkbox__native-control";input.id="toggle-status";input.type="checkbox";var checkbox_bckg=document.createElement("div");checkbox_bckg.className="mdc-checkbox__background";var svg='<svg class="mdc-checkbox__checkmark"\n      viewBox="0 0 24 24">\n      <path class="mdc-checkbox__checkmark-path"\n      fill="none"\n      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>\n      </svg>\n      <div class="mdc-checkbox__mixedmark"></div>';var mixedmark=document.createElement("div");mixedmark.className="mdc-checkbox__mixedmark";checkbox_bckg.innerHTML=svg;checkbox.appendChild(input);checkbox.appendChild(checkbox_bckg);div.appendChild(checkbox);if(container){container.innerHTML=div.outerHTML+label.outerHTML}}if(!document.querySelector(".mdc-checkbox"))return;switchControl=new mdc.checkbox.MDCCheckbox.attachTo(document.querySelector(".mdc-checkbox"));if(record.status==="CONFIRMED"){switchControl.checked=true}document.querySelector(".mdc-checkbox").onclick=function(){if(isLocationStatusWorking()){changeStatusRequest(switchControl,record)}else{resetStatusConfirmation(switchControl,record)}}}}function resetStatusConfirmation(switchControl,record){if(record.status==="CONFIRMED"){switchControl.checked=true}else{switchControl.checked=false}}function changeStatusRequest(switchControl,record){document.querySelector(".form-field-status").classList.add("hidden");document.querySelector(".status--change-cont").appendChild(loader("status-loader"));if(switchControl.checked){requestCreator("statusChange",{activityId:record.activityId,status:"CONFIRMED"})}else{requestCreator("statusChange",{activityId:record.activityId,status:"PENDING"})}}function createComment(db,addendum,currentUser){var showMap=false;return new Promise(function(resolve){var commentBox=document.createElement("div");commentBox.classList.add("comment-box","talk-bubble","tri-right","round","btm-left");currentUser.phoneNumber===addendum.user?commentBox.classList.add("current-user--comment","secondary-color-light"):commentBox.classList.add("other-user--comment","mdc-theme--primary-bg");commentBox.id=addendum.addendumId;var textContainer=document.createElement("div");textContainer.classList.add("talktext");var user=document.createElement("p");user.classList.add("user-name--comment","mdc-typography--subtitle2");getUserRecord(db,addendum.user).then(function(record){if(record.displayName){user.textContent=record.displayName}else{user.textContent=record.mobile}var comment=document.createElement("p");comment.classList.add("comment","mdc-typography--subtitle2");comment.textContent=addendum.comment;var commentInfo=document.createElement("span");commentInfo.className="comment--info";var datespan=document.createElement("span");datespan.textContent=moment(addendum.timestamp).format("DD-MM-YY H:mm");datespan.classList.add("comment-date","mdc-typography--caption");var link=document.createElement("div");var mapIcon=document.createElement("i");mapIcon.classList.add("user-map--span","material-icons");mapIcon.appendChild(document.createTextNode("location_on"));link.onclick=function(evt){if(!hasMapsApiLoaded())return;showMap=!showMap;var loc={lat:addendum.location["_latitude"],lng:addendum.location["_longitude"]};maps(evt,showMap,addendum.addendumId,loc)};mapIcon.dataset.latitude=addendum.location["_latitude"];mapIcon.dataset.longitude=addendum.location["_longitude"];link.appendChild(mapIcon);var mapDom=document.createElement("div");mapDom.className="map-convo";commentInfo.appendChild(datespan);commentInfo.appendChild(link);textContainer.appendChild(user);textContainer.appendChild(comment);textContainer.appendChild(commentInfo);commentBox.appendChild(textContainer);commentBox.appendChild(mapDom);resolve(commentBox)})})}function getUserRecord(db,number){return new Promise(function(resolve,reject){var usersObjectStore=db.transaction("users").objectStore("users");usersObjectStore.get(number).onsuccess=function(event){var record=event.target.result;if(!record)return resolve({displayName:"",mobile:number,photoURL:""});return resolve(record)}})}function hasMapsApiLoaded(){if((typeof google==="undefined"?"undefined":_typeof(google))==="object"&&_typeof(google.maps)==="object"){return true}return false}function maps(evt,show,id,location){var selector="";evt?selector=document.getElementById(id).querySelector(".map-convo"):selector=document.querySelector(".map-detail."+id);if(!show){selector.style.height="0px";evt?evt.target.textContent="location_on":"";return}if(selector.children.length!==0){selector.style.height="200px";evt?evt.target.textContent="arrow_drop_down":"";return}evt?evt.target.textContent="arrow_drop_down":"";selector.style.height="200px";var map=new google.maps.Map(selector,{zoom:16,center:location,disableDefaultUI:true});if(!evt){var customControlDiv=document.createElement("div");var customControl=new MapsCustomControl(customControlDiv,map,location.lat,location.lng);customControlDiv.index=1;map.controls[google.maps.ControlPosition.TOP_LEFT].push(customControlDiv)}var marker=new google.maps.Marker({position:location,map:map})}function MapsCustomControl(customControlDiv,map,lat,lng){var controlUI=document.createElement("div");controlUI.style.backgroundColor="#fff";controlUI.style.border="2px solid #fff";controlUI.style.borderRadius="3px";controlUI.style.boxShadow="0 2px 6px rgba(0,0,0,.3)";controlUI.style.cursor="pointer";controlUI.style.marginBottom="22px";controlUI.style.textAlign="center";controlUI.style.padding="0px 5px 0px 5px";customControlDiv.appendChild(controlUI);var controlText=document.createElement("a");controlText.href="https://www.google.com/maps?q="+lat+","+lng;controlText.className="material-icons";controlText.style.color="rgb(25,25,25)";controlText.style.fontSize="16px";controlText.style.lineHeight="38px";controlText.style.paddingLeft="5px";controlText.style.paddingRight="5px";controlText.style.textDecoration="none";controlText.innerHTML="open_in_new";controlUI.appendChild(controlText)}function createHeaderContent(db,id){var activityObjectStore=db.transaction("activity").objectStore("activity");var leftDiv=document.createElement("div");var backDiv=document.createElement("div");backDiv.className="back-icon";backDiv.id="back-conv";backDiv.style.float="left";var backIcon=document.createElement("i");backIcon.style.marginRight="5px";backIcon.className="material-icons back-icon--large";backIcon.textContent="arrow_back";backDiv.appendChild(backIcon);activityObjectStore.get(id).onsuccess=function(event){var record=event.target.result;getImageFromNumber(db,record.creator).then(function(uri){var dataObject=document.createElement("object");dataObject.data=uri||"./img/empty-user.jpg";dataObject.className="header--icon-creator";dataObject.type="image/jpeg";var creatorImg=document.createElement("img");creatorImg.src="./img/empty-user.jpg";creatorImg.className="header--icon-creator";dataObject.appendChild(creatorImg);backDiv.appendChild(dataObject);var primarySpan=document.createElement("div");primarySpan.className="mdc-list-item__text comment-header-primary mdc-typography--subtitle2";primarySpan.textContent=record.activityName;var secondarySpan=document.createElement("span");secondarySpan.className="mdc-list-item__secondary-text";secondarySpan.textContent="Click here to see details";primarySpan.appendChild(secondarySpan);leftDiv.appendChild(backDiv);leftDiv.appendChild(primarySpan);modifyHeader({id:"app-main-header",left:leftDiv.outerHTML});document.getElementById("back-conv").addEventListener("click",function(){backNav()});document.querySelector(".comment-header-primary").addEventListener("click",function(){checkIfRecordExists("activity",record.activityId).then(function(id){if(id){updateCreateActivity(record)}else{listView()}}).catch(handleError)})})}}function reinitCount(db,id){var transaction=db.transaction(["list"],"readwrite");var store=transaction.objectStore("list");store.get(id).onsuccess=function(event){var record=event.target.result;if(!record)return;record.count=0;store.put(record)};transaction.oncomplete=function(){}}function getImageFromNumber(db,number){return new Promise(function(resolve){var userObjStore=db.transaction("users").objectStore("users");userObjStore.get(number).onsuccess=function(event){var record=event.target.result;resolve(record?record.photoURL:"./img/empty-user.jpg")}})}function fillUsersInSelector(data){var ul=document.getElementById("data-list--container");var usersInRecord=data.record.assignees;var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var transaction=db.transaction(["users"]);var store=transaction.objectStore("users");document.querySelector(".selector-send").classList.remove("hidden");var btn=document.getElementById("selector-submit-send");btn.textContent="Add New Number";btn.dataset.type="add-number";var count=0;store.openCursor().onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;var userRecord=cursor.value;if(data.attachment.present){count++;ul.appendChild(createSimpleAssigneeLi(userRecord,true,false))}else if(usersInRecord.indexOf(cursor.value.mobile)==-1){count++;ul.appendChild(createSimpleAssigneeLi(userRecord,true,true))}cursor.continue()};transaction.oncomplete=function(){if(!count){ul.appendChild(noSelectorResult("No Contact Found"));document.getElementById("users-selector-search").style.display="none"}btn.onclick=function(){if(btn.dataset.type==="add-number"){document.getElementById("users-selector-search").style.display="none";removeChildNodes(ul);btn.remove();addNewNumber(data);return}if(data.attachment.present){var selector=document.querySelector(".mdc-radio.radio-selected");if(!selector){document.getElementById("selector-warning").textContent="* Please Select A Contact";return}var radio=new mdc.radio.MDCRadio(selector);updateDomFromIDB(data.record,{hash:"",key:data.attachment.key},{primary:JSON.parse(radio.value)}).then(function(activity){updateCreateActivity(activity,true)}).catch(handleError);return}if(data.record.hasOwnProperty("create")){resetSelectedContacts().then(function(selectedPeople){if(!selectedPeople.length){document.getElementById("selector-warning").textContent="* Please Select A Contact";return}updateDomFromIDB(data.record,{hash:"addOnlyAssignees"},{primary:selectedPeople}).then(function(activity){updateCreateActivity(activity,true)}).catch(handleError)});return}if(isLocationStatusWorking()){shareReq(data)}};var selectedBoxes=document.querySelectorAll('[data-selected="true"]');selectedBoxes.forEach(function(box){if(box){var mdcBox=new mdc.checkbox.MDCCheckbox.attachTo(box);mdcBox.checked=true;box.children[1].style.animation="none";box.children[1].children[0].children[0].style.animation="none"}})}}}function noSelectorResult(text){var noResult=document.createElement("div");noResult.className="data-not-found";var p=document.createElement("p");p.className="mdc-typography--headline5";p.textContent=text;noResult.appendChild(p);return noResult}function shareReq(data){resetSelectedContacts().then(function(people){var reqBody={activityId:data.record.activityId,share:people};document.querySelector("header").appendChild(progressBar());requestCreator("share",reqBody)})}function addNewNumber(data){var container=document.createElement("div");container.className="custom-number--container";var input=document.createElement("input");input.className="mdc-text-field__input";input.id="number-field";input.type="number";input.setAttribute("maxlength","10");input.setAttribute("size","10");input.required=true;input.onkeypress=function(event){return event.charCode>=48&&event.charCode<=57};input.oninput=function(){if(this.value.length>this.maxLength){this.value=this.value.slice(0,this.maxLength)}else if(this.value.length===this.maxLength){document.querySelector(".message-field").classList.remove("error-message");this.classList.add("valid-input");document.querySelector(".message-field").textContent="";document.getElementById("new-contact").disabled=false}else{document.querySelector(".message-field").classList.add("error-message");document.querySelector(".message-field").textContent="* Please Enter a valid Number";document.getElementById("new-contact").disabled=true}};var createButton=document.createElement("button");createButton.className="mdc-button";createButton.textContent="Add Contact";createButton.id="new-contact";createButton.onclick=function(){var number=document.getElementById("number-field").value;var formattedNumber=formatNumber(number);if(checkNumber(formattedNumber)){numberNotExist(formattedNumber).then(function(exist){if(exist){document.getElementById("new-contact").disabled=true;document.querySelector(".message-field").classList.add("error-message");document.querySelector(".message-field").textContent="* Contact already exist";return}if(data.attachment.present){updateDomFromIDB(data.record,{hash:"",key:data.attachment.key},{primary:formattedNumber}).then(function(activity){console.log(activity);updateCreateActivity(activity,true)}).catch(handleError);return}if(data.record.hasOwnProperty("create")){updateDomFromIDB(data.record,{hash:"addOnlyAssignees"},{primary:[formattedNumber]}).then(function(activity){updateCreateActivity(activity,true)}).catch(handleError);return}if(isLocationStatusWorking()){newNumberReq(data,formattedNumber)}})}else{document.querySelector(".message-field").classList.add("error-message");document.querySelector(".message-field").textContent="* Please Enter a valid Number";document.getElementById("new-contact").disabled=true}};var message=document.createElement("p");message.className="mdc-typography--subtitle2 message-field";message.textContent="Enter new phone contact without country code";message.id="helper-message";container.appendChild(input);container.appendChild(message);container.appendChild(createButton);document.querySelector("#data-list--container").appendChild(container);var getNumber=new mdc.ripple.MDCRipple.attachTo(document.getElementById("new-contact"))}function newNumberReq(data,formattedNumber){document.querySelector("header").appendChild(progressBar());requestCreator("share",{activityId:data.record.activityId,share:[formattedNumber]})}function numberNotExist(number){return new Promise(function(resolve){var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var store=db.transaction("users").objectStore("users");store.get(number).onsuccess=function(event){var record=event.target.result;if(record){resolve(true)}else{resolve(false)}}}})}function resetSelectedContacts(){return new Promise(function(resolve){var selectedUsers=[];var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var objectStoreTx=db.transaction(["users"],"readwrite");var objectStore=objectStoreTx.objectStore("users");objectStore.openCursor().onsuccess=function(event){var cursor=event.target.result;if(!cursor){resolve(selectedUsers);return}if(cursor.value.isSelected){selectedUsers.push(cursor.value.mobile);cursor.value.isSelected=false;objectStore.put(cursor.value)}cursor.continue()}}})}function getLocationForMapSelector(tx,data){return new Promise(function(resolve,reject){var count=0;var ul=document.getElementById("data-list--container");var store=tx.objectStore("map");var office=data.record.office;var range=IDBKeyRange.bound([office,""],[office,"￿"]);store.index("byOffice").openCursor(range,"nextunique").onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;if(cursor.value.office!==data.record.office){cursor.continue();return}if(cursor.value.location){count++;ul.appendChild(createVenueLi(cursor.value,false,data.record,true))}cursor.continue()};tx.oncomplete=function(){resolve(count)};tx.onerror=function(){reject(tx.error)}})}function checkMapStoreForNearByLocation(office,currentLocation){return new Promise(function(resolve,reject){var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var results=[];var db=req.result;var tx=db.transaction(["map"]);var store=tx.objectStore("map");var index=store.index("byOffice");var range=IDBKeyRange.bound([office,""],[office,"￿"]);index.openCursor(range).onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;if(!cursor.value.location){cursor.continue();return}if(!cursor.value.latitude||!cursor.value.longitude){cursor.continue();return}var distanceBetweenBoth=calculateDistanceBetweenTwoPoints(cursor.value,currentLocation);if(isLocationLessThanThreshold(distanceBetweenBoth)){results.push(cursor.value)}cursor.continue()};tx.oncomplete=function(){var filter={};results.forEach(function(value){filter[value.location]=value});var array=[];Object.keys(filter).forEach(function(locationName){array.push(filter[locationName])});resolve(array)};tx.onerror=function(){reject(tx.error)}}})}function createSeachInput(id,labelText){var search=document.createElement("div");search.id=id;search.className="mdc-text-field mdc-text-field--with-leading-icon search-field";var icon=document.createElement("i");icon.className="material-icons mdc-text-field__icon";icon.textContent="search";var input=document.createElement("input");input.className="mdc-text-field__input";var ripple=document.createElement("div");ripple.className="mdc-line-ripple";var label=document.createElement("label");label.className="mdc-floating-label";label.textContent=labelText;search.appendChild(icon);search.appendChild(input);search.appendChild(ripple);search.appendChild(label);return search}function handleClickListnersForMap(data,count){document.querySelector("#selector-submit-send").onclick=function(){if(!count){updateCreateActivity(data.record,true);return}var selected=document.querySelector(".mdc-radio.radio-selected");if(!selected){document.getElementById("selector-warning").textContent="* Please Choose A Location";return}var radio=new mdc.radio.MDCRadio(selected);var selectedField=JSON.parse(radio.value);updateDomFromIDB(data.record,{hash:"venue",key:data.key},{primary:selectedField.location,secondary:{address:selectedField.address,geopoint:selectedField.geopoint}}).then(function(activity){updateCreateActivity(activity,true)}).catch(function(error){console.log(error)})}}function fillChildrenInSelector(selectorStore,data,tx){var ul=document.getElementById("data-list--container");var bound=IDBKeyRange.bound([data.attachment.template,"CONFIRMED"],[data.attachment.template,"PENDING"]);var count=0;selectorStore.openCursor(bound).onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;if(data.attachment.office!==cursor.value.office){cursor.continue();return}if(cursor.value.attachment.Name){count++;ul.appendChild(createSimpleLi("children",cursor.value.attachment.Name.value))}if(cursor.value.attachment.Number){count++;ul.appendChild(createSimpleLi("children",cursor.value.attachment.Number.value))}cursor.continue()};tx.oncomplete=function(){var btn=document.getElementById("selector-submit-send");if(!count){ul.appendChild(noSelectorResult("No Values Found"));btn.textContent="CANCEL";btn.onclick=function(){updateCreateActivity(data.record,true)};return}document.getElementById("selector-submit-send").onclick=function(){var selector=document.querySelector(".mdc-radio.radio-selected");if(!selector){document.getElementById("selector-warning").textContent="* Please Select a Value";return}var radio=new mdc.radio.MDCRadio(selector);var selectedField=JSON.parse(radio.value);updateDomFromIDB(data.record,{hash:"children",key:data.attachment.key},{primary:selectedField.name}).then(function(activity){updateCreateActivity(activity,true)}).catch(function(error){console.log(error)})}}}function fillSubscriptionInSelector(db,data){var mainUL=document.getElementById("data-list--container");var grp=document.createElement("div");grp.className="mdc-list-group";var offices=[];var tx=db.transaction(["subscriptions"]);var store=tx.objectStore("subscriptions");var officeIndex=store.index("office");officeIndex.openCursor(null,"nextunique").onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;var headline3=document.createElement("h3");headline3.className="mdc-list-group__subheader subheader--group-small";headline3.textContent=cursor.value.office;headline3.dataset.groupOffice=cursor.value.office;var ul=document.createElement("ul");ul.className="mdc-list";ul.dataset.selection=cursor.value.office;ul.setAttribute("aria-orientation","vertical");offices.push(cursor.value.office);grp.appendChild(headline3);grp.appendChild(ul);cursor.continue()};tx.oncomplete=function(){if(data.suggestCheckIn){var parent=document.getElementById("data-list--container");var suggestion=document.createElement("div");suggestion.className="suggest-checkin--view";var icon=document.createElement("span");icon.className="material-icons suggestion-icon";icon.textContent="add_alert";suggestion.appendChild(icon);var text=document.createElement("span");text.textContent="Check-In ?";text.className="suggest-checkin--text";suggestion.appendChild(icon);suggestion.appendChild(text);parent.insertBefore(suggestion,parent.childNodes[0])}insertTemplateByOffice(offices,data.suggestCheckIn);mainUL.appendChild(grp);document.getElementById("selector-submit-send").onclick=function(){if(isLocationStatusWorking()){if(document.querySelector(".mdc-radio.radio-selected")){document.getElementById("selector-warning").textContent="";var radio=new mdc.radio.MDCRadio(document.querySelector(".mdc-radio.radio-selected"));var selectedField=JSON.parse(radio.value);document.getElementById("app-current-panel").dataset.view="create";createTempRecord(selectedField.office,selectedField.template,data)}else{document.getElementById("selector-warning").textContent="Please Select a Template"}}}}}function insertTemplateByOffice(offices,showCheckInFirst){var req=indexedDB.open(firebase.auth().currentUser.uid);var frag=document.createDocumentFragment();var checkInTemplate=[];req.onsuccess=function(){var db=req.result;var tx=db.transaction(["subscriptions"],"readonly");var subscriptionObjectStore=tx.objectStore("subscriptions").index("office");subscriptionObjectStore.openCursor().onsuccess=function(event){var cursor=event.target.result;if(!cursor){return}if(cursor.value.status==="CANCELLED"){cursor.continue();return}if(document.querySelector('[data-selection="'+cursor.value.office+'"] [data-template="'+cursor.value.template+'"]')){cursor.continue();return}if(showCheckInFirst&&cursor.value.template==="check-in"){checkInTemplate.push(_defineProperty({},cursor.value.office,createGroupList(cursor.value.office,cursor.value.template)));cursor.continue();return}document.querySelector('[data-selection="'+cursor.value.office+'"]').appendChild(createGroupList(cursor.value.office,cursor.value.template));cursor.continue()};tx.oncomplete=function(){checkInTemplate.forEach(function(li){var keys=Object.keys(li);keys.forEach(function(key){var el=document.querySelector('[data-selection="'+key+'"]');el.insertBefore(li[key],el.childNodes[0])})});document.querySelector(".selector-send").classList.remove("hidden")}}}function createTempRecord(office,template,data){var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var tx=db.transaction(["subscriptions"]);var subscription=tx.objectStore("subscriptions");var officeTemplateCombo=subscription.index("officeTemplate");var range=IDBKeyRange.only([office,template]);officeTemplateCombo.get(range).onsuccess=function(event){var selectedCombo=event.target.result;if(!selectedCombo){return}var bareBonesScheduleArray=[];selectedCombo.schedule.forEach(function(schedule){var bareBonesSchedule={};bareBonesSchedule.name=schedule;bareBonesSchedule.startTime="";bareBonesSchedule.endTime="";bareBonesScheduleArray.push(bareBonesSchedule)});var bareBonesRecord={office:selectedCombo.office,template:selectedCombo.template,venue:"",schedule:bareBonesScheduleArray,attachment:selectedCombo.attachment,timestamp:Date.now(),canEdit:true,assignees:[],activityName:selectedCombo.template.toUpperCase(),create:true};var bareBonesVenueArray=[];if(template==="check-in"){getRootRecord().then(function(record){var bareBonesVenue={};bareBonesVenue.venueDescriptor=selectedCombo.venue[0];bareBonesVenue.location="";bareBonesVenue.address="";bareBonesVenue.geopoint={_latitude:"",_longitude:""};bareBonesRecord.venue=[bareBonesVenue];var isLocationOld=isLastLocationOlderThanThreshold(record.location.lastLocationTime,5);if(!record.location||isLocationOld){var message="Fetching Location Please wait. ";if(native.getName()==="Android"){message=message+" Make Sure you have set Location Mode to High Accuracy"}appDialog(message,false);manageLocation().then(function(location){if(location.latitude&&location.longitude){updateLocationInRoot(location);if(document.querySelector("#enable-gps")){document.querySelector("#enable-gps").remove()}updateCreateActivity(bareBonesRecord)}}).catch(function(error){if(document.querySelector("#enable-gps")){document.querySelector("#enable-gps").remove()}var errorMessage="There was a problem in detecting your location";if(native.getName()==="Android"){errorMessage=errorMessage+". Make sure you have set Location Mode to high accuracy"}appDialog(errorMessage,false);setTimeout(function(){if(document.querySelector("#enable-gps")){document.querySelector("#enable-gps").remove()}},5e3);listView();handleError(error)});return}updateCreateActivity(bareBonesRecord)});return}selectedCombo.venue.forEach(function(venue){var bareBonesVenue={};bareBonesVenue.venueDescriptor=venue;bareBonesVenue.location="";bareBonesVenue.address="";bareBonesVenue.geopoint={_latitude:"",_longitude:""};bareBonesVenueArray.push(bareBonesVenue)});bareBonesRecord.venue=bareBonesVenueArray;updateCreateActivity(bareBonesRecord)}}}function hasAnyValueInChildren(office,template,status){var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);return new Promise(function(resolve){req.onsuccess=function(){var db=req.result;var childrenStore=db.transaction("children").objectStore("children");var count=0;var result=false;childrenStore.openCursor().onsuccess=function(event){var cursor=event.target.result;if(!cursor){if(count===0){result=false;resolve(result)}else{result=true;resolve(result)}return}if(cursor.value.template===template&&cursor.value.office===office&&status!="CANCELLED"){count++}cursor.continue()}}})}function updateDomFromIDB(activityRecord,attr,data){return new Promise(function(resolve,reject){var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var thisActivity=activityRecord;if(attr.hash==="venue"){thisActivity=updateVenue(thisActivity,attr,data);updateLocalRecord(thisActivity,db).then(function(message){resolve(thisActivity)}).catch(function(error){console.log(error);reject(error)});return}if(attr.hash==="addOnlyAssignees"){if(!data.primary.length)return;data.primary.forEach(function(number){if(thisActivity.assignees.indexOf(number)>-1)return;thisActivity.assignees.push(number)});resolve(thisActivity);return}if(attr.hash==="weekday")return;if(!attr.hasOwnProperty("key"))return;thisActivity.attachment[attr.key].value=data.primary;updateLocalRecord(thisActivity,db).then(function(message){resolve(thisActivity)}).catch(function(error){reject(error)})}})}function updateLocalRecord(thisActivity,db){return new Promise(function(resolve,reject){var tx=db.transaction(["activity"],"readwrite");var store=tx.objectStore("activity");var updatedActivity=thisActivity;if(!updatedActivity.hasOwnProperty("create")){store.put(updatedActivity)}tx.oncomplete=function(){resolve("activity object store updated with value")};tx.onerror=function(){reject({message:tx.error.message+" from updateLocalRecord"})}})}function changeTextContentForNewSelectedVenue(attr,data){var el=document.getElementById(convertKeyToId(attr.key));if(!el)return;var primaryText=el.querySelector("[data-primary]");var secondaryText=el.querySelector("[data-secondary]");var sendActivity=document.getElementById("send-activity");if(data.primary){if(primaryText){primaryText.textContent=data.primary}}if(data.hasOwnProperty("secondary")){if(secondaryText){secondaryText.textContent=data.secondary.address}}if(sendActivity){if(!sendActivity.dataset.progress){sendActivity.classList.remove("hidden")}}}function updateVenue(updatedActivity,attr,data){updatedActivity.venue.forEach(function(field){if(field.venueDescriptor===attr.key){field.location=data.primary;field.address=data.secondary.address;field.geopoint["_latitude"]=data.secondary.geopoint["_latitude"];field.geopoint["_longitude"]=data.secondary.geopoint["_longitude"]}});return updatedActivity}function convertKeyToId(key){var str=key.replace(/-/g,"--");return str.replace(/\s/g,"-")}function convertIdToKey(id){var str=id.replace(/-/g," ");return str.replace("  ","-")}function updateCreateContainer(recordCopy,db,showSendButton){var record=JSON.parse(recordCopy);document.body.style.backgroundColor="#eeeeee";var leftHeaderContent=document.createElement("div");leftHeaderContent.style.display="inline-flex";var backSpan=document.createElement("span");backSpan.className="material-icons";backSpan.textContent="arrow_back";backSpan.id="backToConv";var activityName=document.createElement("span");activityName.textContent=record.activityName;activityName.style.fontSize="18px";activityName.style.paddingLeft="10px";activityName.style.marginTop="6px";leftHeaderContent.appendChild(backSpan);leftHeaderContent.appendChild(activityName);var righHeaderContent=document.createElement("div");modifyHeader({id:"app-main-header",left:leftHeaderContent.outerHTML,right:righHeaderContent.outerHTML});document.getElementById("backToConv").addEventListener("click",function(){updateLocalRecord(record,db).then(function(){backNav()}).catch(handleError)});var container=document.createElement("div");container.className="mdc-top-app-bar--fixed-adjust update-create--activity";var TOTAL_LIST_TYPES=["office","venue","schedule","attachment","assignees"];var LIST_LENGTH=5;var i=0;for(i;i<LIST_LENGTH;i++){var containerList=document.createElement("ul");containerList.className="mdc-list custom--list-margin";var listGroup=document.createElement("div");switch(TOTAL_LIST_TYPES[i]){case"office":containerList.classList.remove("custom--list-margin");break;case"schedule":listGroup.className="mdc-list-group__subheader";listGroup.id="schedule--group";break;case"venue":case"assignees":containerList.classList.add("mdc-list--two-line","mdc-list--avatar-list");break}if(TOTAL_LIST_TYPES[i]==="schedule"){container.appendChild(listGroup)}else{containerList.id=TOTAL_LIST_TYPES[i]+"--list";container.appendChild(containerList)}}if(record.canEdit){var updateBtn=document.createElement("button");updateBtn.setAttribute("aria-label","Send");if(record.create){updateBtn.className=""}else if(!showSendButton){updateBtn.className="hidden"}updateBtn.id="send-activity";updateBtn.textContent="SUBMIT";container.appendChild(updateBtn)}return container}function updateCreateActivity(record,showSendButton){if(history.state[0]==="updateCreateActivity"){history.replaceState(["updateCreateActivity",record],null,null)}else{history.pushState(["updateCreateActivity",record],null,null)}var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var appView=document.getElementById("app-current-panel");var oldRecord=JSON.stringify(record);appView.innerHTML=updateCreateContainer(oldRecord,db,showSendButton).outerHTML;var officeSection=document.getElementById("office--list");officeSection.appendChild(createSimpleLi("Office",{office:record.office,showLabel:true}));createVenueSection(record);createScheduleTable(record);createAttachmentContainer(record);createAssigneeList(record,true,db);createActivityCancellation(record);window.scrollTo(0,0);if(document.getElementById("send-activity")){document.getElementById("send-activity").addEventListener("click",function(){if(isLocationStatusWorking()){this.dataset.progress=true;sendActivity(record)}})}var inputFields=document.querySelectorAll(".update-create--activity input");for(var i=0;i<inputFields.length;i++){inputFields[i].addEventListener("input",function(e){if(!document.getElementById("send-activity").dataset.progress){if(document.getElementById("send-activity").classList.contains("hidden")){document.getElementById("send-activity").classList.remove("hidden")}}})}if(document.querySelector(".mdc-select")){var select=new mdc.select.MDCSelect(document.querySelector(".mdc-select"));select.listen("change",function(){updateDomFromIDB(record,{hash:"weekday",key:select["root_"].dataset.value},{primary:select.value}).then(function(message){if(!document.getElementById("send-activity").dataset.progress){if(document.getElementById("send-activity").classList.contains("hidden")){document.getElementById("send-activity").classList.remove("hidden")}}}).catch(handleError)})}}}function createCheckInVenue(venue,defaultSelected){var radio=document.createElement("div");radio.className="mdc-radio checkin";radio.value=JSON.stringify(venue);var input=document.createElement("input");input.className="mdc-radio__native-control";input.type="radio";input.setAttribute("name","radios");if(defaultSelected){input.setAttribute("checked","true")}var background=document.createElement("div");background.className="mdc-radio__background";var outer=document.createElement("div");outer.className="mdc-radio__outer-circle";var inner=document.createElement("div");inner.className="mdc-radio__inner-circle";background.appendChild(outer);background.appendChild(inner);radio.appendChild(input);radio.appendChild(background);var showMap=false;return radio}function createSimpleLi(key,data){var listItem=document.createElement("li");listItem.className="mdc-list-item mdc-ripple-upgraded";var listItemLabel=document.createElement("span");listItemLabel.className="detail--static-text";var listItemMeta=document.createElement("span");var dataVal=document.createElement("span");if(key==="Office"){dataVal.className="data--value-list";dataVal.textContent=data.office;listItemLabel.textContent=key;listItem.appendChild(listItemLabel);listItem.appendChild(dataVal)}if(key==="children"){var metaInput=document.createElement("span");metaInput.className="mdc-list-item__meta";metaInput.appendChild(createRadioInput());listItem.textContent=data;listItem.appendChild(metaInput);listItem.onclick=function(){checkRadioInput(this,{name:data})}}if(key==="delete"){dataVal.className="mdc-list-item__graphic material-icons";dataVal.textContent=key;listItemLabel.classList.remove("detail--static-text");listItemLabel.classList.add("delete-activity");listItemLabel.textContent=data.text;listItem.appendChild(dataVal);listItem.appendChild(listItemLabel)}if(key==="empty"){listItem.dataset.prop="delete"}if(key==="undo-deleted"){dataVal.className="mdc-list-item__graphic material-icons";dataVal.textContent="delete";listItemLabel.classList.remove("detail--static-text");listItemLabel.classList.add("delete-activity");listItemLabel.textContent=data.text;listItem.appendChild(dataVal);listItem.appendChild(listItemLabel);listItem.classList.add("undo-delete-activity");var undo=document.createElement("button");undo.className="mdc-button mdc-ripple-upgraded mdc-list-item__meta undo-deleted";undo.textContent="Undo";undo.onclick=function(){if(isLocationStatusWorking()){document.querySelector(".undo-deleted").style.display="none";listItem.appendChild(loader("undo-delete-loader"));reqForUndoDeleted(data.id)}};listItem.appendChild(undo)}return listItem}function reqForUndoDeleted(id){requestCreator("statusChange",{activityId:id,status:"PENDING"})}function createGroupList(office,template){var li=document.createElement("li");li.className="mdc-list-item transition-ease";li.dataset.template=template;var span=document.createElement("span");span.className="mdc-list-item__text";span.textContent=template.toUpperCase();var metaInput=document.createElement("span");metaInput.className="mdc-list-item__meta";metaInput.appendChild(createRadioInput());li.onclick=function(){checkRadioInput(this,{office:office,template:template})};li.appendChild(span);li.appendChild(metaInput);return li}function createVenueSection(record){var venueSection=document.getElementById("venue--list");if(record.template==="check-in"&&record.hasOwnProperty("create")){getRootRecord().then(function(rootRecord){checkMapStoreForNearByLocation(record.office,rootRecord.location).then(function(results){if(!results.length)return;var defaultSelected=false;var checkInDesc=document.createElement("li");checkInDesc.className="mdc-list-item label--text";checkInDesc.textContent=record.venue[0].venueDescriptor;checkInDesc.style.height="50px";checkInDesc.style.paddingRight="11px";var meta=document.createElement("span");meta.className="mdc-list-item__meta";var uncheck=document.createElement("label");uncheck.id="uncheck-checkin";uncheck.className="mdc-fab add--assignee-icon";var span=document.createElement("span");span.className="mdc-fab__icon material-icons";span.textContent="clear";uncheck.appendChild(span);meta.appendChild(uncheck);checkInDesc.appendChild(meta);venueSection.appendChild(checkInDesc);if(results.length==1){defaultSelected=true}results.forEach(function(result){var form=document.createElement("div");form.className="mdc-form-field check-in-form";var label=document.createElement("label");label.setAttribute("for","check-in-radio");label.textContent=result.location;form.appendChild(label);form.appendChild(createCheckInVenue(result,defaultSelected));venueSection.appendChild(form);var mapDom=document.createElement("div");mapDom.id="map-detail-check-in-create"+convertKeyToId(result.venueDescriptor);venueSection.appendChild(mapDom)});var uncheckFab=document.getElementById("uncheck-checkin");if(uncheckFab){uncheckFab.addEventListener("click",function(){document.querySelectorAll(".mdc-radio.checkin").forEach(function(el){var radio=new mdc.radio.MDCRadio(el);radio.checked=false})})}})});return}record.venue.forEach(function(venue){venueSection.appendChild(createVenueLi(venue,true,record));var mapDom=document.createElement("div");mapDom.className="map-detail "+convertKeyToId(venue.venueDescriptor);venueSection.appendChild(mapDom)});if(record.template==="check-in"){if(!record.venue[0].location||!record.venue[0].address){document.getElementById("venue--list").style.display="none"}}if(record.venue.length===0){document.getElementById("venue--list").style.display="none"}}function createVenueLi(venue,showVenueDesc,record,showMetaInput){var showMap=false;var listItem=document.createElement("li");listItem.className="mdc-list-item mdc-ripple-upgraded";listItem.id=convertKeyToId(venue.venueDescriptor);var textSpan=document.createElement("div");textSpan.className="mdc-list-item__text link--span";var primarySpan=document.createElement("span");primarySpan.className="mdc-list-item__primary-text";var selectorIcon=document.createElement("span");selectorIcon.className="mdc-list-item__meta";var addLocation=document.createElement("label");addLocation.className="mdc-fab add--assignee-icon attachment-selector-label";var locationBtnSpan=document.createElement("span");locationBtnSpan.className="mdc-fab__icon material-icons";locationBtnSpan.textContent="add_location";addLocation.appendChild(locationBtnSpan);if(showVenueDesc){var listItemLabel=document.createElement("span");listItemLabel.className="detail--static-text";listItemLabel.textContent=venue.venueDescriptor;var dataValue=document.createElement("span");dataValue.className="data--value-list";dataValue.textContent=venue.location;dataValue.dataset.primary="";primarySpan.appendChild(listItemLabel);primarySpan.appendChild(dataValue);textSpan.appendChild(primarySpan);textSpan.onclick=function(evt){if(!hasMapsApiLoaded())return;if(!venue.geopoint["_latitude"])return;if(!venue.geopoint["_longitude"])return;showMap=!showMap;var loc={lat:venue.geopoint["_latitude"],lng:venue.geopoint["_longitude"]};maps("",showMap,convertKeyToId(venue.venueDescriptor),loc)};if(record.canEdit){selectorIcon.setAttribute("aria-hidden","true");selectorIcon.appendChild(addLocation);addLocation.onclick=function(evt){insertInputsIntoActivity(record);history.replaceState(["updateCreateActivity",record],null,null);selectorUI({record:record,store:"map",attachment:{present:false},key:venue.venueDescriptor})}}}else{primarySpan.textContent=venue.location;textSpan.appendChild(primarySpan)}var metaInput=document.createElement("span");metaInput.className="mdc-list-item__meta material-icons";if(showMetaInput){metaInput.appendChild(createRadioInput());listItem.onclick=function(){checkRadioInput(this,{location:venue.location,address:venue.address,geopoint:{_latitude:venue.latitude,_longitude:venue.longitude},venueDesc:venue.venueDescriptor})}}var secondaryText=document.createElement("span");secondaryText.className="mdc-list-item__secondary-text";secondaryText.textContent=venue.address;secondaryText.dataset.secondary="";textSpan.appendChild(secondaryText);listItem.appendChild(textSpan);if(showMetaInput){listItem.appendChild(metaInput)}else{listItem.appendChild(selectorIcon)}return listItem}function createScheduleTable(data){if(!data.schedule.length){document.getElementById("schedule--group").style.display="none"}var count=0;data.schedule.forEach(function(schedule){count++;var scheduleName=document.createElement("h5");scheduleName.className="mdc-list-group__subheader label--text";scheduleName.textContent=schedule.name;var ul=document.createElement("ul");ul.className="mdc-list mdc-list--dense";var divider=document.createElement("li");divider.className="mdc-list-divider";divider.setAttribute("role","separator");var startLi=document.createElement("li");startLi.className="mdc-list-item schedule-start-li";var sdDiv=document.createElement("div");sdDiv.className="mdc-text-field start--date"+count;var startDateInput=document.createElement("input");startDateInput.value=moment(schedule.startTime||new Date).format("YYYY-MM-DD");startDateInput.type="date";startDateInput.disabled=!data.canEdit;startDateInput.className="mdc-text-field__input";sdDiv.appendChild(startDateInput);var stSpan=document.createElement("span");stSpan.className="mdc-list-item__meta";var stDiv=document.createElement("div");stDiv.className="mdc-text-field start--time"+count;var startTimeInput=document.createElement("input");startTimeInput.value=moment(schedule.startTime||new Date).format("HH:mm");startTimeInput.type="time";startTimeInput.className="time--input";startTimeInput.disabled=!data.canEdit;startTimeInput.className="mdc-text-field__input";stDiv.appendChild(startTimeInput);stSpan.appendChild(stDiv);var endLi=document.createElement("li");endLi.className="mdc-list-item schedule-end-li";var edDiv=document.createElement("div");edDiv.className="mdc-text-field end--date"+count;var endDateInput=document.createElement("input");endDateInput.value=moment(schedule.endTime||new Date).format("YYYY-MM-DD");endDateInput.type="date";endDateInput.disabled=!data.canEdit;endDateInput.className="mdc-text-field__input";edDiv.appendChild(endDateInput);var etSpan=document.createElement("span");etSpan.className="mdc-list-item__meta";var etDiv=document.createElement("div");etDiv.className="mdc-text-field end--time"+count;var endTimeInput=document.createElement("input");endTimeInput.value=moment(schedule.endTime||new Date).format("HH:mm");endTimeInput.type="time";endTimeInput.disabled=!data.canEdit;endTimeInput.className="mdc-text-field__input";etDiv.appendChild(endTimeInput);etSpan.appendChild(etDiv);startLi.appendChild(sdDiv);startLi.appendChild(stSpan);endLi.appendChild(edDiv);endLi.appendChild(etSpan);ul.appendChild(startLi);ul.appendChild(divider);ul.appendChild(endLi);document.getElementById("schedule--group").appendChild(scheduleName);document.getElementById("schedule--group").appendChild(ul)})}function createAttachmentContainer(data){var ordering=["Name","Number","Template","email","phoneNumber","HHMM","weekday","number","base64","string"];ordering.forEach(function(order){var group=document.createElement("div");group.className=order+"--group";document.getElementById("attachment--list").appendChild(group)});var availTypes={phoneNumber:"",weekday:"","HH:MM":"",string:"",base64:"",number:"",email:""};Object.keys(data.attachment).forEach(function(key){var div=document.createElement("div");data.attachment[key].type==="HH:MM"?div.className="attachment-field HHMM":div.className="attachment-field "+data.attachment[key].type;div.id=convertKeyToId(key);if(data.canEdit){div.classList.add("editable--true")}var label=document.createElement("span");label.className="label--text";label.textContent=key;if(key==="Name"||key==="Number"){div.appendChild(label);var required=true;div.appendChild(createSimpleInput(data.attachment[key].value,data.canEdit,"",key,required))}else{if(data.attachment[key].type==="string"){div.appendChild(label);div.appendChild(createSimpleInput(data.attachment[key].value,data.canEdit,"",key))}}if(data.attachment[key].type==="number"){div.appendChild(label);div.appendChild(createNumberInput(data.attachment[key].value,data.canEdit))}if(data.attachment[key].type==="email"){div.appendChild(label);div.appendChild(createEmailInput(data.attachment[key].value,data.canEdit))}if(data.attachment[key].type==="phoneNumber"){div.classList.add("selector--margin");var addButton=document.createElement("label");addButton.className="mdc-fab add--assignee-icon attachment-selector-label";var span=document.createElement("span");span.className="mdc-fab__icon material-icons";span.textContent="person_add";addButton.appendChild(span);var dataVal=document.createElement("span");dataVal.className="data--value-list";dataVal.dataset.primary="";if(data.canEdit){div.appendChild(addButton);addButton.onclick=function(evt){insertInputsIntoActivity(data);history.replaceState(["updateCreateActivity",data],null,null);selectorUI({record:data,store:"users",attachment:{present:true,key:key}})}}div.appendChild(label);dataVal.textContent=data.attachment[key].value;div.appendChild(dataVal)}if(data.attachment[key].type=="HH:MM"){div.appendChild(label);div.appendChild(createTimeInput(data.attachment[key].value,data.canEdit,{simple:false,type:"time"}))}if(data.attachment[key].type==="weekday"){div.appendChild(label);div.appendChild(createSelectMenu(key,data.attachment[key].value,data.canEdit))}if(data.attachment[key].type==="base64"){var addCamera=document.createElement("label");addCamera.className="mdc-fab attachment-selector-label add--assignee-icon";addCamera.id="start-camera";var _span=document.createElement("span");_span.className="mdc-fab__icon material-icons";_span.textContent="add_a_photo";addCamera.appendChild(_span);var imagePreview=document.createElement("ul");imagePreview.className="image-preview--attachment mdc-image-list standard-image-list mdc-image-list--with-text-protection";imagePreview.appendChild(setFilePath(data.attachment[key].value,key,true));div.appendChild(imagePreview);if(data.canEdit){div.appendChild(addCamera);div.appendChild(imagePreview);addCamera.onclick=function(){readCameraFile()}}}if(!availTypes.hasOwnProperty(data.attachment[key].type)){var addButtonName=document.createElement("label");addButtonName.className="mdc-fab add--assignee-icon attachment-selector-label";var spanName=document.createElement("span");spanName.className="mdc-fab__icon material-icons";spanName.textContent="add";addButtonName.appendChild(spanName);div.appendChild(label);var valueField=document.createElement("span");valueField.textContent=data.attachment[key].value;valueField.className="data--value-list";div.appendChild(valueField);if(data.canEdit){hasAnyValueInChildren(data.office,data.attachment[key].type,data.status).then(function(hasValue){if(hasValue){div.appendChild(addButtonName);div.classList.add("selector--margin");addButtonName.onclick=function(evt){valueField.dataset.primary="";insertInputsIntoActivity(data);history.replaceState(["updateCreateActivity",data],null,null);selectorUI({record:data,store:"children",attachment:{present:true,key:key,office:data.office,template:data.attachment[key].type,status:data.status}})}}})}}var hr=document.createElement("hr");hr.className="attachment--divider";if(data.attachment[key].type==="HH:MM"){document.querySelector(".HHMM--group").appendChild(div);document.querySelector(".HHMM--group").appendChild(hr)}else if(key==="Name"){document.querySelector(".Name--group").appendChild(div);document.querySelector(".Name--group").appendChild(hr)}else if(!availTypes.hasOwnProperty(data.attachment[key].type)){document.querySelector(".Template--group").appendChild(div);document.querySelector(".Template--group").appendChild(hr)}else{document.querySelector("."+data.attachment[key].type+"--group").appendChild(div);document.querySelector("."+data.attachment[key].type+"--group").appendChild(hr)}})}function createAssigneeList(record,showLabel,db){var parent=document.getElementById("assignees--list");if(showLabel){var labelAdd=document.createElement("li");labelAdd.className="mdc-list-item label--text add--assignee-loader";labelAdd.textContent="Assignees";var labelButton=document.createElement("span");labelButton.className="mdc-list-item__meta";var addButton=document.createElement("div");addButton.className="mdc-fab add--assignee-icon";addButton.onclick=function(evt){insertInputsIntoActivity(record);history.replaceState(["updateCreateActivity",record],null,null);selectorUI({record:record,store:"users",attachment:{present:false}})};var span=document.createElement("span");span.className="mdc-fab__icon material-icons";span.textContent="person_add";addButton.appendChild(span);labelButton.appendChild(addButton);if(record.canEdit){labelAdd.appendChild(labelButton)}parent.appendChild(labelAdd)}record.assignees.forEach(function(number){getUserRecord(db,number).then(function(record){parent.appendChild(createSimpleAssigneeLi(record))})})}function createSimpleAssigneeLi(userRecord,showMetaInput,isCheckbox){var assigneeLi=document.createElement("li");assigneeLi.classList.add("mdc-list-item","assignee-li");if(!userRecord)return assigneeLi;assigneeLi.dataset.value=userRecord.mobile;var dataObject=document.createElement("object");dataObject.data=userRecord.photoURL||"./img/empty-user.jpg";dataObject.type="image/jpeg";dataObject.className="mdc-list-item__graphic";var photoGraphic=document.createElement("img");photoGraphic.src="./img/empty-user.jpg";photoGraphic.className="empty-user-assignee";dataObject.appendChild(photoGraphic);var assigneeListText=document.createElement("span");assigneeListText.classList.add("mdc-list-item__text");var assigneeName=document.createElement("span");assigneeName.className="mdc-list-item__primary-text";var assigneeListTextSecondary=document.createElement("span");assigneeListTextSecondary.classList.add("mdc-list-item__secondary-text");if(!userRecord.displayName){assigneeName.textContent=userRecord.mobile}else{assigneeName.textContent=userRecord.displayName;assigneeListTextSecondary.textContent=userRecord.mobile}assigneeListText.appendChild(assigneeName);assigneeListText.appendChild(assigneeListTextSecondary);var metaInput=document.createElement("span");metaInput.className="mdc-list-item__meta material-icons";if(showMetaInput){if(isCheckbox){metaInput.appendChild(createCheckBox(userRecord))}else{metaInput.appendChild(createRadioInput());assigneeLi.onclick=function(){checkRadioInput(this,assigneeLi.dataset.value)}}}assigneeLi.appendChild(dataObject);assigneeLi.appendChild(assigneeListText);assigneeLi.appendChild(metaInput);return assigneeLi}function createRadioInput(){var div=document.createElement("div");div.className="mdc-radio radio-control-selector";var input=document.createElement("input");input.className="mdc-radio__native-control";input.type="radio";input.name="radio";var radioBckg=document.createElement("div");radioBckg.className="mdc-radio__background";var outerRadio=document.createElement("div");outerRadio.className="mdc-radio__outer-circle";var innerRadio=document.createElement("div");innerRadio.className="mdc-radio__inner-circle";radioBckg.appendChild(outerRadio);radioBckg.appendChild(innerRadio);div.appendChild(input);div.appendChild(radioBckg);return div}function createCheckBox(userRecord){var checkbox=document.createElement("div");checkbox.className="mdc-checkbox status-check";checkbox.dataset.selected=userRecord.isSelected;var input=document.createElement("input");input.className="mdc-checkbox__native-control";input.type="checkbox";input.onclick=function(evt){checkCheckboxInput(evt,userRecord)};var checkbox_bckg=document.createElement("div");checkbox_bckg.className="mdc-checkbox__background";var svg='<svg class="mdc-checkbox__checkmark"\n    viewBox="0 0 24 24">\n    <path class="mdc-checkbox__checkmark-path"\n    fill="none"\n    d="M1.73,12.91 8.1,19.28 22.79,4.59"/>\n    </svg>\n    <div class="mdc-checkbox__mixedmark"></div>';var mixedmark=document.createElement("div");mixedmark.className="mdc-checkbox__mixedmark";checkbox_bckg.innerHTML=svg;checkbox.appendChild(input);checkbox.appendChild(checkbox_bckg);return checkbox}function checkCheckboxInput(evt,record){var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var objectStore=db.transaction("users","readwrite").objectStore("users");if(record.hasOwnProperty("isSelected")&&record.isSelected){evt.target.parentNode.dataset.selected=false;record.isSelected=false}else{evt.target.parentNode.dataset.selected=true;record.isSelected=true}objectStore.put(record);if(document.querySelectorAll('[data-selected="true"]').length){document.querySelector(".selector-send").dataset.type="";document.querySelector(".selector-send").textContent="SELECT"}}}function checkRadioInput(inherit,value){document.getElementById("selector-submit-send").textContent="SELECT";[].concat(_toConsumableArray(document.querySelectorAll(".radio-selected"))).forEach(function(input){input.classList.remove("radio-selected")});var parent=inherit;if(parent){var radio=new mdc.radio.MDCRadio(parent.querySelector(".radio-control-selector"));radio["root_"].classList.add("radio-selected");document.getElementById("selector-submit-send").dataset.type="";radio.value=JSON.stringify(value)}}function setFilePath(str,key,show){if(document.querySelector(".image--list-li")){document.getElementById("attachment-picture").data="data:image/jpg;base64,"+str;document.getElementById("attachment-picture").dataset.value="data:image/jpg;base64,"+str;if(!document.getElementById("send-activity").dataset.progress){document.getElementById("send-activity").classList.remove("hidden")}return}var li=document.createElement("li");li.className="mdc-image-list__item image--list-li";var container=document.createElement("div");var dataObject=document.createElement("object");dataObject.data=str||"./img/placeholder.png";dataObject.type="image/jpeg";dataObject.id="attachment-picture";dataObject.dataset.photoKey=key;dataObject.className="profile-container--main mdc-image-list__image";var img=document.createElement("img");img.src="./img/placeholder.png";img.className="profile-container--main mdc-image-list__image";if(!str){dataObject.data="./img/placeholder.png";dataObject.dataset.value=""}else{dataObject.src=str;dataObject.dataset.value=str}dataObject.appendChild(img);dataObject.onclick=function(){openImage(this.data)};container.appendChild(dataObject);li.appendChild(container);var textCont=document.createElement("div");textCont.className="mdc-image-list__supporting";var span=document.createElement("span");span.textContent=key;span.className="mdc-image-list__label";span.id="label--image";textCont.appendChild(span);li.appendChild(textCont);if(show)return li}function readCameraFile(){if(native.getName()==="Android"){try{AndroidInterface.startCamera()}catch(e){handleError({message:e.message+" from startCamera"})}}else{webkit.messageHandlers.takeImageForAttachment.postMessage("convert image to base 64")}}function openImage(imageSrc){if(!imageSrc)return;document.getElementById("viewImage--dialog-component").querySelector("img").src=imageSrc;var imageDialog=new mdc.dialog.MDCDialog.attachTo(document.querySelector("#viewImage--dialog-component"));imageDialog.show()}function createActivityCancellation(record){if(!record.canEdit)return;var StautsCont=document.createElement("div");StautsCont.className="status--cancel-cont";if(record.hasOwnProperty("create"))return;if(record.status==="CANCELLED"){StautsCont.appendChild(createSimpleLi("undo-deleted",{text:"Cancelled",id:record.activityId}));document.querySelector(".update-create--activity").appendChild(StautsCont);var undo=new mdc.ripple.MDCRipple.attachTo(document.querySelector(".undo-deleted"));return}if(record.status!=="CANCELLED"){StautsCont.appendChild(createSimpleLi("delete",{text:"CANCEL"}));document.querySelector(".update-create--activity").appendChild(StautsCont);if(!record.canEdit)return;if(!document.getElementById("cancel-alert")){cancelAlertDialog()}var dialog=new mdc.dialog.MDCDialog(document.querySelector("#cancel-alert"));document.getElementById("delete-allow").onclick=function(){if(isLocationStatusWorking()){deleteActivityReq(record.activityId)}};dialog.listen("MDCDialog:cancel",function(){});document.querySelector(".delete-activity").addEventListener("click",function(evt){dialog.lastFocusedTarget=evt.target;dialog.show()})}}function deleteActivityReq(id){document.querySelector(".delete-activity").style.display="none";document.querySelector(".status--cancel-cont li").appendChild(loader("cancel-loader"));requestCreator("statusChange",{activityId:id,status:"CANCELLED"})}function cancelAlertDialog(){var aside=document.createElement("aside");aside.className="mdc-dialog";aside.id="cancel-alert";var surface=document.createElement("div");surface.className="mdc-dialog__surface";var section=document.createElement("section");section.className="mdc-dialog__body";section.textContent="Are you sure you want to delete this activity ? ";var footer=document.createElement("footer");footer.className="mdc-dialog__footer";var accept=document.createElement("button");accept.type="button";accept.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept delete-btn";accept.textContent="Delete";accept.id="delete-allow";var cancel=document.createElement("button");cancel.type="button";cancel.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel cancel-delete-btn";cancel.textContent="Cancel";footer.appendChild(cancel);footer.appendChild(accept);surface.appendChild(section);surface.appendChild(footer);aside.appendChild(surface);var backdrop=document.createElement("div");backdrop.className="mdc-dialog__backdrop";aside.appendChild(backdrop);document.body.appendChild(aside)}function sendActivity(record){if(record.hasOwnProperty("create")){insertInputsIntoActivity(record,true);return}var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(event){var db=req.result;var activityStore=db.transaction("activity","readwrite").objectStore("activity");activityStore.get(record.activityId).onsuccess=function(event){var record=event.target.result;insertInputsIntoActivity(record,true)}}}function concatDateWithTime(date,time){var dateConcat=moment(date+" "+time);return moment(dateConcat).valueOf()}function insertInputsIntoActivity(record,send){var allStringTypes=document.querySelectorAll(".string");for(var i=0;i<allStringTypes.length;i++){var inputValue=allStringTypes[i].querySelector(".mdc-text-field__input").value;if(allStringTypes[i].querySelector(".mdc-text-field__input").required&&checkSpacesInString(inputValue)){if(send){snacks("Please provide an input for the field “Name” ")}return}record.attachment[convertIdToKey(allStringTypes[i].id)].value=inputValue}var allNumberTypes=document.querySelectorAll(".number");for(var i=0;i<allNumberTypes.length;i++){var _inputValue=Number(allNumberTypes[i].querySelector(".mdc-text-field__input").value);record.attachment[convertIdToKey(allNumberTypes[i].id)].value=_inputValue}var allEmailTypes=document.querySelectorAll(".email");for(var i=0;i<allEmailTypes.length;i++){var _inputValue2=allEmailTypes[i].querySelector(".mdc-text-field__input").value;record.attachment[convertIdToKey(allEmailTypes[i].id)].value=_inputValue2}var allTimeTypes=document.querySelectorAll(".HHMM");for(var i=0;i<allTimeTypes.length;i++){var _inputValue3=allTimeTypes[i].querySelector(".mdc-text-field__input").value;record.attachment[convertIdToKey(allTimeTypes[i].id)].value=_inputValue3}var imagesInAttachments=document.querySelectorAll(".image-preview--attachment  object");for(var _i=0;_i<imagesInAttachments.length;_i++){record.attachment[convertKeyToId(imagesInAttachments[_i].dataset.photoKey)].value=imagesInAttachments[_i].dataset.value}var sd=void 0;var st=void 0;var ed=void 0;var et=void 0;for(var i=1;i<record.schedule.length+1;i++){sd=getInputText(".start--date"+i).value;st=getInputText(".start--time"+i).value;ed=getInputText(".end--date"+i).value;et=getInputText(".end--time"+i).value;if(!concatDateWithTime(sd,st)&&!concatDateWithTime(ed,et)){snacks("Please Select A Start Date and End Date");return}if(sd===""){snacks("Please Select a Start Date");return}if(ed===""){snacks("Please Select an End Date");return}if(concatDateWithTime(ed,et)<concatDateWithTime(sd,st)){snacks("The End Date and Time should be greater or equal to the start time");return}record.schedule[i-1].startTime=concatDateWithTime(sd,st)||"";record.schedule[i-1].endTime=concatDateWithTime(ed,et)||""}if(record.template==="check-in"){document.querySelectorAll(".mdc-radio.checkin").forEach(function(el){var radio=new mdc.radio.MDCRadio(el);if(radio.checked){var venueData=JSON.parse(el.value);record.venue[0].geopoint={latitude:venueData.latitude,longitude:venueData.longitude};record.venue[0].location=venueData.location;record.venue[0].address=venueData.address}});if(!record.venue[0].location||!record.venue[0].address){record.venue[0].geopoint={latitude:"",longitude:""}}}else{for(var i=0;i<record.venue.length;i++){record.venue[i].geopoint={latitude:record.venue[i].geopoint["_latitude"]||"",longitude:record.venue[i].geopoint["_longitude"]||""};if(record.venue[i].hasOwnProperty("showIcon")){delete record.venue[i].showIcon}}}var requiredObject={venue:record.venue,schedule:record.schedule,attachment:record.attachment};if(send){sendUpdateReq(requiredObject,record)}}function sendUpdateReq(requiredObject,record){if(!record.hasOwnProperty("create")){requiredObject.activityId=record.activityId;document.querySelector("header").appendChild(progressBar());document.querySelector("#send-activity").classList.add("hidden");requestCreator("update",requiredObject);return}requiredObject.office=record.office;requiredObject.template=record.template;requiredObject.share=record.assignees;document.querySelector("header").appendChild(progressBar());document.querySelector("#send-activity").classList.add("hidden");requestCreator("create",requiredObject)}function checkSpacesInString(input){if(!input.replace(/\s/g,"").length)return true;return false}function initializeAutocompleteGoogle(autocomplete,attr){autocomplete.addListener("place_changed",function(){var place=autocomplete.getPlace();if(!place.geometry){snacks("Please select a valid location");return}var address="";if(place.address_components){address=[place.address_components[0]&&place.address_components[0].short_name||"",place.address_components[1]&&place.address_components[1].short_name||"",place.address_components[2]&&place.address_components[2].short_name||""].join(" ")}var selectedAreaAttributes={primary:place.name,secondary:{address:address,geopoint:{_latitude:place.geometry.location.lat(),_longitude:place.geometry.location.lng()}}};updateDomFromIDB(attr.record,{hash:"venue",key:attr.key},selectedAreaAttributes).then(function(activity){updateCreateActivity(activity,true)}).catch(handleError)})}function createSimpleInput(value,canEdit,withIcon,key,required){if(!canEdit){var onlyText=document.createElement("span");onlyText.className="data--value-list";onlyText.textContent=value;return onlyText}var textField=document.createElement("div");if(key&&key.length<15){textField.className="mdc-text-field data--value-list"}else{textField.className="mdc-text-field data--value-list-small"}var input=document.createElement("input");input.className="mdc-text-field__input input--value--update";input.style.paddingTop="0px";input.value=value;input.required=required;var ripple=document.createElement("div");ripple.className="mdc-line-ripple";if(withIcon){textField.id="search--bar--field";input.id="search--bar-selector";textField.classList.add("field-input")}textField.appendChild(input);textField.appendChild(ripple);if(textField){var jsTField=new mdc.textField.MDCTextField.attachTo(textField)}return textField}function createNumberInput(value,canEdit){if(!canEdit){var simeplText=document.createElement("span");simeplText.className="data--value-list";simeplText.textContent=value;return simeplText}var textField=document.createElement("div");textField.className="mdc-text-field data--value-list";var input=document.createElement("input");input.className="mdc-text-field__input input--type-number";input.type="number";input.style.paddingTop="0px";input.value=value;input.setAttribute("onkeypress","return event.charCode >= 48 && event.charCode <= 57");var ripple=document.createElement("div");ripple.className="mdc-line-ripple";textField.appendChild(input);textField.appendChild(ripple);return textField}function createEmailInput(value,canEdit){if(!canEdit){var simeplText=document.createElement("span");simeplText.className="data--value-list";simeplText.textContent=value;return simeplText}var textField=document.createElement("div");textField.className="mdc-text-field data--value-list";var input=document.createElement("input");input.className="mdc-text-field__input input--type-email";input.type="email";input.placeholder="johndoe@example.com";input.style.paddingTop="0px";input.value=value;var ripple=document.createElement("div");ripple.className="mdc-line-ripple";textField.appendChild(input);textField.appendChild(ripple);return textField}function createTimeInput(value,canEdit,attr){if(!canEdit){var simeplText=document.createElement("span");simeplText.className="data--value-list";attr.type==="date"?simeplText.textContent=moment(value).calendar():simeplText.textContent=value;return simeplText}var textField=document.createElement("div");textField.className="mdc-text-field";var input=document.createElement("input");input.className="mdc-text-field__input input--type-time";input.type=attr.type;input.style.borderBottom="none";attr.type==="date"?input.value=moment(value).format("YYYY-MM-DD"):input.value=value;if(attr.type==="time"){textField.classList.add("data--value-list");input.style.width="100%";input.value=value||moment(new Date).format("HH:mm")}var ripple=document.createElement("div");ripple.className="mdc-line-ripple";textField.appendChild(input);textField.appendChild(ripple);if(attr.simple){input.classList.remove("mdc-text-field__input");return input}return textField}function createSelectMenu(key,value,canEdit){if(!canEdit){var span=document.createElement("span");span.className="data--value-list";span.textContent=value;return span}var div=document.createElement("div");div.className="mdc-select data--value-list";div.style.height="32%;";div.id=convertKeyToId(key);div.dataset.value=key;div.dataset.primary="";var select=document.createElement("select");select.className="mdc-select__native-control";select.style.paddingRight="0px";var weekdays=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];for(var i=0;i<weekdays.length;i++){var option=document.createElement("option");option.value=weekdays[i];option.textContent=weekdays[i];if(value===weekdays[i]){option.setAttribute("selected","true")}select.appendChild(option)}var label=document.createElement("label");label.className="mdc-floating-label";label.textContent="";var ripple=document.createElement("div");ripple.className="mdc-line-ripple";div.appendChild(label);div.appendChild(select);div.appendChild(ripple);return div}function toggleActionables(id){if(!id)return;if(document.getElementById("app-current-panel").dataset.view==="create")return;var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var activityStore=db.transaction("activity").objectStore("activity");activityStore.get(id).onsuccess=function(event){var record=event.target.result;if(!record){listView();return}var actions=document.querySelectorAll(".mdc-fab");if(!record.editable)return;if(document.querySelector(".loader")){document.querySelector(".loader").remove();if(document.querySelector(".add--assignee-loader .add--assignee-icon")){document.querySelector(".add--assignee-loader .add--assignee-icon").style.display="block"}}if(document.querySelector(".progress--update")){document.querySelector(".progress--update").remove()}}}}var ui=void 0;var native=function(){return{setFCMToken:function setFCMToken(token){localStorage.setItem("token",token)},getFCMToken:function getFCMToken(){return localStorage.getItem("token")},setName:function setName(device){localStorage.setItem("deviceType",device)},getName:function getName(){return localStorage.getItem("deviceType")},setIosInfo:function setIosInfo(iosDeviceInfo){var splitByName=iosDeviceInfo.split("&");var deviceInfo={baseOs:splitByName[0],deviceBrand:splitByName[1],deviceModel:splitByName[2],appVersion:Number(splitByName[3]),osVersion:splitByName[4],id:splitByName[5],initConnection:splitByName[6]};localStorage.setItem("iosUUID",JSON.stringify(deviceInfo))},getIosInfo:function getIosInfo(){return localStorage.getItem("iosUUID")},getInfo:function getInfo(){if(!this.getName()){return JSON.stringify({baseOs:"mac",deviceBrand:"",deviceModel:"",appVersion:7,osVersion:"",id:"123"})}if(this.getName()==="Android"){try{return AndroidInterface.getDeviceId()}catch(e){handleError({message:e.message+" from AndroidInterface.getDeviceId"});return JSON.stringify({baseOs:this.getName(),deviceBrand:"",deviceModel:"",appVersion:6,osVersion:"",id:""})}}return this.getIosInfo()}}}();var app=function(){return{today:function today(format){if(!format)return moment();return moment().format(format)},tomorrow:function tomorrow(){return moment(this.today()).add(1,"day")},isNewDay:function isNewDay(auth){var today=localStorage.getItem("today");if(!today){localStorage.setItem("today",moment().format("YYYY-MM-DD"));return true}var isSame=moment(moment().format("YYYY-MM-DD")).isSame(moment(today));if(isSame){return false}else{localStorage.setItem("today",moment().format("YYYY-MM-DD"));return true}}}}();window.addEventListener("load",function(){var title="Device Incompatibility";var message="Your Device is Incompatible with Growthfile. Please Upgrade your Android Version";if(!window.Worker&&!window.indexedDB){try{AndroidInterface.showDialog(title,message)}catch(e){handleError({message:e.message+" from showDialog during device Incompatibility check"});appDialog(message)}return}firebase.initializeApp({apiKey:"AIzaSyA4s7gp7SFid_by1vLVZDmcKbkEcsStBAo",authDomain:"growthfile-207204.firebaseapp.com",databaseURL:"https://growthfile-207204.firebaseio.com",projectId:"growthfile-207204",storageBucket:"growthfile-207204.appspot.com",messagingSenderId:"701025551237"});moment.updateLocale("en",{calendar:{lastDay:"[yesterday]",sameDay:"hh:mm",nextDay:"[Tomorrow at] LT",lastWeek:"dddd",nextWeek:"dddd [at] LT",sameElse:"L"},longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YY"},months:["January","February","March","April","May","June","July","August","September","October","November","December"]});window.onpopstate=function(event){if(!event.state)return;if(event.state[0]==="listView"){var originalCount=scroll_namespace.count;if(originalCount){scroll_namespace.size=originalCount}scroll_namespace.count=0;window[event.state[0]]();return}window[event.state[0]](event.state[1],false)};layoutGrid();startApp(true)});function backNav(){history.back()}function firebaseUiConfig(value){return{callbacks:{signInSuccessWithAuthResult:function signInSuccessWithAuthResult(authResult){if(value){document.querySelector("#updateEmailDialog").remove();updateEmail(authResult.user,value);return false}},signInFailure:function signInFailure(error){return handleUIError(error)},uiShown:function uiShown(){}},signInFlow:"popup",signInOptions:[{provider:firebase.auth.PhoneAuthProvider.PROVIDER_ID,recaptchaParameters:{type:"image",size:"normal",badge:"bottomleft"},defaultCountry:"IN",defaultNationalNumber:value?firebase.auth().currentUser.phoneNumber:""}]}}function userSignedOut(){var login=document.createElement("div");login.id="login-container";document.body.appendChild(login);if(!ui){ui=new firebaseui.auth.AuthUI(firebase.auth())}ui.start("#login-container",firebaseUiConfig())}function layoutGrid(){var layout=document.createElement("div");layout.classList.add("mdc-layout-grid","mdc-typography","app");layout.id="main-layout-app";var layoutInner=document.createElement("div");layoutInner.className="mdc-layout-grid__inner cell-space";var headerDiv=document.createElement("div");headerDiv.id="header";var currentPanel=document.createElement("div");currentPanel.id="app-current-panel";currentPanel.className="mdc-layout-grid__cell--span-12";var snackbar=document.createElement("div");snackbar.id="snackbar-container";var alertDom=document.createElement("div");alertDom.id="alert--box";headerDiv.appendChild(createHeader("app-main-header"));layoutInner.appendChild(headerDiv);layoutInner.appendChild(currentPanel);layoutInner.appendChild(snackbar);layout.appendChild(layoutInner);layout.appendChild(alertDom);document.body.innerHTML=layout.outerHTML;imageViewDialog()}function createCheckInDialog(){var aside=document.createElement("aside");aside.className="mdc-dialog mdc-dialog--open hidden";aside.id="suggest-checkIn-dialog";aside.style.backgroundColor="rgba(0,0,0,0.47)";var surface=document.createElement("div");surface.className="mdc-dialog__surface";surface.style.width="90%";surface.style.height="auto";var header=document.createElement("header");header.className="mdc-dialog__header";var headerText=document.createElement("h2");headerText.className="mdc-dialog__header__title";headerText.textContent="Reminder";header.appendChild(headerText);var section=document.createElement("section");section.className="mdc-dialog__body";section.textContent="Check-in ?";var footer=document.createElement("footer");footer.className="mdc-dialog__footer";var ok=document.createElement("button");ok.type="button";ok.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept";ok.textContent="Okay";ok.style.backgroundColor="#3498db";var canel=document.createElement("button");canel.type="button";canel.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel";canel.textContent="Cancel";canel.style.backgroundColor="#3498db";footer.appendChild(canel);footer.appendChild(ok);surface.appendChild(header);surface.appendChild(section);surface.appendChild(footer);aside.appendChild(surface);return aside}function createHeader(id){var header=document.createElement("header");header.className="mdc-top-app-bar mdc-top-app-bar--fixed mdc-elevation--z1";header.id=id;var row=document.createElement("div");row.className="mdc-top-app-bar__row";var sectionStart=document.createElement("section");sectionStart.className="mdc-top-app-bar__section mdc-top-app-bar__section--align-start";var leftUI=document.createElement("div");leftUI.id=id+"view-type";leftUI.className="view-type";sectionStart.appendChild(leftUI);var sectionEnd=document.createElement("div");sectionEnd.className="mdc-top-app-bar__section mdc-top-app-bar__section--align-end";var rightUI=document.createElement("div");rightUI.id=id+"action-data";rightUI.className="action-data";sectionEnd.appendChild(rightUI);row.appendChild(sectionStart);row.appendChild(sectionEnd);header.appendChild(row);return header}function imageViewDialog(){var aside=document.createElement("aside");aside.id="viewImage--dialog-component";aside.className="mdc-dialog";aside.role="alertdialog";var dialogSurface=document.createElement("div");dialogSurface.className="mdc-dialog__surface";var section=document.createElement("section");section.className="mdc-dialog__content";var image=document.createElement("img");image.src="";image.style.width="100%";section.appendChild(image);dialogSurface.appendChild(section);var footer=document.createElement("footer");footer.className="mdc-dialog__footer";var cancel=document.createElement("button");cancel.type="button";cancel.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel";cancel.textContent="cancel";cancel.style.backgroundColor="#3498db";footer.appendChild(cancel);dialogSurface.appendChild(footer);aside.appendChild(dialogSurface);var backdrop=document.createElement("div");backdrop.className="mdc-dialog__backdrop";aside.appendChild(backdrop);document.body.appendChild(aside)}function startApp(start){firebase.auth().onAuthStateChanged(function(auth){if(!auth){document.getElementById("main-layout-app").style.display="none";userSignedOut();return}if(!native.getInfo()){redirect();return}if(!localStorage.getItem("error")){localStorage.setItem("error",JSON.stringify({}))}if(start){var req=indexedDB.open(auth.uid,3);var db=void 0;req.onupgradeneeded=function(evt){db=req.result;db.onerror=function(){handleError({message:db.error.message+" from createIDBStore on upgradeneeded"});return};createObjectStores(db,auth.uid)};req.onsuccess=function(){document.getElementById("main-layout-app").style.display="block";localStorage.setItem("dbexist",auth.uid);var getInstantLocation=false;if(native.getName()!=="Android"){try{webkit.messageHandlers.startLocationService.postMessage("start fetchin location")}catch(e){getInstantLocation=true;handleError({message:e.message})}}else{getInstantLocation=true}requestCreator("now",{device:native.getInfo(),from:"",registerToken:native.getFCMToken()});listView();runAppChecks();if(!getInstantLocation)return;manageLocation().then(function(location){if(location.latitude&&location.longitude){console.log(location);updateLocationInRoot(location)}}).catch(function(error){handleError(error)})};req.onerror=function(){console.log(req.error);handleError({message:req.error.message+" from createIDBStore"})}}})}function getEmployeeDetails(){return new Promise(function(resolve,reject){var auth=firebase.auth().currentUser;var req=indexedDB.open(auth.uid);req.onsuccess=function(){var db=req.result;var tx=db.transaction(["children"]);var store=tx.objectStore("children");var details=void 0;var range=IDBKeyRange.bound(["employee","CONFIRMED"],["employee","PENDING"]);store.index("templateStatus").openCursor(range).onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;if(cursor.value.attachment["Employee Contact"].value!==auth.phoneNumber){cursor.continue();return}details=cursor.value;cursor.continue()};tx.oncomplete=function(){resolve(details)};tx.onerror=function(){reject({message:tx.error.message+" from getEmployeeDetails"})}};req.onerror=function(){reject({message:req.error.message+" from getEmployeeDetails"})}})}function isEmployeeOnLeave(){return new Promise(function(resolve,reject){getEmployeeDetails().then(function(empDetails){if(!empDetails){return resolve(false)}empDetails.onLeave=false;var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var tx=db.transaction(["calendar"]);var store=tx.objectStore("calendar");var range=IDBKeyRange.bound(["leave","CONFIRMED",empDetails.office],["leave","PENDING",empDetails.office]);var onLeave=false;store.index("onLeave").openCursor(range).onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;if(moment(moment().format("YYYY-MM-DD")).isBetween(cursor.value.start,cursor.value.end,null,"[]")){onLeave=true;return}cursor.continue()};tx.oncomplete=function(){resolve(onLeave)};tx.onerror=function(){reject({message:tx.error.message+" from isEmployeeOnLeave"})}};req.onerror=function(){reject({message:req.error.message+" from isEmployeeOnLeave"})}}).catch(function(error){reject(error)})})}function createObjectStores(db,uid){var activity=db.createObjectStore("activity",{keyPath:"activityId"});activity.createIndex("timestamp","timestamp");activity.createIndex("office","office");activity.createIndex("hidden","hidden");var list=db.createObjectStore("list",{keyPath:"activityId"});list.createIndex("timestamp","timestamp");list.createIndex("status","status");var users=db.createObjectStore("users",{keyPath:"mobile"});users.createIndex("displayName","displayName");users.createIndex("isUpdated","isUpdated");users.createIndex("count","count");var addendum=db.createObjectStore("addendum",{autoIncrement:true});addendum.createIndex("activityId","activityId");var subscriptions=db.createObjectStore("subscriptions",{autoIncrement:true});subscriptions.createIndex("office","office");subscriptions.createIndex("template","template");subscriptions.createIndex("officeTemplate",["office","template"]);var calendar=db.createObjectStore("calendar",{autoIncrement:true});calendar.createIndex("activityId","activityId");calendar.createIndex("timestamp","timestamp");calendar.createIndex("start","start");calendar.createIndex("end","end");calendar.createIndex("urgent",["status","hidden"]),calendar.createIndex("onLeave",["template","status","office"]);var map=db.createObjectStore("map",{autoIncrement:true});map.createIndex("activityId","activityId");map.createIndex("location","location");map.createIndex("latitude","latitude");map.createIndex("longitude","longitude");map.createIndex("nearby",["status","hidden"]);map.createIndex("byOffice",["office","location"]);var children=db.createObjectStore("children",{keyPath:"activityId"});children.createIndex("template","template");children.createIndex("office","office");children.createIndex("templateStatus",["template","status"]);var root=db.createObjectStore("root",{keyPath:"uid"});root.put({uid:uid,fromTime:0,location:""})}function redirect(){firebase.auth().signOut().then(function(){window.location="https://www.growthfile.com"}).catch(function(error){window.location="https://www.growthfile.com";handleError({message:error+" from redirect"})})}function initLocation(){manageLocation().then(function(location){if(location.latitude&&location.longitude){updateLocationInRoot(location)}}).catch(function(error){handleError(error)})}function runAppChecks(){window.addEventListener("suggestCheckIn",function _suggestCheckIn(e){isEmployeeOnLeave().then(function(onLeave){if(onLeave)return;if(e.detail){if(history.state[0]==="listView"){try{document.getElementById("alert--box").innerHTML=createCheckInDialog().outerHTML;getRootRecord().then(function(record){if(record){if(record.offices){showSuggestCheckInDialog(record.offices);listView()}}})}catch(e){console.log(e)}}}}).catch(handleError)},true)}var scroll_namespace={count:0,size:20,skip:false};function initDomLoad(){if(document.querySelector(".init-loader")){document.querySelector(".init-loader").remove()}if(document.querySelector(".mdc-linear-progress")){document.querySelector(".mdc-linear-progress").remove()}listPanel();creatListHeader("Activities");createActivityIcon()}function listView(){history.pushState(["listView"],null,null);initDomLoad();getSizeOfListStore().then(function(size){if(!size){appendTextContentInListView("No activities Found");return}if(size>20){window.addEventListener("scroll",handleScroll,false)}getRootRecord().then(function(record){if(size&&size<=20){loadActivitiesFromListStore(record.location);return}startCursor(record.location)})})}function appendTextContentInListView(textContent){var p=document.createElement("p");p.textContent=textContent;p.className="no-activity";document.getElementById("activity-list-main").appendChild(p);document.getElementById("activity-list-main").style.boxShadow="none"}function getSizeOfListStore(){return new Promise(function(resolve,reject){var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var tx=db.transaction(["list"]);var store=tx.objectStore("list");var countReq=store.count();countReq.onsuccess=function(){resolve(countReq.result)};countReq.onerror=function(){reject(countReq.error)}};req.onerror=function(){reject(req.error)}})}function updateEl(activities,rootRecord){var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var tx=db.transaction(["list","activity"]);var activityStore=tx.objectStore("activity");var listStore=tx.objectStore("list");var ul=document.getElementById("activity--list");activities.forEach(function(activity){if(document.querySelector(".no-activity")){document.querySelector(".no-activity").remove()}listStore.get(activity.activityId).onsuccess=function(event){var record=event.target.result;var existingEl=document.querySelector('[data-id="'+activity.activityId+'"]');if(existingEl){existingEl.remove()}if(!record)return;if(!rootRecord.location){getActivityDataForList(activityStore,record).then(function(li){ul.insertBefore(li,ul.childNodes[0])})}else{getActivityDataForList(activityStore,record,rootRecord.location).then(function(li){ul.insertBefore(li,ul.childNodes[0])})}}})}}function handleScroll(ev){getRootRecord().then(function(record){if(window.innerHeight+window.scrollY===document.body.scrollHeight){var ul=document.getElementById("activity--list");if(!ul)return;startCursor(record.location)}})}function loadActivitiesFromListStore(currentLocation){var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var transaction=db.transaction(["list","activity","root"]);var activity=transaction.objectStore("activity");var store=transaction.objectStore("list");var index=store.index("timestamp");var fragment=document.createDocumentFragment();index.openCursor(null,"prev").onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;getActivityDataForList(activity,cursor.value,currentLocation).then(function(dom){fragment.appendChild(dom)});cursor.continue()};transaction.oncomplete=function(){var ul=document.getElementById("activity--list");if(!ul)return;ul.innerHTML="";ul.appendChild(fragment);scrollToActivity()}}}function startCursor(currentLocation){console.log(currentLocation);var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var transaction=db.transaction(["list","activity","root"]);var activity=transaction.objectStore("activity");var store=transaction.objectStore("list");var index=store.index("timestamp");var iterator=0;var advanceCount=scroll_namespace.count;var fragment=document.createDocumentFragment();index.openCursor(null,"prev").onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;if(advanceCount){if(!scroll_namespace.skip){scroll_namespace.skip=true;cursor.advance(advanceCount)}else{getActivityDataForList(activity,cursor.value,currentLocation).then(function(dom){fragment.appendChild(dom);iterator++});runCursor(cursor,iterator)}}else{getActivityDataForList(activity,cursor.value,currentLocation).then(function(dom){fragment.appendChild(dom);iterator++});runCursor(cursor,iterator)}};transaction.oncomplete=function(){var ul=document.getElementById("activity--list");if(!ul)return;ul.appendChild(fragment);scroll_namespace.count=scroll_namespace.count+scroll_namespace.size;scroll_namespace.skip=false;scroll_namespace.size=20;scrollToActivity()}}}function runCursor(cursor,iterator){var size=scroll_namespace.size;if(iterator<size){cursor.continue()}}function getActivityDataForList(activity,value,currentLocation){return new Promise(function(resolve,reject){var secondLineParent=document.createElement("div");secondLineParent.style.marginTop="10px";var secondLineVenue=document.createElement("span");secondLineVenue.className="mdc-list-item__secondary-text venue-secondline";var secondLineSchedule=document.createElement("span");secondLineSchedule.className="mdc-list-item__secondary-text";activity.get(value.activityId).onsuccess=function(event){var record=event.target.result;if(!record)return;var schedules=record.schedule;var venues=record.venue;var venueSpan=void 0;var dateSpan=generateLastestSchedule(schedules,value.createdTime);if(currentLocation){venueSpan=generateLatestVenue(venues,currentLocation)}if(venueSpan&&!dateSpan){secondLineVenue.textContent=venueSpan;secondLineVenue.style.maxWidth="70%"}else if(dateSpan&&!venueSpan){secondLineSchedule.textContent=dateSpan}else if(dateSpan&&venueSpan){secondLineVenue.textContent=venueSpan;secondLineSchedule.textContent=" | "+dateSpan}secondLineParent.appendChild(secondLineVenue);secondLineParent.appendChild(secondLineSchedule);resolve(activityListUI(value,secondLineParent))}})}function setMarginForSecondLine(secondLine){var nodes=secondLine.childNodes;if(nodes.length>1){if(nodes[0].innerHTML&&nodes[1].innerHTML){secondLine.style.marginTop="-42px";return secondLine}secondLine.style.marginTop="-35px";return secondLine}secondLine.style.marginTop="-35px";return secondLine}function generateTextIfActivityIsNotPending(status){var textStatus={CONFIRMED:"Done",CANCELLED:"Cancelled"};return textStatus[status]}function generateLastestSchedule(schedules,createdTime){var validSchedules=removeEmptyObjects(schedules,"startTime","endTime");var length=validSchedules.length;if(!length){return formatCreatedTime(createdTime)}var currentTime=Date.now();var ascendingOrder=sortDatesInAscendingOrderWithPivot(currentTime,validSchedules);return getTimeTypeForMultipleSchedule(currentTime,ascendingOrder)}function removeEmptyObjects(data,prop1,prop2){if(!data.length){return data}return data.filter(function(value){if(value[prop1]&&value[prop2]){return value}})}function sortDatesInAscendingOrderWithPivot(pivot,dates){var dataset=dates.slice();dataset.push(pivot);return dataset.sort(function(a,b){return a-b})}function getTimeTypeForMultipleSchedule(pivot,dates){var duplicate=dates.slice();var index=duplicate.indexOf(pivot);if(index==dates.length-1){return moment(dates[dates.length-2]).format("D, MMM").replace(",","")}return moment(dates[index+1]).format("D, MMM").replace(",","")}function formatCreatedTime(createdTime){if(!createdTime)return"";if(isToday(createdTime)){return moment(createdTime).format("hh:mm")}return moment(createdTime).format("D, MMM").replace(",","")}function isToday(comparisonTimestamp){var today=new Date;if(today.setHours(0,0,0,0)==new Date(comparisonTimestamp).setHours(0,0,0,0)){return true}return false}function generateLatestVenue(venues,currentLocation){var validVenues=removeEmptyObjects(venues,"location","address");var length=validVenues.length;if(!length){return""}if(length==1){return validVenues[0].location}var distances=[];venues.forEach(function(venue){var lat=venue.geopoint["_latitude"];var lon=venue.geopoint["_longitude"];var geopoint={latitude:lat,longitude:lon};distances.push({distance:calculateDistanceBetweenTwoPoints(geopoint,currentLocation),location:venue.location})});var sortedDistance=sortNearestLocation(distances);return sortedDistance[0].location}function sortNearestLocation(distances){var dataset=distances.slice();return dataset.sort(function(a,b){return a.distance-b.distance})}function activityListUI(data,secondLine){var li=document.createElement("li");li.dataset.id=data.activityId;li.onclick=function(){localStorage.setItem("clickedActivity",this.dataset.id);conversation(this.dataset.id,true)};li.classList.add("mdc-list-item","activity--list-item","mdc-elevation--z1");var dataObject=document.createElement("object");dataObject.data=data.creator.photo||"./img/empty-user.jpg";dataObject.type="image/jpeg";dataObject.className="mdc-list-item__graphic material-icons";var creator=document.createElement("img");creator.src="./img/empty-user.jpg";creator.className="empty-user-list";dataObject.appendChild(creator);var leftTextContainer=document.createElement("span");leftTextContainer.classList.add("mdc-list-item__text");var activityNameText=document.createElement("span");activityNameText.className="mdc-list-item__primary-text bigBlackBold";activityNameText.textContent=data.activityName;leftTextContainer.appendChild(activityNameText);leftTextContainer.appendChild(secondLine);var timeCustomText=document.createElement("div");timeCustomText.className="mdc-meta__custom-text";timeCustomText.style.width="76px";if(isToday(data.timestamp)){timeCustomText.style.marginTop="4px"}timeCustomText.textContent=moment(data.timestamp).calendar();var metaTextContainer=document.createElement("span");metaTextContainer.classList.add("mdc-list-item__meta");metaTextContainer.appendChild(timeCustomText);metaTextContainer.appendChild(generateIconByCondition(data,li));li.appendChild(dataObject);li.appendChild(leftTextContainer);li.appendChild(metaTextContainer);return li}function generateIconByCondition(data,li){if(data.count){var countSpan=document.createElement("span");countSpan.textContent=data.count;countSpan.className="count mdc-meta__custom-text";li.classList.add("count-active");return countSpan}var cancelIcon=document.createElement("i");cancelIcon.classList.add("status-cancel","material-icons",""+data.status);cancelIcon.textContent="clear";var confirmedIcon=document.createElement("i");confirmedIcon.classList.add("status-confirmed","material-icons",""+data.status);confirmedIcon.textContent="check";var pendingIcon=document.createElement("i");pendingIcon.classList.add("status-pending","material-icons",""+data.status);pendingIcon.textContent="";if(data.status==="CONFIRMED"){return confirmedIcon}if(data.status==="CANCELLED"){return cancelIcon}return pendingIcon}function appendActivityListToDom(activityDom){var parent=document.getElementById("activity--list");if(parent){parent.appendChild(activityDom)}}function getRootRecord(){return new Promise(function(resolve,reject){var record=void 0;var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var rootTx=db.transaction(["root"],"readwrite");var rootStore=rootTx.objectStore("root");rootStore.get(dbName).onsuccess=function(event){var data=event.target.result;data?record=data:record=null};rootTx.oncomplete=function(){if(record){resolve(record)}else{reject({message:"No root record found from getRootRecord"})}};rootTx.onerror=function(){reject({message:rootTx.error.message+" from getRootRecord"})}};req.onerror=function(){reject({message:req.error+" from getRootRecord"})}})}function createActivityIcon(){if(document.getElementById("create-activity"))return;getCountOfTemplates().then(function(count){if(count){createActivityIconDom();return}}).catch(handleError)}function getCountOfTemplates(){return new Promise(function(resolve,reject){var count=0;var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var tx=db.transaction(["subscriptions"],"readonly");var subscriptionObjectStore=tx.objectStore("subscriptions").index("office");subscriptionObjectStore.openCursor(null,"nextunique").onsuccess=function(event){var cursor=event.target.result;if(!cursor)return;count++;cursor.continue()};tx.oncomplete=function(){resolve(count)};tx.onerror=function(){reject({message:tx.error+" from getCountOfTemplates"})}};req.onerror=function(){reject({message:req.error+" from getCountOfTemplates"})}})}function createActivityIconDom(){var parent=document.getElementById("create-activity--parent");var fab=document.createElement("button");fab.className="mdc-fab create-activity";fab.id="create-activity";fab.setAttribute("aria-label","Add");var span=document.createElement("span");span.className="mdc-fab_icon material-icons";span.id="activity-create--icon";span.textContent="add";fab.appendChild(span);parent.innerHTML=fab.outerHTML;document.querySelector(".create-activity").addEventListener("click",function(evt){callSubscriptionSelectorUI()})}function callSubscriptionSelectorUI(checkIn){selectorUI({record:"",store:"subscriptions",suggestCheckIn:checkIn})}function listPanel(){if(document.getElementById("activity-list-main"))return;var listCard=document.createElement("div");listCard.className="mdc-card panel-card mdc-top-app-bar--fixed-adjust";listCard.id="activity-list-main";var listUl=document.createElement("ul");listUl.className="mdc-list mdc-list--two-line mdc-list--avatar-list";listUl.id="activity--list";listCard.appendChild(listUl);var fabParent=document.createElement("div");fabParent.id="create-activity--parent";listCard.appendChild(fabParent);document.getElementById("app-current-panel").innerHTML=listCard.outerHTML}function creatListHeader(headerName){var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;getImageFromNumber(db,firebase.auth().currentUser.phoneNumber).then(function(uri){var parentIconDiv=document.createElement("div");parentIconDiv.className="profile--icon-header";var menuIcon=document.createElement("div");menuIcon.id="menu--panel";var object=document.createElement("object");object.className="list-photo-header";object.type="image/jpeg";object.data=uri||"./img/empty-user.jpg";var icon=document.createElement("img");icon.src="./img/empty-user.jpg";icon.className="list-photo-header";object.appendChild(icon);menuIcon.appendChild(object);var headerText=document.createElement("p");headerText.textContent=headerName;menuIcon.appendChild(headerText);parentIconDiv.appendChild(menuIcon);modifyHeader({id:"app-main-header",left:parentIconDiv.outerHTML,right:""});document.querySelector(".list-photo-header").addEventListener("click",function(){profileView(true)})})}}function scrollToActivity(){var clickedActivity=localStorage.getItem("clickedActivity");if(document.querySelector('[data-id="'+clickedActivity+'"]')){document.querySelector('[data-id="'+clickedActivity+'"]').scrollIntoView({behavior:"instant",block:"center",inline:"center"});localStorage.removeItem("clickedActivity");return}}function notificationWorker(type,updateTimestamp){return new Promise(function(resolve,reject){notification.postMessage({dbName:firebase.auth().currentUser.uid,type:type,updateTimestamp:updateTimestamp});notification.onmessage=function(message){resolve(message.data)};notification.onerror=function(error){reject({message:error.message+" from notificationWorker at "+error.lineno})}})}function modifyHeader(attr){if(attr.left){var left=document.getElementById(attr.id+"view-type");left.innerHTML=attr.left}if(attr.right){var right=document.getElementById(attr.id+"action-data");right.innerHTML=attr.right}}function profileView(pushState){if(pushState){history.pushState(["profileView"],null,null)}if(window.addEventListener){window.removeEventListener("scroll",handleScroll,false)}document.body.style.backgroundColor="#eeeeee";var user=firebase.auth().currentUser;var dbName=user.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var rootTx=db.transaction(["root"],"readwrite");var rootObjectStore=rootTx.objectStore("root");rootObjectStore.get(dbName).onsuccess=function(event){var record=event.target.result;rootObjectStore.put(record);rootTx.oncomplete=function(){createProfileHeader();createProfilePanel(db).then(function(view){if(!document.getElementById("app-current-panel"))return;document.getElementById("app-current-panel").innerHTML=view.outerHTML;document.getElementById("close-profile--panel").addEventListener("click",function(){backNav()});if(native.getName()==="Android"){document.getElementById("uploadProfileImage").addEventListener("click",function(){AndroidInterface.openImagePicker()})}else{inputFile("uploadProfileImage").addEventListener("change",function(){readUploadedFile()})}changeDisplayName(user);changeEmailAddress(user)})}}}}function inputFile(selector){return document.getElementById(selector)}function createProfileHeader(){var backSpan=document.createElement("span");backSpan.id="close-profile--panel";var backIcon=document.createElement("i");backIcon.className="material-icons";backIcon.textContent="arrow_back";backSpan.appendChild(backIcon);modifyHeader({id:"app-main-header",left:backSpan.outerHTML})}function createProfilePanel(db){return new Promise(function(resolve){getImageFromNumber(db,firebase.auth().currentUser.phoneNumber).then(function(uri){var profileView=document.createElement("div");profileView.id="profile-view--container";profileView.className="mdc-top-app-bar--fixed-adjust mdc-theme--background";var uploadBtn=document.createElement("button");uploadBtn.className="mdc-fab";if(native.getName()==="Android"){uploadBtn.id="uploadProfileImage"}var label=document.createElement("label");label.setAttribute("for","uploadProfileImage");var btnText=document.createElement("span");btnText.className="mdc-fab__icon material-icons";btnText.textContent="add_a_photo";label.appendChild(btnText);uploadBtn.appendChild(label);var fileInput=void 0;if(native.getName()!=="Android"){fileInput=document.createElement("input");fileInput.type="file";fileInput.style.display="none";fileInput.id="uploadProfileImage";fileInput.accept="image/jpeg;"}var profileImgCont=document.createElement("div");profileImgCont.id="profile--image-container";profileImgCont.className="profile-container--main";var dataObject=document.createElement("object");dataObject.type="image/jpeg";dataObject.data=uri||"./img/empty-user-big.jpg";dataObject.id="user-profile--image";var profileImg=document.createElement("img");profileImg.src="./img/empty-user-big.jpg";profileImg.className="empty-user-profile";dataObject.appendChild(profileImg);var overlay=document.createElement("div");overlay.className="insert-overlay";profileImgCont.appendChild(dataObject);profileImgCont.appendChild(overlay);profileImgCont.appendChild(uploadBtn);if(native.getName()!=="Android"){label.appendChild(fileInput)}var nameChangeCont=document.createElement("div");nameChangeCont.id="name--change-container";nameChangeCont.className="profile-psuedo-card";var toggleBtnName=document.createElement("button");toggleBtnName.className="mdc-icon-button material-icons hidden";toggleBtnName.id="edit--name";toggleBtnName.setAttribute("aria-hidden","true");toggleBtnName.setAttribute("aria-pressed","false");toggleBtnName.textContent="check";var currentName=firebase.auth().currentUser.displayName;nameChangeCont.innerHTML='<div class="mdc-text-field" id=\'name-change-field\'>\n        <input autocomplete="off" type="text"  placeholder="'+(currentName?"":"Enter Your Name")+'"  id="pre-filled-name" class="mdc-text-field__input" value="'+(currentName?currentName:"")+'">\n        <label class="mdc-floating-label mdc-floating-label--float-above" for="pre-filled-name">\n         Your Name\n        </label>\n        <div class="mdc-line-ripple"></div>\n      </div>\n      ';nameChangeCont.appendChild(toggleBtnName);var emailCont=document.createElement("div");emailCont.id="email--change-container";emailCont.className="profile-psuedo-card";var toggleBtnEmail=document.createElement("button");toggleBtnEmail.className="mdc-icon-button material-icons hidden";toggleBtnEmail.id="edit--email";toggleBtnEmail.setAttribute("aria-hidden","true");toggleBtnEmail.setAttribute("aria-pressed","false");toggleBtnEmail.textContent="check";var currentEmail=firebase.auth().currentUser.email;emailCont.innerHTML='<div class="mdc-text-field" id=\'email-change-field\'>\n        <input  autocomplete="off" type="text" id="pre-filled-email" class="mdc-text-field__input" value="'+(currentEmail?currentEmail:"")+'" placeholder="'+(currentEmail?"":"Enter your Email")+'">\n        <label class="mdc-floating-label mdc-floating-label--float-above" for="pre-filled-email">\n         Your Email\n        </label>\n        <div class="mdc-line-ripple"></div>\n      </div>\n      ';emailCont.appendChild(toggleBtnEmail);profileView.appendChild(profileImgCont);profileView.appendChild(nameChangeCont);profileView.appendChild(emailCont);resolve(profileView)})})}function updateEmailDialog(){if(!document.getElementById("updateEmailDialog")){var aside=document.createElement("aside");aside.className="mdc-dialog mdc-dialog--open";aside.id="updateEmailDialog";var surface=document.createElement("div");surface.className="mdc-dialog__surface";surface.style.width="90%";surface.style.height="auto";var section=document.createElement("section");section.className="mdc-dialog__body";section.id="refresh-login";var footer=document.createElement("footer");footer.className="mdc-dialog__footer";var canel=document.createElement("button");canel.type="button";canel.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel update-email-cancel";canel.textContent="Cancel";canel.style.backgroundColor="#3498db";footer.appendChild(canel);surface.appendChild(section);surface.appendChild(footer);aside.appendChild(surface);document.body.appendChild(aside)}}function timeDiff(lastSignInTime){var currentDate=moment().format("YYY-MM-DD HH:mm");var authSignInTime=moment(lastSignInTime).format("YYY-MM-DD HH:mm");return moment(currentDate).diff(moment(authSignInTime),"minutes")}function newSignIn(value,field){updateEmailDialog();var dialogSelector=document.querySelector("#updateEmailDialog");var emailDialog=new mdc.dialog.MDCDialog(dialogSelector);emailDialog.show();try{if(!ui){ui=new firebaseui.auth.AuthUI(firebase.auth())}ui.start("#refresh-login",firebaseUiConfig(value));setTimeout(function(){document.querySelector(".firebaseui-id-phone-number").disabled=true;document.querySelector(".firebaseui-label").remove();document.querySelector(".firebaseui-title").textContent="Verify your phone Number to Update your Email address"},500);emailDialog.listen("MDCDialog:cancel",function(){field.value=firebase.auth().currentUser.email;dialogSelector.remove()})}catch(e){dialogSelector.remove();console.log(e);handleError({message:e.message+" from newSignIn function during email updation"});snacks("Please try again later")}}function readUploadedFile(image){if(native.getName()==="Android"){sendBase64ImageToBackblaze(image);return}var file=inputFile("uploadProfileImage").files[0];var reader=new FileReader;reader.addEventListener("load",function(){sendBase64ImageToBackblaze(reader.result);return},false);if(file){reader.readAsDataURL(file)}}function sendBase64ImageToBackblaze(base64){var selector=document.getElementById("user-profile--image");var container=document.getElementById("profile--image-container");var pre="data:image/jpeg;base64,";if(selector){selector.data=pre+base64}if(container){document.getElementById("profile--image-container").appendChild(loader("profile--loader"))}var body={imageBase64:pre+base64};requestCreator("backblaze",body)}function authUpdatedError(error){if(error.message!=="auth/invalid-email"){handleError({message:error.message+" from authUpdatedError"})}if(document.querySelector(".init-loader")){document.querySelector(".init-loader").remove()}snacks(error.message)}function changeDisplayName(){var nameField=document.getElementById("name-change-field");var name=new mdc.textField.MDCTextField(nameField);var nameChangeButton=document.getElementById("edit--name");var currentName=firebase.auth().currentUser.displayName;nameField.addEventListener("click",function(){document.getElementById("pre-filled-name").placeholder="";nameChangeButton.classList.remove("hidden");nameField.classList.add("short")});nameField.addEventListener("keydown",function(event){if(event.keyCode==13){updateName(name.value)}});nameChangeButton.addEventListener("click",function(){updateName(name.value)})}function updateName(name){if(!name){snacks("Please Enter a Name");return}firebase.auth().currentUser.updateProfile({displayName:name}).then(successDialog).catch(function(error){snacks("Please Try again later");handleError({message:error+" at updateProfile in changeDisplayName"})})}function changeEmailAddress(){var emailField=document.getElementById("email-change-field");var email=new mdc.textField.MDCTextField(emailField);var editEmail=document.getElementById("edit--email");emailField.addEventListener("click",function(){document.getElementById("pre-filled-email").placeholder="";editEmail.classList.remove("hidden");emailField.classList.add("short")});emailField.addEventListener("keydown",function(event){if(event.keyCode==13){emailValidation(email)}});editEmail.addEventListener("click",function(){emailValidation(email)})}function emailValidation(emailField){var auth=firebase.auth().currentUser;var value=emailField.value;if(!value){snacks("Enter a valid Email Id");return}if(value===auth.email&&auth.emailVerified){snacks("You have already set this as your email address");return}if(timeDiff(auth.metadata.lastSignInTime)<=2){updateEmail(auth,value)}else{newSignIn(value,emailField)}}function updateEmail(user,email){document.getElementById("growthfile").appendChild(loader("init-loader"));user.updateEmail(email).then(function(){emailUpdateSuccess(true)}).catch(authUpdatedError)}function emailUpdateSuccess(showSuccessDialog){var user=firebase.auth().currentUser;user.sendEmailVerification().then(function(){emailVerificationSuccess(showSuccessDialog)}).catch(emailVerificationError)}function emailVerificationSuccess(showSuccessDialog){if(showSuccessDialog){successDialog()}snacks("Verification link has been send to your email address")}function emailVerificationError(error){snacks(error.message);if(document.querySelector(".init-loader")){document.querySelector(".init-loader").remove()}handleError({message:error.message+" from emailVerificationError"})}function initUserSelectorSearch(data,userSearchField){var req=indexedDB.open(firebase.auth().currentUser.uid);req.onsuccess=function(){var db=req.result;var searchField=userSearchField["input_"];searchField.value="";var objectStore="";var frag=document.createDocumentFragment();searchField.addEventListener("input",function(e){var searchString=e.target.value;if(isNumber(searchString)){objectStore=db.transaction("users").objectStore("users");searchUsersDB(formatNumber(searchString),objectStore,frag,data);return}frag=document.createDocumentFragment();objectStore=db.transaction("users").objectStore("users").index("displayName");searchUsersDB(formatName(searchString),objectStore,frag,data)})}}function isNumber(searchTerm){return!isNaN(searchTerm)}function formatNumber(numberString){var number=numberString;if(number.substring(0,2)==="91"){number="+"+number}else if(number.substring(0,3)!=="+91"){number="+91"+number}return number}function formatName(name){var nameArr=name.split(" ");var length=nameArr.length;var result=[];var index=0;for(index=0;index<length;index++){var element=nameArr[index];if(element.charAt(0).toUpperCase()===name.charAt(0).toUpperCase)return name;result.push(element.charAt(0).toUpperCase()+element.slice(1))}return result.join(" ")}function checkNumber(number){var expression=/^\+[1-9]\d{11,14}$/;return expression.test(number)}function searchUsersDB(searchTerm,objectStore,frag,data){console.log(searchTerm);var bound=IDBKeyRange.bound(searchTerm,searchTerm+"￿");var ul=document.getElementById("data-list--container");objectStore.openCursor(bound).onsuccess=function(event){var cursor=event.target.result;if(!cursor){ul.innerHTML="";if(frag.children.length==0){var notify=document.createElement("div");notify.className="data-not-found";var textSpan=document.createElement("p");textSpan.textContent="No Contact Found";textSpan.className="mdc-typography--headline5";notify.appendChild(textSpan);if(!document.querySelector(".data-not-found")){ul.appendChild(notify)}return}ul.appendChild(frag);var selectedBoxes=document.querySelectorAll('[data-selected="true"]');selectedBoxes.forEach(function(box){var mdcBox=new mdc.checkbox.MDCCheckbox.attachTo(box);mdcBox.checked=true;box.children[1].style.animation="none";box.children[1].children[0].children[0].style.animation="none"});return}if(data.attachment.present){frag.appendChild(createSimpleAssigneeLi(cursor.value,true,false))}else if(data.record.assignees.indexOf(cursor.value.mobile)==-1){frag.appendChild(createSimpleAssigneeLi(cursor.value,true,true))}cursor.continue()}}function selectorUI(data){var parent=document.getElementById("app-current-panel");createSelectorHeader(data);var container=document.createElement("div");container.className="selector-container mdc-top-app-bar--fixed-adjust";if(data.store==="map"){container.appendChild(createSeachInput("map-selector-search","Search For Location"))}if(data.store==="users"){container.appendChild(createSeachInput("users-selector-search","Search Users"))}var ul=document.createElement("ul");ul.id="data-list--container";ul.className="mdc-list";container.appendChild(ul);var warning=document.createElement("span");warning.className="selector-warning-text";warning.id="selector-warning";container.appendChild(warning);var submitButton=document.createElement("button");submitButton.textContent="SELECT";submitButton.id="selector-submit-send";submitButton.className="mdc-button selector-submit--button selector-send";container.appendChild(submitButton);parent.innerHTML=container.outerHTML;window.scrollTo(0,0);var activityRecord=data.record;var selectorStore=void 0;var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;if(data.store==="map"){var mapSeachInit=new mdc.textField.MDCTextField.attachTo(document.querySelector("#map-selector-search"));var tx=db.transaction([data.store]);var input=mapSeachInit["input_"];var options={componentRestrictions:{country:"in"}};autocomplete=new google.maps.places.Autocomplete(input,options);input.placeholder="";initializeAutocompleteGoogle(autocomplete,data);getLocationForMapSelector(tx,data).then(function(count){if(!count){document.getElementById("map-selector-search").style.display="none";document.getElementById("selector-submit-send").textContent="CANCEL";document.getElementById("data-list--container").appendChild(noSelectorResult("No Location Found"))}handleClickListnersForMap(data,count)}).catch(console.log)}if(data.store==="subscriptions"){fillSubscriptionInSelector(db,data)}if(data.store==="users"){selectorStore=db.transaction(data.store).objectStore(data.store);var userSearchInit=new mdc.textField.MDCTextField.attachTo(document.getElementById("users-selector-search"));initUserSelectorSearch(data,userSearchInit);resetSelectedContacts().then(function(){fillUsersInSelector(data)})}if(data.store==="children"){var _tx=db.transaction([data.store]);var store=_tx.objectStore(data.store).index("templateStatus");fillChildrenInSelector(store,data,_tx)}}}function createSelectorHeader(data){var backDiv=document.createElement("div");backDiv.className="back-icon";backDiv.id="back-selector";backDiv.style.float="left";var backIcon=document.createElement("i");backIcon.style.marginRight="5px";backIcon.className="material-icons back-icon--large";backIcon.textContent="arrow_back";backDiv.appendChild(backIcon);modifyHeader({id:"app-main-header",left:backDiv.outerHTML});document.querySelector("#back-selector").addEventListener("click",function(e){if(data.store==="subscriptions"){listView()}else{document.querySelector(".mdc-top-app-bar__section--align-end").classList.remove("search-field-transform");updateCreateActivity(history.state[1],true)}})}var apiHandler=new Worker("apiHandler.js");function handleError(error){var errorInStorage=JSON.parse(localStorage.getItem("error"));if(!errorInStorage.hasOwnProperty(error.message)){errorInStorage[error.message]=true;localStorage.setItem("error",JSON.stringify(errorInStorage));error.device=native.getInfo();if(error.stack){error.stack=error.stack}requestCreator("instant",JSON.stringify(error));return}}function loader(nameClass){var div=document.createElement("div");div.className="loader "+nameClass;return div}function successDialog(){var aside=document.createElement("aside");aside.className="mdc-dialog mdc-dialog--open success--dialog";aside.id="success--dialog";var surface=document.createElement("div");surface.className="mdc-dialog__surface round--surface";var section=document.createElement("section");section.className="mdc-dialog__body";var div=document.createElement("div");div.className="success--container";var icon=document.createElement("div");icon.className="success--check";div.appendChild(icon);section.appendChild(div);surface.appendChild(section);aside.appendChild(surface);document.body.appendChild(aside);var successDialog=new mdc.dialog.MDCDialog(document.querySelector("#success--dialog"));successDialog.show();setTimeout(function(){document.getElementById("success--dialog").remove();document.body.classList.remove("mdc-dialog-scroll-lock")},1200);scroll_namespace.count=0;scroll_namespace.size=20;localStorage.removeItem("clickedActivity");listView()}function appDialog(messageString,showButton){if(!document.getElementById("enable-gps")){var aside=document.createElement("aside");aside.className="mdc-dialog mdc-dialog--open";aside.id="enable-gps";var surface=document.createElement("div");surface.className="mdc-dialog__surface";surface.style.width="90%";surface.style.height="auto";var section=document.createElement("section");section.className="mdc-dialog__body mock-main-body";section.textContent=messageString;var footer=document.createElement("footer");footer.className="mdc-dialog__footer mock-footer";var ok=document.createElement("button");ok.type="button";ok.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept";ok.textContent="Ok";if(!showButton){ok.classList.add("hidden")}ok.style.backgroundColor="#3498db";footer.appendChild(ok);surface.appendChild(section);surface.appendChild(footer);aside.appendChild(surface);document.body.appendChild(aside)}var gpsDialog=new mdc.dialog.MDCDialog(document.querySelector("#enable-gps"));gpsDialog.listen("MDCDialog:accept",function(){listView()});gpsDialog.show()}function officeRemovalDialog(text){if(!document.getElementById("office-removal-dialog")){var aside=document.createElement("aside");aside.className="mdc-dialog mdc-dialog--open";aside.id="office-removal-dialog";aside.style.backgroundColor="rgba(0,0,0,0.47)";var surface=document.createElement("div");surface.className="mdc-dialog__surface";surface.style.width="90%";surface.style.height="auto";var section=document.createElement("section");section.className="mdc-dialog__body mock-main-body";section.textContent=text;var footer=document.createElement("footer");footer.className="mdc-dialog__footer mock-footer";var ok=document.createElement("button");ok.type="button";ok.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept";ok.textContent="Ok";ok.style.width="100%";ok.style.backgroundColor="#3498db";footer.appendChild(ok);surface.appendChild(section);surface.appendChild(footer);aside.appendChild(surface);document.body.appendChild(aside)}}function appUpdateDialog(messageString,title){if(!document.getElementById("app-update-dialog")){var aside=document.createElement("aside");aside.className="mdc-dialog mdc-dialog--open";aside.id="app-update-dialog";var surface=document.createElement("div");surface.className="mdc-dialog__surface";surface.style.width="90%";surface.style.height="auto";var header=document.createElement("header");header.className="mdc-dialog__header";var headerText=document.createElement("h2");headerText.className="mdc-dialog__header__title";headerText.textContent=title;header.appendChild(headerText);var section=document.createElement("section");section.className="mdc-dialog__body";section.textContent=messageString;var footer=document.createElement("footer");footer.className="mdc-dialog__footer";surface.appendChild(header);surface.appendChild(section);surface.appendChild(footer);aside.appendChild(surface);document.body.appendChild(aside)}var appUpdate=new mdc.dialog.MDCDialog(document.querySelector("#app-update-dialog"));appUpdate.show()}function progressBar(){var div=document.createElement("div");div.className="mdc-linear-progress mdc-linear-progress--indeterminate progress--update";div.role="progressbar";var bufferDots=document.createElement("div");bufferDots.className="mdc-linear-progress__buffering-dots";var buffer=document.createElement("div");buffer.className="mdc-linear-progress__buffer";var primary=document.createElement("div");primary.className="mdc-linear-progress__bar mdc-linear-progress__primary-bar";var primaryInner=document.createElement("span");primaryInner.className="mdc-linear-progress__bar-inner";primary.appendChild(primaryInner);var secondary=document.createElement("div");secondary.className="mdc-linear-progress__bar mdc-linear-progress__secondary-bar";var secondaryInner=document.createElement("span");secondaryInner.className="mdc-linear-progress__bar-inner";secondary.appendChild(secondaryInner);div.appendChild(bufferDots);div.appendChild(buffer);div.appendChild(primary);div.appendChild(secondary);return div}function snacks(message,type){var snack=document.createElement("div");snack.className="mdc-snackbar";snack.setAttribute("aria-live","assertive");snack.setAttribute("aria-atomic","true");snack.setAttribute("aria-hidden","true");snack.style.zIndex=99999;var snackbarText=document.createElement("div");snackbarText.className="mdc-snackbar__text mdc-typography--subtitle2";var snackbarAction=document.createElement("div");snackbarAction.className="mdc-snackbar__action-wrapper";var button=document.createElement("button");button.className="mdc-snackbar__action-button";snackbarAction.appendChild(button);snack.appendChild(snackbarText);snack.appendChild(snackbarAction);document.getElementById("snackbar-container").innerHTML=snack.outerHTML;var data={message:message,actionText:"OK",timeout:5e3,actionHandler:function actionHandler(){}};var snackbar=mdc.snackbar.MDCSnackbar.attachTo(document.querySelector(".mdc-snackbar"));snackbar.show(data)}function fetchCurrentTime(serverTime){return Date.now()+serverTime}function geolocationApi(body){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("POST","https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyA4s7gp7SFid_by1vLVZDmcKbkEcsStBAo",true);xhr.setRequestHeader("Content-Type","application/json");xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status>=400){return reject({message:xhr.response,body:body})}var response=JSON.parse(xhr.response);if(!response){return reject({message:"Response From geolocation Api "+response,body:body})}resolve({latitude:response.location.lat,longitude:response.location.lng,accuracy:response.accuracy,provider:{body:body}})}};xhr.onerror=function(){reject({message:xhr})};xhr.send(body)})}function handleRequestBody(request){var body=JSON.parse(request);if(body.wifiAccessPoints&&body.wifiAccessPoints.length){if(body.cellTowers){delete body.cellTowers}return JSON.stringify(body)}else{return null}}function manageLocation(){return new Promise(function(resolve,reject){var holder={};if(native.getName()==="Android"){html5Geolocation().then(function(htmlLocation){if(htmlLocation.accuracy<=350)return resolve(htmlLocation);holder["html5"]={body:"",result:htmlLocation};handleGeoLocationApi(holder,htmlLocation).then(function(location){resolve(location)})}).catch(function(htmlError){handleGeoLocationApi(holder).then(function(location){resolve(location)}).catch(function(error){reject({message:"Both HTML and Geolocation failed to fetch location.",body:JSON.stringify({html5:htmlError,geolocation:JSON.stringify(error)})})})});return}html5Geolocation().then(function(location){resolve(location)}).catch(function(error){reject(error)})})}function handleGeoLocationApi(holder,htmlLocation){return new Promise(function(resolve,reject){var body=void 0;var allLocations=[];try{body=AndroidInterface.getCellularData()}catch(e){if(htmlLocation){handleError({message:"Using HTML location beacuse Java exception was raised when getting cell tower information ",body:e.message});resolve(htmlLocation);return}reject(e.message);return}if(!Object.keys(JSON.parse(body)).length){if(htmlLocation){return resolve(htmlLocation)}return reject("Empty Object returned from getCellularData method")}geolocationApi(body).then(function(cellLocation){if(cellLocation.accuracy<=350)return resolve(cellLocation);holder["orignialGeolocationResponse"]={body:body,result:cellLocation};var withoutCellTower=handleRequestBody(body);if(!withoutCellTower){if(cellLocation.accuracy>=1200){handleError({message:"Oringinal CellTower has accuracy more than 1200 and WAP doesnt exist",body:JSON.stringify(holder)})}if(!htmlLocation){resolve(cellLocation);return}if(cellLocation.accuracy<htmlLocation.accuracy){resolve(cellLocation);return}return resolve(htmlLocation)}geolocationApi(withoutCellTower).then(function(withoutCellTowerLocation){if(withoutCellTowerLocation.accuracy<=350)return resolve(withoutCellTowerLocation);if(withoutCellTowerLocation.accuracy>=1200){holder["withoutCellTower"]={body:withoutCellTower,result:withoutCellTowerLocation};handleError({message:"html5,originalCellTower,WithoutCellTower",body:JSON.stringify(holder)})}Object.keys(holder).forEach(function(key){allLocations.push(holder[key].result)});return resolve(sortedByAccuracy(allLocations))}).catch(function(error){if(cellLocation.accuracy>=1200){holder["withoutCellTower"]={body:withoutCellTower};handleError({message:"Orinigal CellTower has accuracy more than 1200 and api failure when sending cellTowerObject without cellularTowers",body:JSON.stringify(holder)})}if(!htmlLocation){resolve(cellLocation);return}if(cellLocation.accuracy<htmlLocation.accuracy){resolve(cellLocation);return}return resolve(htmlLocation)})}).catch(function(error){if(htmlLocation){resolve(htmlLocation);return}reject(error)})})}function iosLocationError(error){handleError({message:error});manageLocation().then(function(location){if(location.latitude&&location.longitude){updateLocationInRoot(location)}})}function html5Geolocation(){return new Promise(function(resolve,reject){var prom=[];for(var i=0;i<2;i++){var navProm=new Promise(function(resolve,reject){navigator.geolocation.getCurrentPosition(function(position){return resolve({latitude:position.coords.latitude,longitude:position.coords.longitude,accuracy:position.coords.accuracy,provider:"HTML5"})},function(error){reject({message:error})},{timeout:5e3,maximumAge:0,enableHighAccuracy:true})});prom.push(navProm)}Promise.all(prom).then(function(results){var bestAccuracy=results.sort(function(a,b){return a.accuracy-b.accuracy});resolve(bestAccuracy[0]);return}).catch(function(error){reject({message:error.message.message});return})})}function showSuggestCheckInDialog(offices){var checkInDialog=document.querySelector("#suggest-checkIn-dialog");if(!checkInDialog)return;var dialog=new mdc.dialog.MDCDialog(checkInDialog);if(!dialog)return;if(document.getElementById("dialog--component"))return;dialog["root_"].classList.remove("hidden");dialog.show();dialog.listen("MDCDialog:accept",function(evt){if(isLocationStatusWorking()){if(offices.length===1){createTempRecord(offices[0],"check-in",{suggestCheckIn:true})}else{callSubscriptionSelectorUI(true)}}});dialog.listen("MDCDialog:cancel",function(evt){app.isNewDay()})}function isDialogOpened(id){var currentDialog=document.querySelector(id);if(!currentDialog)return false;var isOpen=currentDialog.classList.contains("mdc-dialog--open");return isOpen}function updateLocationInRoot(finalLocation){var previousLocation={latitude:"",longitude:"",accuracy:"",provider:"",lastLocationTime:""};var dbName=firebase.auth().currentUser.uid;var req=indexedDB.open(dbName);req.onsuccess=function(){var db=req.result;var tx=db.transaction(["root"],"readwrite");var rootStore=tx.objectStore("root");rootStore.get(dbName).onsuccess=function(event){var record=event.target.result;if(record.location){previousLocation=record.location}record.location=finalLocation;record.location.lastLocationTime=Date.now();rootStore.put(record)};tx.oncomplete=function(){if(!previousLocation.latitude)return;if(!previousLocation.longitude)return;if(!finalLocation.latitude)return;if(!finalLocation.longitude)return;var distanceBetweenBoth=calculateDistanceBetweenTwoPoints(previousLocation,finalLocation);var suggestCheckIn=new CustomEvent("suggestCheckIn",{detail:isLocationMoreThanThreshold(distanceBetweenBoth)||app.isNewDay()});window.dispatchEvent(suggestCheckIn)};tx.onerror=function(){handleError({message:tx.error.message+" from updateLocationInRoot",body:tx.error.name})};req.onerror=function(){handleError({message:req.error.message+" from updateLocationInRoot",body:req.error.name})}}}function toRad(value){return value*Math.PI/180}function calculateDistanceBetweenTwoPoints(oldLocation,newLocation){var R=6371;var dLat=toRad(newLocation.latitude-oldLocation.latitude);var dLon=toRad(newLocation.longitude-oldLocation.longitude);var lat1=toRad(newLocation.latitude);var lat2=toRad(oldLocation.latitude);var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var distance=R*c;return distance}function isLocationMoreThanThreshold(distance){var THRESHOLD=1;if(distance>=THRESHOLD)return true;return false}function isLocationLessThanThreshold(distance){var THRESHOLD=1;if(distance<=THRESHOLD)return true;return false}function sortedByAccuracy(geoData){var result=geoData.sort(function(a,b){return a.accuracy-b.accuracy});return result[0]}function sendCurrentViewNameToAndroid(viewName){if(native.getName()==="Android"){try{AndroidInterface.startConversation(viewName)}catch(e){handleError({message:e.message+" from startConversation"})}}}var locationPermission=function(){return{checkNetworkProvider:function checkNetworkProvider(){try{return AndroidInterface.isNetworkProivderAvailable()}catch(e){return true}},checkLocationPermission:function checkLocationPermission(){try{return AndroidInterface.isLocationPermissionGranted()}catch(e){handleError({message:e.message+" from isLocationPermissionGranted"});return true}}}}();function createAndroidDialog(title,body){try{AndroidInterface.showDialog(title,body)}catch(e){handleError({message:e.message+" from showDialog"});appDialog(body,true)}}function isLocationStatusWorking(){if(native.getName()!=="Android")return true;if(!locationPermission.checkLocationPermission()){createAndroidDialog("Location Permission","Please Allow Growthfile location access.");return}if(!AndroidInterface.isConnectionActive()){createAndroidDialog("No Connectivity","Please Check your Internet Connectivity");return}return true}function requestCreator(requestType,requestBody){var auth=firebase.auth().currentUser;var requestGenerator={type:requestType,body:"",user:{token:"",uid:auth.uid,displayName:auth.displayName,photoURL:auth.photoURL,phoneNumber:auth.phoneNumber}};if(requestType==="instant"||requestType==="now"||requestType==="Null"||requestType==="backblaze"){auth.getIdToken(false).then(function(token){requestGenerator.body=requestBody;requestGenerator.user.token=token;apiHandler.postMessage(requestGenerator)}).catch(function(error){handleError({message:error.code})})}else{getRootRecord().then(function(rootRecord){var location=rootRecord.location;var isLocationOld=isLastLocationOlderThanThreshold(location.lastLocationTime,5);var promises=[auth.getIdToken(false)];if(isLocationOld){promises.push(manageLocation())}Promise.all(promises).then(function(result){var token=result[0];if(result.length==2){location=result[1];console.log(location);updateLocationInRoot(location)}var geopoints={latitude:location.latitude,longitude:location.longitude,accuracy:location.accuracy,provider:location.provider};requestBody["timestamp"]=fetchCurrentTime(rootRecord.serverTime);requestBody["geopoint"]=geopoints;requestGenerator.body=requestBody;requestGenerator.user.token=token;sendRequest(location,requestGenerator)}).catch(function(error){handleError(error)})})}apiHandler.onmessage=messageReceiver;apiHandler.onerror=onErrorMessage}function sendRequest(location,requestGenerator){if(location.latitude&&location.longitude&&location.accuracy){apiHandler.postMessage(requestGenerator)}else{appDialog("Fetching Location Please wait.",true);getRootRecord().then(function(record){var cellTowerInfo=void 0;try{cellTowerInfo=AndroidInterface.getCellularData()}catch(e){cellTowerInfo=e.message}var body={deviceInfo:native.getInfo(),storedLocation:record.location,cellTower:cellTowerInfo};handleError({message:"No location found in indexedDB",body:body})})}}function isLastLocationOlderThanThreshold(test,threshold){var currentTime=moment(moment().valueOf());var lastLocationTime=test;var duration=moment.duration(currentTime.diff(lastLocationTime));var difference=duration.asSeconds();if(difference>threshold){return true}return false}var receiverCaller={initFirstLoad:initFirstLoad,"update-app":updateApp,"removed-from-office":officeRemovalSuccess,"revoke-session":revokeSession,notification:successDialog,"android-stop-refreshing":androidStopRefreshing,apiFail:apiFail,backblazeRequest:urlFromBase64Image};function messageReceiver(response){receiverCaller[response.data.type](response.data)}function emailVerify(){if(firebase.auth().currentUser.email){emailUpdateSuccess();return}showEMailUpdateDailog();var dialog=new mdc.dialog.MDCDialog(document.getElementById("email-update-dialog"));dialog.show();dialog.listen("MDCDialog:accept",function(){document.getElementById("email-update-dialog").remove();profileView(true)});dialog.listen("MDCDialog:cancel",function(){document.getElementById("email-update-dialog").remove()})}function showEMailUpdateDailog(){var aside=document.createElement("aside");aside.className="mdc-dialog mdc-dialog--open";aside.id="email-update-dialog";aside.style.backgroundColor="rgba(0,0,0,0.47)";var surface=document.createElement("div");surface.className="mdc-dialog__surface";surface.style.width="90%";surface.style.height="auto";var header=document.createElement("header");header.className="mdc-dialog__header";var headerText=document.createElement("h2");headerText.className="mdc-dialog__header__title";headerText.textContent="Reminder";header.appendChild(headerText);var section=document.createElement("section");section.className="mdc-dialog__body";section.textContent="Please Set your Email-id";var footer=document.createElement("footer");footer.className="mdc-dialog__footer";var ok=document.createElement("button");ok.type="button";ok.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept";ok.textContent="Okay";ok.style.backgroundColor="#3498db";var canel=document.createElement("button");canel.type="button";canel.className="mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel";canel.textContent="Cancel";canel.style.backgroundColor="#3498db";footer.appendChild(canel);footer.appendChild(ok);surface.appendChild(header);surface.appendChild(section);surface.appendChild(footer);aside.appendChild(surface);document.body.appendChild(aside)}function initFirstLoad(response){if(history.state[0]!=="listView")return;if(response.msg.hasOwnProperty("activity")){if(response.msg.activity.length){getRootRecord().then(function(record){updateEl(response.msg.activity,record)})}}if(response.msg.hasOwnProperty("template")){createActivityIcon()}return}function updateApp(data){if(native.getName()==="Android"){try{AndroidInterface.updateApp(data.msg)}catch(e){var message="Please Install the Latest version from google play store , to Use Growthfile. After Updating the App, close Growthfile and open again ";var title=JSON.parse(data.msg).message;appUpdateDialog(""+message,title)}return}webkit.messageHandlers.updateApp.postMessage("Update App")}function revokeSession(){firebase.auth().signOut().then(function(){}).catch(function(error){handleError({message:"Sign out error",body:error})})}function apiFail(data){if(document.getElementById("send-activity")){document.getElementById("send-activity").style.display="block"}if(document.querySelector("header .mdc-linear-progress")){document.querySelector("header .mdc-linear-progress").remove()}if(document.querySelector(".loader")){document.querySelector(".loader").remove()}if(document.querySelector(".delete-activity")){document.querySelector(".delete-activity").style.display="block"}if(document.querySelector(".undo-delete-loader")){document.querySelector(".undo-delete-loader").style.display="block"}if(document.querySelector(".form-field-status")){if(document.querySelector(".form-field-status").classList.contains("hidden")){document.querySelector(".form-field-status").classList.remove("hidden")}}snacks(data.msg.message)}function urlFromBase64Image(data){if(data.code===200){if(history.state[0]==="profileView"){var selector=document.querySelector("#profile--image-container .profile--loader ");if(selector){selector.remove()}document.getElementById("user-profile--image").src=firebase.auth().currentUser.photoURL;return}}}function officeRemovalSuccess(data){officeRemovalDialog("You have been removed from "+data.msg.join(" & "));var dialog=new mdc.dialog.MDCDialog(document.getElementById("office-removal-dialog"));dialog.show();dialog.listen("MDCDialog:accept",function(){document.getElementById("office-removal-dialog").remove();document.getElementById("app-current-panel").innerHTML="";listView()});return}function androidStopRefreshing(){if(native.getName()==="Android"){try{AndroidInterface.stopRefreshing(true)}catch(e){handleError({message:e.message+" from androidStopRefreshing"})}}}function onErrorMessage(error){var body={"line-number":error.lineno,file:error.filename};handleError({message:error.message+" from apiHandler.js at "+error.lineno,body:body})}function getInputText(selector){return mdc.textField.MDCTextField.attachTo(document.querySelector(selector))}function runRead(value){if(!localStorage.getItem("dbexist"))return;if(value){var key=Object.keys(value)[0];switch(key){case"verifyEmail":emailVerify();break;case"read":requestCreator("Null",value);break;default:requestCreator("Null",value)}return}requestCreator("Null",value)}function removeChildNodes(parent){while(parent.firstChild){parent.removeChild(parent.firstChild)}}