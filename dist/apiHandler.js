importScripts("external/js/moment.min.js");var apiUrl="https://us-central1-growthfilev2-0.cloudfunctions.net/api/",deviceInfo=void 0,currentDevice=void 0;function getTime(){return Date.now()}var requestFunctionCaller={comment:comment,statusChange:statusChange,share:share,update:update,create:create,removeFromOffice:removeFromOffice};function requestHandlerResponse(e,t,n,r){self.postMessage({type:e,code:t,msg:n,params:r})}function sendApiFailToMainThread(e){requestHandlerResponse("apiFail",e.code,e)}function http(i){return new Promise(function(n,r){var o=new XMLHttpRequest;o.open(i.method,i.url,!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Authorization","Bearer "+i.token),o.onreadystatechange=function(){if(4===o.readyState){if(!o.status)return void requestHandlerResponse("android-stop-refreshing",400);if(226<o.status){var e=JSON.parse(o.response),t={res:JSON.parse(o.response),url:i.url,data:i.data,device:currentDevice,message:e.message,code:e.code};return r(t)}o.responseText?n(JSON.parse(o.responseText)):n("success")}},o.send(i.body||null)})}function fetchServerTime(e,n){currentDevice=e.device;var r=JSON.parse(currentDevice);return new Promise(function(t){http({method:"GET",url:apiUrl+"now?deviceId="+r.id+"&appVersion="+r.appVersion+"&os="+r.baseOs+"&registrationToken="+e.registerToken,body:null,token:n.token}).then(function(e){if(console.log(e),e.updateClient){requestHandlerResponse("update-app",200,JSON.stringify({title:"Message",message:"There is a New version of your app available",cancelable:!1,button:{text:"Update",show:!0,clickAction:{redirection:{text:"com.growthfile.growthfileNew",value:!0}}}}),"")}else e.revokeSession?requestHandlerResponse("revoke-session",200):t({ts:e.timestamp,user:n})}).catch(sendApiFailToMainThread)})}function instant(e,t){http({method:"POST",url:apiUrl+"services/logs",body:e,token:t.token}).then(function(e){console.log(e)}).catch(console.log)}function fetchRecord(e,r){return new Promise(function(t){var n=indexedDB.open(e);n.onsuccess=function(e){n.result.transaction("activity").objectStore("activity").get(r).onsuccess=function(e){t(e.target.result)}}})}function putServerTime(o){return new Promise(function(t,e){var r=indexedDB.open(o.user.uid);r.onerror=function(){e(r.error.message)},r.onsuccess=function(){var e=r.result.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(o.user.uid).onsuccess=function(e){var t=e.target.result;t.serverTime=o.ts-Date.now(),n.put(t)},e.oncomplete=function(){t({user:o.user,ts:o.ts})}}})}function comment(n,r){return console.log(n),new Promise(function(e,t){http({method:"POST",url:apiUrl+"activities/comment",body:JSON.stringify(n),token:r.token}).then(function(){e(!0)}).catch(sendApiFailToMainThread)})}function statusChange(n,r){return new Promise(function(t,e){fetchRecord(r.uid,n.activityId).then(function(e){http({method:"PATCH",url:apiUrl+"activities/change-status",body:JSON.stringify(n),token:r.token}).then(function(e){instantUpdateDB(n,"status",r).then(function(){t(!0)}).catch(console.log)}).catch(sendApiFailToMainThread)})})}function share(n,r){return new Promise(function(t,e){http({method:"PATCH",url:apiUrl+"activities/share",body:JSON.stringify(n),token:r.token}).then(function(e){instantUpdateDB(n,"share",r).then(function(){t(!0)})}).catch(sendApiFailToMainThread)})}function update(n,r){return new Promise(function(t,e){http({method:"PATCH",url:apiUrl+"activities/update",body:JSON.stringify(n),token:r.token}).then(function(e){instantUpdateDB(n,"update",r).then(function(){t(!0)})}).catch(sendApiFailToMainThread)})}function create(n,r){return console.log(n),new Promise(function(t,e){http({method:"POST",url:apiUrl+"activities/create",body:JSON.stringify(n),token:r.token}).then(function(e){t(!0)}).catch(sendApiFailToMainThread)})}function removeFromOffice(e){removeActivity(e).then(function(e){return removeFromListAndChildren(e)}).then(function(e){return removeFromMapAndCalendar(e)}).then(function(e){return removeFromSubscriptions(e)}).catch(function(e){throw new Error(e)}).catch(function(e){console.log(e),instant(JSON.stringify({message:Error}))})}function removeActivity(s){return new Promise(function(r,o){var i=indexedDB.open(s.user.uid);i.onsuccess=function(){var e=i.result.transaction(["activity"],"readwrite"),t=e.objectStore("activity").index("office"),n=[];t.openCursor(s.body.office).onsuccess=function(e){var t=e.target.result;t&&(n.push(t.value.activityId),t.delete().onsuccess=function(){t.continue()})},e.oncomplete=function(){r({param:s,ids:n})},e.onerror=function(){o({message:e.error.message})}},i.onerror=function(){o({message:i.error.message})}})}function removeFromListAndChildren(s){return new Promise(function(r,o){var i=indexedDB.open(s.param.user.uid);i.onsuccess=function(){var e=i.result.transaction(["list","children"],"readwrite"),t=e.objectStore("list"),n=e.objectStore("children");s.ids.forEach(function(e){t.delete(e),n.delete(e)}),e.oncomplete=function(){r(s)},e.onerror=function(){o({message:e.error.message})}},i.onerror=function(){o({message:i.error.message})}})}function removeFromMapAndCalendar(s){return new Promise(function(r,o){var i=indexedDB.open(Response.param.user.uid);i.onsuccess=function(){var e=i.result.transaction(["map","calendar"],"readwrite"),t=e.objectStore("map"),n=e.objectStore("calendar");deleteByIndex(t,s.ids),deleteByIndex(n,s.ids),e.oncomplete=function(){r(s)},e.onerror=function(){o({message:e.error.message})}},i.onerror=function(){o({message:i.error.message})}})}function removeFromSubscriptions(r){return new Promise(function(e,t){var n=indexedDB.open(r.param.user.uid);n.onsuccess=function(){var e=n.result.transaction(["subscriptions"],"readwrite");e.objectStore("subscriptions").index("office").openCursor(r.body.office).onsuccess=function(e){var t=e.target.result;if(t){t.delete();t.continue()}},e.oncomplete=function(){}}})}function getUrlFromPhoto(e,t){http({method:"POST",url:apiUrl+"services/images",body:JSON.stringify(e),token:t.token}).then(function(e){requestHandlerResponse("backblazeRequest",200)}).catch(sendApiFailToMainThread)}function instantUpdateDB(i,s,e){return new Promise(function(t,n){var o=indexedDB.open(e.uid);o.onsuccess=function(){var e=o.result.transaction(["activity"],"readwrite"),r=e.objectStore("activity");r.get(i.activityId).onsuccess=function(e){var t=e.target.result;if(t.editable=0,"share"===s&&(i.share.forEach(function(e){t.assignees.push(e)}),r.put(t)),"update"===s){t.schedule=i.schedule,t.attachment=i.attachment;for(var n=0;n<t.venue.length;n++)t.venue[n].geopoint={_latitude:i.venue[n].geopoint._latitude,_longitude:i.venue[n].geopoint._longitude};r.put(t)}"status"===s&&(t[s]=i[s],r.put(t))},e.oncomplete=function(){t(!0)},e.onerror=function(){n(!0)}}})}function updateMap(r,o){var t=indexedDB.open(o.user.uid);t.onsuccess=function(){var n=t.result,e=n.transaction(["map"],"readwrite");e.objectStore("map").index("activityId").openCursor(r.activityId).onsuccess=function(e){var t=e.target.result;if(t){var n=t.delete();t.continue(),n.onerror=function(){instant({message:n.error.message})}}},e.oncomplete=function(){var e=n.transaction(["map"],"readwrite"),t=e.objectStore("map");"check-in"!==r.template&&r.venue.forEach(function(e){t.add({activityId:r.activityId,latitude:e.geopoint._latitude,longitude:e.geopoint._longitude,location:e.location.toLowerCase(),template:r.template,address:e.address.toLowerCase(),venueDescriptor:e.venueDescriptor,status:r.status,office:r.office,hidden:r.hidden})}),e.onerror=function(){instant(JSON.stringify({message:""+e.error.message}),o.user)}},e.onerror=function(){instant(JSON.stringify({message:""+e.error.message}),o.user)}}}function updateCalendar(o,n){var r=indexedDB.open(n.user.uid);r.onsuccess=function(){var e=r.result,t=e.transaction(["calendar"],"readwrite");t.objectStore("calendar").index("activityId").openCursor(o.activityId).onsuccess=function(e){var t=e.target.result;if(t){var n=t.delete();n.onerror=function(){instant({message:n.error.message})},t.continue()}},t.oncomplete=function(){var r=e.transaction(["calendar"],"readwrite").objectStore("calendar");o.schedule.forEach(function(e){var t=moment(e.startTime).toDate(),n=moment(e.endTime).toDate();r.add({activityId:o.activityId,scheduleName:e.name,timestamp:o.timestamp,template:o.template,hidden:o.hidden,start:moment(t).format("YYYY-MM-DD"),end:moment(n).format("YYYY-MM-DD"),status:o.status,office:o.office})}),t.onerror=function(){instant(JSON.stringify({message:""+t.error.message}),n.user)}}}}function putAttachment(r,o){var i=indexedDB.open(o.user.uid);i.onsuccess=function(){var e=i.result.transaction(["children"],"readwrite"),t=e.objectStore("children"),n={activityId:r.activityId,status:r.status,template:r.template,office:r.office,attachment:r.attachment};t.put(n),e.onerror=function(){instant(JSON.stringify({message:""+e.error.message}),o.user)}}}function putAssignessInStore(e,t){var r=indexedDB.open(t.user.uid);r.onsuccess=function(){var n=r.result.transaction(["users"],"readwrite").objectStore("users");e.forEach(function(t){n.get(t).onsuccess=function(e){e.target.result||n.put({mobile:t,displayName:"",photoURL:""})}})}}function removeUserFromAssigneeInActivity(e,t){if(t.length){var n=e.transaction(["activity"],"readwrite"),o=n.objectStore("activity");t.forEach(function(r){o.get(r.id).onsuccess=function(e){var t=e.target.result;if(t){var n=t.assignees.indexOf(r.user);-1<n&&(t.assignees.splice(n,1),o.put(t))}}}),n.oncomplete=function(){console.log("user removed from assignee in activity where he once was if that activity existed")}}}function removeActivityFromDB(e,t,n){if(t.length){var r=e.transaction(["activity","list","children"],"readwrite"),o=r.objectStore("activity"),i=r.objectStore("list"),s=r.objectStore("children");t.forEach(function(e){o.delete(e),i.delete(e),s.delete(e)}),r.oncomplete=function(){mapAndCalendarRemovalRequest(activitiesToRemove,n)}}}function mapAndCalendarRemovalRequest(r,e){var o=indexedDB.open(e.user.uid);o.onsuccess=function(){var e=o.result.transaction(["calendar","map"],"readwrite"),t=e.objectStore("calendar").index("activityId"),n=e.objectStore("map").index("activityId");deleteByIndex(t,r),deleteByIndex(n,r),e.oncomplete=function(){console.log("activity is removed from all stores")},e.onerror=function(){instant({message:transaction.error.message})}}}function deleteByIndex(e,n){e.openCursor().onsuccess=function(e){var t=e.target.result;t&&(-1<n.indexOf(t.key)&&t.delete(),t.continue())}}function updateSubscription(e,s,t){return new Promise(function(n,o){if(s.length){var i=indexedDB.open(t.user.uid);i.onsuccess=function(){var e=i.result.transaction(["subscriptions"],"readwrite"),r=e.objectStore("subscriptions"),t=r.index("template");s.forEach(function(n){t.openCursor(n.template).onsuccess=function(e){var t=e.target.result;t?(n.office===t.value.office?t.update(n):t.put(n),t.continue()):r.put(n)}}),e.oncomplete=function(){n(!0)},e.onerror=function(){o({message:""+e.error.message})}}}else n(!0)})}function deleteTemplateInSubscription(e){}function createListStore(s,a,t){return new Promise(function(o,e){var i=indexedDB.open(t.user.uid);i.onsuccess=function(){var t=i.result,e=t.transaction(["users"]),n=e.objectStore("users"),r={activityId:s.activityId,secondLine:"",count:a[s.activityId],timestamp:s.timestamp,creator:{number:s.creator,photo:""},activityName:s.activityName,status:s.status};n.get(s.creator).onsuccess=function(e){var t=e.target.result;t&&(r.creator.photo=t.photoURL)},e.oncomplete=function(){var e=t.transaction(["list"],"readwrite"),n=e.objectStore("list");n.get(s.activityId).onsuccess=function(e){var t=e.target.result;r.createdTime=t?t.createdTime:s.timestamp,n.put(r)},e.oncomplete=function(){o(!0)}}}})}function successResponse(s,a){var c=indexedDB.open(a.user.uid),u=[],d=[];c.onsuccess=function(){var e=c.result,n=e.transaction("addendum","readwrite").objectStore("addendum"),r=e.transaction(["activity","addendum"],"readwrite").objectStore("activity"),o={};s.addendum.forEach(function(e){if(e.unassign&&(e.user==a.user.phoneNumber?u.push(e.activityId):d.push({id:e.activityId,user:e.user})),e.isComment){var t=e.activityId;o[t]=(o[t]||0)+1}n.add(e)}),removeActivityFromDB(e,u,a),removeUserFromAssigneeInActivity(e,d,a);for(var t=function(e){var t=s.activities[e];t.canEdit?t.editable=1:t.editable=0,r.put(t),updateMap(t,a),updateCalendar(t,a),putAssignessInStore(t.assignees,a),putAttachment(t,a),0===t.hidden&&createListStore(t,o,a).then(function(){20<=s.activities.length?s.activities.length-e<=20&&requestHandlerResponse("initFirstLoad",200,{activity:[t]}):requestHandlerResponse("initFirstLoad",200,{activity:[t]})})},i=s.activities.length;i--;)t(i);updateRoot(a,s).then(function(){updateSubscription(e,s.templates,a).then(function(){requestHandlerResponse("initFirstLoad",200,{template:!0})}).catch(function(e){instant(JSON.stringify(e),a.user),requestHandlerResponse("initFirstLoad",200,{template:!0})})}),getUniqueOfficeCount(a).then(function(e){setUniqueOffice(e,a).then(console.log).catch(function(e){instant(JSON.stringify(e),a.user)})}).catch(function(e){instant(JSON.stringify(e),a.user)}),createUsersApiUrl(e,a.user).then(updateUserObjectStore).catch(function(e){instant(JSON.stringify(e),a.user)})}}function createUsersApiUrl(i,s){return new Promise(function(e){var t=i.transaction(["users"],"readwrite"),n=t.objectStore("users"),r="",o=apiUrl+"services/users?q=";n.openCursor().onsuccess=function(e){var t=e.target.result;if(t){var n="%2B"+t.value.mobile+"&q=";r+=""+n.replace("+",""),t.continue()}},t.oncomplete=function(){e({db:i,url:""+o+r,user:s})},t.onerror=function(){reject({message:t.error.message})}})}function updateUserObjectStore(t){http({method:"GET",url:t.url,data:null,token:t.user.token}).then(function(r){if(Object.keys(r).length){var e=t.db.transaction(["users"],"readwrite"),o=e.objectStore("users");o.openCursor().onsuccess=function(e){var t=e.target.result;if(t&&r.hasOwnProperty(t.primaryKey)){if(r[t.primaryKey].displayName&&r[t.primaryKey].photoURL){var n=t.value;n.photoURL=r[t.primaryKey].photoURL,n.displayName=r[t.primaryKey].displayName,o.put(n)}t.continue()}},e.oncomplete=function(){},e.onerror=function(){instant(JSON.stringify({message:""+e.error.message}),param.user)}}}).catch(function(e){console.log(e)})}function updateRoot(i,s){return new Promise(function(t,r){var o=indexedDB.open(i.user.uid);o.onsuccess=function(){var e=o.result.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(i.user.uid).onsuccess=function(e){var t=e.target.result;t.fromTime=s.upto,n.put(t)},e.oncomplete=function(){t(!0)},e.onerror=function(){r(e.error.message)}}})}function getUniqueOfficeCount(i){return new Promise(function(t,n){var e=i.user.uid,r=indexedDB.open(e),o=[];r.onsuccess=function(){var e=r.result.transaction(["activity"]);e.objectStore("activity").index("office").openCursor(null,"nextunique").onsuccess=function(e){var t=e.target.result;t&&(o.push(t.value.office),t.continue())},e.oncomplete=function(){t(o)},e.onerror=function(){n({message:e.error.message})},r.onerror=function(){n({message:r.error.message})}}})}function setUniqueOffice(s,e){return new Promise(function(t,r){var o=e.user.uid,i=indexedDB.open(o);i.onsuccess=function(){var e=i.result.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(o).onsuccess=function(e){var t=e.target.result;t.offices=s,n.put(t)},e.oncomplete=function(){t(!0)},e.onerror=function(){r({message:e.error.message})}}})}function updateIDB(o){var i=indexedDB.open(o.user.uid);i.onsuccess=function(){var e=i.result.transaction(["root"]),t=e.objectStore("root"),n=void 0,r=void 0;t.get(o.user.uid).onsuccess=function(e){n=e.target.result,r=n.fromTime},e.oncomplete=function(){http({method:"GET",url:apiUrl+"read?from="+r,data:null,token:o.user.token}).then(function(e){e&&(requestHandlerResponse("android-stop-refreshing",200),successResponse(e,o))}).catch(sendApiFailToMainThread)}}}self.onmessage=function(e){"now"!==e.data.type?"instant"!==e.data.type?"Null"!==e.data.type?"backblaze"!==e.data.type?requestFunctionCaller[e.data.type](e.data.body,e.data.user).then(function(e){e&&requestHandlerResponse("notification",200,"status changed successfully")}).catch(function(e){console.log(e)}):getUrlFromPhoto(e.data.body,e.data.user):updateIDB({user:e.data.user}):instant(e.data.body,e.data.user):fetchServerTime(e.data.body,e.data.user).then(putServerTime).then(updateIDB).catch(console.log)};