importScripts("https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js");var deviceInfo=void 0,currentDevice=void 0;function getTime(){return Date.now()}var requestFunctionCaller={dm:comment,statusChange:statusChange,share:share,update:update,create:create,backblaze:backblaze,updateAuth:updateAuth};function sendSuccessRequestToMainThread(e,t){self.postMessage({response:e,success:!0})}function sendErrorRequestToMainThread(e){self.postMessage({response:e,success:!1})}function http(s){return new Promise(function(n,o){var r=new XMLHttpRequest;r.open(s.method,s.url,!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Authorization","Bearer "+s.token),r.onreadystatechange=function(){if(4===r.readyState){if(!r.status||226<r.status){var e=JSON.parse(r.response),t={res:JSON.parse(r.response),url:s.url,data:s.data,device:currentDevice,message:e.message,code:e.code};return o(t)}r.responseText?n(JSON.parse(r.responseText)):n("success")}},r.send(s.body||null)})}function fetchServerTime(a,i,c){return new Promise(function(e,t){currentDevice=a.device;var n=JSON.parse(currentDevice),o=i.apiUrl+"now?deviceId="+n.id+"&appVersion="+n.appVersion+"&os="+n.baseOs+"&deviceBrand="+n.deviceBrand+"&deviceModel="+n.deviceModel+"&registrationToken="+a.registerToken,r=c.transaction(["root"],"readwrite"),s=r.objectStore("root");s.get(i.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved&&(t.officesRemoved.forEach(function(e){o=o+"&removeFromOffice="+e.replace(" ","%20")}),delete t.officesRemoved),t.venuesSet&&(o+="&venues=true",delete t.venuesSet),s.put(t))},r.oncomplete=function(){http({method:"GET",url:o,body:null,token:i.user.token}).then(e).catch(t)}})}function instant(e,t){http({method:"POST",url:t.apiUrl+"services/logs",body:e,token:t.user.token}).then(function(e){console.log(e)}).catch(console.log)}function putServerTime(r){return console.log(r),new Promise(function(e,t){var n=r.db.transaction(["root"],"readwrite"),o=n.objectStore("root");o.get(r.meta.user.uid).onsuccess=function(e){var t=e.target.result;t.serverTime=r.ts-Date.now(),o.put(t)},n.oncomplete=function(){e({meta:r.meta,db:r.db})}})}function comment(e,t){return console.log(e),http({method:"POST",url:t.apiUrl+"dm",body:JSON.stringify(e),token:t.user.token})}function statusChange(e,t){return http({method:"PATCH",url:t.apiUrl+"activities/change-status",body:JSON.stringify(e),token:t.user.token})}function share(e,t){var n={method:"PATCH",url:t.apiUrl+"activities/share",body:JSON.stringify(e),token:t.user.token};return http(n)}function update(e,t){return http({method:"PATCH",url:t.apiUrl+"activities/update",body:JSON.stringify(e),token:t.user.token})}function create(e,t){return http({method:"POST",url:t.apiUrl+"activities/create",body:JSON.stringify(e),token:t.user.token})}function removeFromOffice(r,s,a){return new Promise(function(t,o){var e=a.transaction(["map","calendar","children","list","subscriptions","activity"],"readwrite");e.oncomplete=function(){var e=a.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(s.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved=r,n.put(t))},e.oncomplete=function(){console.log("run read after removal"),t({response:"Office Removed",success:!0})},e.onerror=function(e){o({response:e,success:!1})}},e.onerror=function(){console.log(tx.error)},removeActivity(r,e)})}function removeActivity(e,t){var n=t.objectStore("activity").index("office"),o=t.objectStore("list").index("office"),r=t.objectStore("children").index("office"),s=t.objectStore("map").index("office"),a=t.objectStore("calendar").index("office"),i=t.objectStore("subscriptions").index("office");e.forEach(function(e){removeByIndex(n,e),removeByIndex(o,e),removeByIndex(r,e),removeByIndex(s,e),removeByIndex(a,e),removeByIndex(i,e)})}function removeByIndex(e,t){e.openCursor(t).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}}function updateAuth(e,t){return http({method:"POST",url:t.apiUrl+"update-auth",body:JSON.stringify(e),token:t.user.token})}function backblaze(e,t){return http({method:"POST",url:t.apiUrl+"services/images",body:JSON.stringify(e),token:t.user.token})}function instantUpdateDB(s,a,e){return new Promise(function(t,n){var r=indexedDB.open(e.uid);r.onsuccess=function(){var e=r.result.transaction(["activity"],"readwrite"),o=e.objectStore("activity");o.get(s.activityId).onsuccess=function(e){var t=e.target.result;if(t.editable=0,"share"===a&&(s.share.forEach(function(e){t.assignees.push(e)}),o.put(t)),"update"===a){t.schedule=s.schedule,t.attachment=s.attachment;for(var n=0;n<t.venue.length;n++)t.venue[n].geopoint={_latitude:s.venue[n].geopoint.latitude,_longitude:s.venue[n].geopoint.longitude};o.put(t)}"status"===a&&(t[a]=s[a],o.put(t))},e.oncomplete=function(){t(!0)},e.onerror=function(){n(!0)}}})}function updateMap(o,e){var r=e.objectStore("map"),t=r.index("activityId");o.activityId&&(t.openCursor(o.activityId).onsuccess=function(e){var t=e.target.result;if(t){var n=t.delete();n.onsuccess=function(){t.continue()},n.onerror=function(){instant({message:n.error.message})}}else r.add(o)})}function updateCalendar(o,e){var r=e.objectStore("calendar");r.index("activityId").openCursor(o.activityId).onsuccess=function(e){var t=e.target.result;if(t){var n=t.delete();n.onsuccess=function(){console.log("remove calendar"),t.continue()},n.onerror=function(){instant({message:n.error.message})}}else o.schedule.forEach(function(e){e.startTime,e.endTime;var t={activityId:o.activityId,scheduleName:e.name,timestamp:o.timestamp,template:o.template,hidden:o.hidden,start:e.startTime,end:e.endTime,status:o.status,office:o.office};r.add(t)})}}function putAttachment(e,t,n){var o=t.objectStore("children"),r={activityId:e.activityId,status:e.status,template:e.template,office:e.office,attachment:e.attachment},s=n.user.phoneNumber;"employee"===e.template&&(r.employee=e.attachment["Employee Contact"].value,e.attachment["First Supervisor"].value!==s&&e.attachment["Second Supervisor"].value!==s||(r.team=1)),o.put(r)}function removeUserFromAssigneeInActivity(e,t){if(t.length){var n=e.transaction(["activity"],"readwrite"),r=n.objectStore("activity");t.forEach(function(o){r.get(o.id).onsuccess=function(e){var t=e.target.result;if(t){var n=t.assignees.indexOf(o.user);-1<n&&(t.assignees.splice(n,1),r.put(t))}}}),n.oncomplete=function(){console.log("user removed from assignee in activity where he once was if that activity existed")}}}function removeActivityFromDB(e,t,n){if(t.length){var o=e.transaction(["activity","list","children"],"readwrite"),r=o.objectStore("activity"),s=o.objectStore("list"),a=o.objectStore("children");t.forEach(function(e){r.delete(e),s.delete(e),a.delete(e)}),o.oncomplete=function(){mapAndCalendarRemovalRequest(activitiesToRemove,n)}}}function mapAndCalendarRemovalRequest(o,e){var r=indexedDB.open(e.user.uid);r.onsuccess=function(){var e=r.result.transaction(["calendar","map"],"readwrite"),t=e.objectStore("calendar").index("activityId"),n=e.objectStore("map").index("activityId");deleteByIndex(t,o),deleteByIndex(n,o),e.oncomplete=function(){console.log("activity is removed from all stores")},e.onerror=function(){instant({message:transaction.error.message})}}}function deleteByIndex(t,e){e.forEach(function(e){t.openCursor(e).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}})}function updateSubscription(n,e){var o=0,r=e.objectStore("subscriptions");r.index("officeTemplate").openCursor([n.office,n.template]).onsuccess=function(e){var t=e.target.result;if(!t)return n.count=o,void r.put(n);t.value.count&&(o=t.value.count),t.delete().onsuccess=function(){console.log("deleted"),t.continue()}}}function createListStore(n,e){var o={activityId:n.activityId,timestamp:n.timestamp,activityName:n.activityName,status:n.status},r=e.objectStore("list");r.get(n.activityId).onsuccess=function(e){var t=e.target.result;o.createdTime=t?t.createdTime:n.timestamp,r.put(o)}}function successResponse(e,r,t,n,o){var s=[],a=[],i=t.transaction(["map","calendar","children","list","subscriptions","activity","addendum","root","users"],"readwrite"),c=i.objectStore("addendum"),u=i.objectStore("activity"),d=i.objectStore("users"),m={},f={};e.addendum.forEach(function(e){e.unassign&&(e.user==r.user.phoneNumber?s.push(e.activityId):a.push({id:e.activityId,user:e.user})),e.isComment?(e.assignee===r.user.phoneNumber?(e.key=r.user.phoneNumber+e.user,f[e.user]=e,m[e.user]?m[e.user]:m[e.user]=1):(e.key=r.user.phoneNumber+e.assignee,f[e.assignee]=e,m[e.assignee]?m[e.assignee]:m[e.assignee]=1),c.add(e)):(f[e.user]=e,m[e.user]?m[e.user]:m[e.user]=1)}),removeActivityFromDB(t,s,r),removeUserFromAssigneeInActivity(t,a,r),e.locations&&e.locations.forEach(function(e){updateMap(e,i)}),e.activities.slice().reverse().forEach(function(e){e.canEdit,e.editable,u.put(e),updateCalendar(e,i),putAttachment(e,i,r),e.assignees.forEach(function(n){d.get(n.phoneNumber).onsuccess=function(e){var t=e.target.result;t||(t={}),t.mobile=n.phoneNumber,t.displayName=n.displayName,t.photoURL=n.photoURL,t.NAME_SEARCH=n.displayName.toLowerCase(),t.timestamp||(t.timestamp=""),d.put(t)}})}),Object.keys(f).forEach(function(n){var o=f[n],e=o.activityId;console.log(m),e?u.get(e).onsuccess=function(e){var t=e.target.result;t&&t.assignees.forEach(function(e){o.key=r.user.phoneNumber+e.phoneNumber,c.put(o),n!==r.user.phoneNumber?n!==e.phoneNumber||(d.get(n).onsuccess=function(e){var t=e.target.result;t&&(t.comment=o.comment,t.timestamp=o.timestamp,t.count?t.count+=m[n]:t.count=m[n],d.put(t))}):d.get(e.phoneNumber).onsuccess=function(e){var t=e.target.result;t&&(t.comment=o.comment,t.timestamp=o.timestamp,t.count?t.count+=m[n]:t.count=m[n],d.put(t))}})}:d.get(n).onsuccess=function(e){var t=e.target.result;t&&(t.comment=o.comment,t.timestamp=o.timestamp,t.count?t.count+=m[n]:t.count=m[n],d.put(t))}}),e.templates.forEach(function(e){updateSubscription(e,i)}),updateRoot(e,i,r.user.uid),i.oncomplete=function(){return console.log("all completed"),n(e)},i.onerror=function(){return o(i.error)}}function updateRoot(n,e,t){var o=e.objectStore("root");o.get(t).onsuccess=function(e){var t=e.target.result;t.fromTime=n.upto,console.log("start adding upto"),o.put(t)}}function updateIDB(a){return new Promise(function(t,n){var e=a.db.transaction(["root"]),o=e.objectStore("root"),r=void 0,s=void 0;o.get(a.meta.user.uid).onsuccess=function(e){r=e.target.result,s=r.fromTime},e.oncomplete=function(){http({method:"GET",url:a.meta.apiUrl+"read?from="+s,data:null,token:a.meta.user.token}).then(function(e){return successResponse(e,a.meta,a.db,t,n)}).catch(function(e){return n(e)})}})}self.onmessage=function(s){var e=indexedDB.open(s.data.meta.user.uid);e.onsuccess=function(){var o=e.result;if("now"!==s.data.type)"instant"!==s.data.type?"Null"!==s.data.type?requestFunctionCaller[s.data.type](s.data.body,s.data.meta).then(sendSuccessRequestToMainThread).catch(sendErrorRequestToMainThread):updateIDB({meta:s.data.meta,db:o}).then(sendSuccessRequestToMainThread).catch(sendErrorRequestToMainThread):instant(s.data.body,s.data.meta);else{var r="";fetchServerTime(s.data.body,s.data.meta,o).then(function(t){var e=o.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(s.data.meta.user.uid).onsuccess=function(e){(r=e.target.result).serverTime=t.timestamp-Date.now(),n.put(r)},e.oncomplete=function(){t.removeFromOffice?Array.isArray(t.removeFromOffice)&&t.removeFromOffice.length&&removeFromOffice(t.removeFromOffice,s.data.meta,o).then(sendSuccessRequestToMainThread).catch(sendErrorRequestToMainThread):self.postMessage({response:t,success:!0})}}).catch(sendErrorRequestToMainThread)}},e.onerror=function(){}};