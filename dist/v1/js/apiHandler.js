importScripts("https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js");var deviceInfo=void 0,currentDevice=void 0;function getTime(){return Date.now()}var requestFunctionCaller={comment:comment,statusChange:statusChange,share:share,update:update,create:create};function requestHandlerResponse(e,t,n,o){self.postMessage({type:e,code:t,msg:n,params:o})}function sendApiFailToMainThread(e){requestHandlerResponse("apiFail",e.code,e)}function http(i){return new Promise(function(n,o){var r=new XMLHttpRequest;r.open(i.method,i.url,!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Authorization","Bearer "+i.token),r.onreadystatechange=function(){if(4===r.readyState){if(!r.status)return;if(226<r.status){var e=JSON.parse(r.response),t={res:JSON.parse(r.response),url:i.url,data:i.data,device:currentDevice,message:e.message,code:e.code};return o(t)}r.responseText?n(JSON.parse(r.responseText)):n("success")}},r.send(i.body||null)})}function fetchServerTime(n,i){return new Promise(function(t){currentDevice=n.device;var e=JSON.parse(currentDevice),o=i.apiUrl+"now?deviceId="+e.id+"&appVersion="+e.appVersion+"&os="+e.baseOs+"&deviceBrand="+e.deviceBrand+"&deviceModel="+e.deviceModel+"&registrationToken="+n.registerToken,r=indexedDB.open(i.user.uid);r.onsuccess=function(){var e=r.result.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(i.user.uid).onsuccess=function(e){var t=e.target.result;t&&t.hasOwnProperty("officesRemoved")&&t.officesRemoved&&(t.officesRemoved.forEach(function(e){o=o+"&removeFromOffice="+e.replace(" ","%20")}),delete t.officesRemoved,n.put(t))},e.oncomplete=function(){http({method:"GET",url:o,body:null,token:i.user.token}).then(function(e){e.updateClient?requestHandlerResponse("update-app",200):e.revokeSession?requestHandlerResponse("revoke-session",200):(e.hasOwnProperty("removeFromOffice")&&Array.isArray(e.removeFromOffice)&&e.removeFromOffice.length&&removeFromOffice(e.removeFromOffice,i.user),t({ts:e.timestamp,meta:i}))}).catch(sendApiFailToMainThread)}}})}function instant(e,t){http({method:"POST",url:t.apiUrl+"services/logs",body:e,token:t.user.token}).then(function(e){console.log(e)}).catch(console.log)}function putServerTime(r){return console.log(r),new Promise(function(t,e){var o=indexedDB.open(r.meta.user.uid);o.onerror=function(){e(o.error.message)},o.onsuccess=function(){var e=o.result.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(r.meta.user.uid).onsuccess=function(e){var t=e.target.result;t.serverTime=r.ts-Date.now(),n.put(t)},e.oncomplete=function(){t(r.meta)}}})}function comment(n,o){return console.log(n),new Promise(function(e,t){http({method:"POST",url:o.apiUrl+"activities/comment",body:JSON.stringify(n),token:o.user.token}).then(function(){e(!0)}).catch(sendApiFailToMainThread)})}function statusChange(n,o){return new Promise(function(t,e){http({method:"PATCH",url:o.apiUrl+"activities/change-status",body:JSON.stringify(n),token:o.user.token}).then(function(e){instantUpdateDB(n,"status",o.user).then(function(){t(!0)}).catch(console.log)}).catch(sendApiFailToMainThread)})}function share(n,o){return new Promise(function(t,e){http({method:"PATCH",url:o.apiUrl+"activities/share",body:JSON.stringify(n),token:o.user.token}).then(function(e){t(!0)}).catch(sendApiFailToMainThread)})}function update(n,o){return new Promise(function(t,e){http({method:"PATCH",url:o.apiUrl+"activities/update",body:JSON.stringify(n),token:o.user.token}).then(function(e){instantUpdateDB(n,"update",o.user).then(function(){t(!0)})}).catch(sendApiFailToMainThread)})}function create(e,n){console.log(e);var o=[];return e.forEach(function(e){var t={method:"POST",url:n.apiUrl+"activities/create",body:JSON.stringify(e),token:n.user.token};o.push(http(t))}),new Promise(function(e,t){o.length&&Promise.all(o).then(function(){e(!0)}).catch(sendApiFailToMainThread)})}function removeFromOffice(e,t){removeActivity(e,t).then(function(e){return removeFromListAndChildren(e)}).then(function(e){return removeFromMapAndCalendar(e)}).then(function(e){return removeFromSubscriptions(e)}).catch(function(e){instant(JSON.stringify({message:e}))})}function removeActivity(a,s){return new Promise(function(o,r){var i=indexedDB.open(s.uid);i.onsuccess=function(){var e=i.result.transaction(["activity"],"readwrite"),t=e.objectStore("activity").index("office"),n=[];a.forEach(function(e){t.openCursor(e).onsuccess=function(e){var t=e.target.result;t&&(n.push(t.value.activityId),t.delete().onsuccess=function(){t.continue()})}}),e.oncomplete=function(){o({offices:a,ids:n,user:s})},e.onerror=function(){r({message:e.error.message})}},i.onerror=function(){r({message:i.error.message})}})}function removeFromListAndChildren(a){return new Promise(function(o,r){var i=indexedDB.open(a.user.uid);i.onsuccess=function(){var e=i.result.transaction(["list","children"],"readwrite"),t=e.objectStore("list"),n=e.objectStore("children");a.ids.forEach(function(e){t.delete(e),n.delete(e)}),e.oncomplete=function(){o(a)},e.onerror=function(){r({message:e.error.message})}},i.onerror=function(){r({message:i.error.message})}})}function removeFromMapAndCalendar(a){return new Promise(function(o,r){var i=indexedDB.open(a.user.uid);i.onsuccess=function(){var e=i.result.transaction(["map","calendar"],"readwrite"),t=e.objectStore("map").index("activityId"),n=e.objectStore("calendar").index("activityId");deleteByIndex(t,a.ids),deleteByIndex(n,a.ids),e.oncomplete=function(){o(a)},e.onerror=function(){r({message:e.error.message})}},i.onerror=function(){r({message:i.error.message})}})}function removeFromSubscriptions(o){var r=indexedDB.open(o.user.uid);r.onsuccess=function(){var t=r.result,e=t.transaction(["subscriptions"],"readwrite"),n=e.objectStore("subscriptions").index("office");o.offices.forEach(function(e){n.openCursor(e).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}}),e.oncomplete=function(){var e=t.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(o.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved=o.offices,n.put(t))},e.oncomplete=function(){requestHandlerResponse("removed-from-office",200,o.offices)},e.onerror=function(){instant({message:e.error.message})}},e.onerror=function(){instant({message:e.error.message})}}}function getUrlFromPhoto(e,t){http({method:"POST",url:t.apiUrl+"services/images",body:JSON.stringify(e),token:t.user.token}).then(function(e){requestHandlerResponse("notification",200)}).catch(sendApiFailToMainThread)}function instantUpdateDB(i,a,e){return new Promise(function(t,n){var r=indexedDB.open(e.uid);r.onsuccess=function(){var e=r.result.transaction(["activity"],"readwrite"),o=e.objectStore("activity");o.get(i.activityId).onsuccess=function(e){var t=e.target.result;if(t.editable=0,"share"===a&&(i.share.forEach(function(e){t.assignees.push(e)}),o.put(t)),"update"===a){t.schedule=i.schedule,t.attachment=i.attachment;for(var n=0;n<t.venue.length;n++)t.venue[n].geopoint={_latitude:i.venue[n].geopoint.latitude,_longitude:i.venue[n].geopoint.longitude};o.put(t)}"status"===a&&(t[a]=i[a],o.put(t))},e.oncomplete=function(){t(!0)},e.onerror=function(){n(!0)}}})}function updateMap(o,e){if("check-in"!==o.template){var r=e.objectStore("map");r.index("activityId").openCursor(o.activityId).onsuccess=function(e){var t=e.target.result;if(!t)return console.log("start adding"),o.venue.forEach(function(e){console.log("adding "+o.activityId,"location "+e.location),r.add({activityId:o.activityId,latitude:e.geopoint._latitude,longitude:e.geopoint._longitude,location:e.location,template:o.template,address:e.address,venueDescriptor:e.venueDescriptor,status:o.status,office:o.office,hidden:o.hidden})}),void console.log("finished adding to map");var n=t.delete();n.onsuccess=function(){console.log("deleted "+t.value.activityId),t.continue()},n.onerror=function(){instant({message:n.error.message})}}}}function updateCalendar(o,e){var r=e.objectStore("calendar");r.index("activityId").openCursor(o.activityId).onsuccess=function(e){var t=e.target.result;if(t){var n=t.delete();n.onsuccess=function(){console.log("remove calendar"),t.continue()},n.onerror=function(){instant({message:n.error.message})}}else o.schedule.forEach(function(e){e.startTime,e.endTime;var t={activityId:o.activityId,scheduleName:e.name,timestamp:o.timestamp,template:o.template,hidden:o.hidden,start:e.startTime,end:e.endTime,status:o.status,office:o.office};r.add(t)})}}function putAttachment(e,t,n){var o=t.objectStore("children"),r={activityId:e.activityId,status:e.status,template:e.template,office:e.office,attachment:e.attachment},i=n.user.phoneNumber;"employee"===e.template&&(r.employee=e.attachment["Employee Contact"].value,e.attachment["First Supervisor"].value!==i&&e.attachment["Second Supervisor"].value!==i||(r.team=1)),o.put(r)}function removeUserFromAssigneeInActivity(e,t){if(t.length){var n=e.transaction(["activity"],"readwrite"),r=n.objectStore("activity");t.forEach(function(o){r.get(o.id).onsuccess=function(e){var t=e.target.result;if(t){var n=t.assignees.indexOf(o.user);-1<n&&(t.assignees.splice(n,1),r.put(t))}}}),n.oncomplete=function(){console.log("user removed from assignee in activity where he once was if that activity existed")}}}function removeActivityFromDB(e,t,n){if(t.length){var o=e.transaction(["activity","list","children"],"readwrite"),r=o.objectStore("activity"),i=o.objectStore("list"),a=o.objectStore("children");t.forEach(function(e){r.delete(e),i.delete(e),a.delete(e)}),o.oncomplete=function(){mapAndCalendarRemovalRequest(activitiesToRemove,n)}}}function mapAndCalendarRemovalRequest(o,e){var r=indexedDB.open(e.user.uid);r.onsuccess=function(){var e=r.result.transaction(["calendar","map"],"readwrite"),t=e.objectStore("calendar").index("activityId"),n=e.objectStore("map").index("activityId");deleteByIndex(t,o),deleteByIndex(n,o),e.oncomplete=function(){console.log("activity is removed from all stores")},e.onerror=function(){instant({message:transaction.error.message})}}}function deleteByIndex(t,e){e.forEach(function(e){t.openCursor(e).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}})}function updateSubscription(n,e){var o=0,r=e.objectStore("subscriptions");r.index("officeTemplate").openCursor([n.office,n.template]).onsuccess=function(e){var t=e.target.result;if(!t)return n.count=o,void r.put(n);t.value.count&&(o=t.value.count),t.delete().onsuccess=function(){console.log("deleted"),t.continue()}}}function createListStore(n,e,t){var o={activityId:n.activityId,count:e[n.activityId],timestamp:n.timestamp,activityName:n.activityName,status:n.status},r=t.objectStore("list");r.get(n.activityId).onsuccess=function(e){var t=e.target.result;o.createdTime=t?t.createdTime:n.timestamp,r.put(o)}}function successResponse(a,s){var c=indexedDB.open(s.user.uid),u=[],d=[];c.onsuccess=function(){var e=c.result,t=e.transaction(["map","calendar","children","list","subscriptions","activity","addendum","root","users"],"readwrite"),n=t.objectStore("addendum"),o=t.objectStore("activity"),r=t.objectStore("users"),i={};a.addendum.forEach(function(e){if(e.unassign&&(e.user==s.user.phoneNumber?u.push(e.activityId):d.push({id:e.activityId,user:e.user})),e.isComment){var t=e.activityId;i[t]=(i[t]||0)+1}n.add(e)}),removeActivityFromDB(e,u,s),removeUserFromAssigneeInActivity(e,d,s),a.activities.slice().reverse().forEach(function(e){e.canEdit,e.editable,o.put(e),updateMap(e,t),updateCalendar(e,t),putAttachment(e,t,s),0===e.hidden&&createListStore(e,i,t),e.assignees.forEach(function(e){r.put({displayName:e.displayName,mobile:e.phoneNumber,photoURL:e.photoURL})})}),a.templates.forEach(function(e){updateSubscription(e,t)}),updateRoot(a,t,s.user.uid),t.oncomplete=function(){requestHandlerResponse("initFirstLoad",200),console.log("all completed")}}}function updateRoot(n,e,t){var o=e.objectStore("root");o.get(t).onsuccess=function(e){var t=e.target.result;t.fromTime=n.upto,console.log("start adding upto"),o.put(t)}}function updateIDB(r){var i=indexedDB.open(r.user.uid);i.onsuccess=function(){var e=i.result.transaction(["root"]),t=e.objectStore("root"),n=void 0,o=void 0;t.get(r.user.uid).onsuccess=function(e){n=e.target.result,o=n.fromTime},e.oncomplete=function(){http({method:"GET",url:r.apiUrl+"read?from="+o,data:null,token:r.user.token}).then(function(e){e&&successResponse(e,r)}).catch(sendApiFailToMainThread)}}}self.onmessage=function(e){"now"!==e.data.type?"instant"!==e.data.type?"Null"!==e.data.type?"backblaze"!==e.data.type?requestFunctionCaller[e.data.type](e.data.body,e.data.meta).then(function(e){e&&requestHandlerResponse("notification",200,"status changed successfully")}).catch(function(e){console.log(e)}):getUrlFromPhoto(e.data.body,e.data.meta):updateIDB(e.data.meta):instant(e.data.body,e.data.meta):fetchServerTime(e.data.body,e.data.meta).then(putServerTime).then(updateIDB).catch(console.log)};