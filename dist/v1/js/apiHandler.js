importScripts("https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js");var deviceInfo=void 0,currentDevice=void 0;function getTime(){return Date.now()}var requestFunctionCaller={comment:comment,statusChange:statusChange,share:share,update:update,create:create,backblaze:backblaze};function requestHandlerResponse(e,t,o,n){self.postMessage({type:e,code:t,msg:o,params:n})}function sendApiFailToMainThread(e){requestHandlerResponse("apiFail",e.code,e)}function http(i){return new Promise(function(o,n){var r=new XMLHttpRequest;r.open(i.method,i.url,!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Authorization","Bearer "+i.token),r.onreadystatechange=function(){if(4===r.readyState){if(!r.status)return;if(226<r.status){var e=JSON.parse(r.response),t={res:JSON.parse(r.response),url:i.url,data:i.data,device:currentDevice,message:e.message,code:e.code};return n(t)}r.responseText?o(JSON.parse(r.responseText)):o("success")}},r.send(i.body||null)})}function fetchServerTime(i,a,s){return new Promise(function(t){currentDevice=i.device;var e=JSON.parse(currentDevice),o=a.apiUrl+"now?deviceId="+e.id+"&appVersion="+e.appVersion+"&os="+e.baseOs+"&deviceBrand="+e.deviceBrand+"&deviceModel="+e.deviceModel+"&registrationToken="+i.registerToken,n=s.transaction(["root"],"readwrite"),r=n.objectStore("root");r.get(a.user.uid).onsuccess=function(e){var t=e.target.result;t&&t.hasOwnProperty("officesRemoved")&&t.officesRemoved&&(t.officesRemoved.forEach(function(e){o=o+"&removeFromOffice="+e.replace(" ","%20")}),delete t.officesRemoved,r.put(t))},n.oncomplete=function(){http({method:"GET",url:o,body:null,token:a.user.token}).then(function(e){return t(e)}).catch(function(e){reject(e)})}})}function instant(e,t){http({method:"POST",url:t.apiUrl+"services/logs",body:e,token:t.user.token}).then(function(e){console.log(e)}).catch(console.log)}function putServerTime(r){return console.log(r),new Promise(function(e,t){var o=r.db.transaction(["root"],"readwrite"),n=o.objectStore("root");n.get(r.meta.user.uid).onsuccess=function(e){var t=e.target.result;t.serverTime=r.ts-Date.now(),n.put(t)},o.oncomplete=function(){e({meta:r.meta,db:r.db})}})}function comment(e,t){return console.log(e),http({method:"POST",url:t.apiUrl+"activities/comment",body:JSON.stringify(e),token:t.user.token})}function statusChange(o,n){return new Promise(function(t,e){http({method:"PATCH",url:n.apiUrl+"activities/change-status",body:JSON.stringify(o),token:n.user.token}).then(function(e){t(!0)}).catch(sendApiFailToMainThread)})}function share(e,t){var o={method:"PATCH",url:t.apiUrl+"activities/share",body:JSON.stringify(e),token:t.user.token};return http(o)}function update(e,t){return http({method:"PATCH",url:t.apiUrl+"activities/update",body:JSON.stringify(e),token:t.user.token})}function create(e,t){return http({method:"POST",url:t.apiUrl+"activities/create",body:JSON.stringify(e),token:t.user.token})}function removeFromOffice(n,t,r){var e=r.transaction(["map","calendar","children","list","subscriptions","activity"],"readwrite");e.oncomplete=function(){var e=r.transaction(["root"],"readwrite"),o=e.objectStore("root");o.get(t.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved=n,o.put(t))},e.oncomplete=function(){console.log("run read after removal"),self.postMessage({response:"Office Removed",success:!0})},e.onerror=function(e){self.postMessage({response:e,success:!1})}},e.onerror=function(){console.log(tx.error)},removeActivity(n,e)}function removeActivity(e,t){var o=t.objectStore("activity").index("office"),n=t.objectStore("list").index("office"),r=t.objectStore("children").index("office"),i=t.objectStore("map").index("office"),a=t.objectStore("calendar").index("office"),s=t.objectStore("subscriptions").index("office");e.forEach(function(e){removeByIndex(o,e),removeByIndex(n,e),removeByIndex(r,e),removeByIndex(i,e),removeByIndex(a,e),removeByIndex(s,e)})}function removeByIndex(e,t){e.openCursor(t).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}}function backblaze(e,t){return http({method:"POST",url:t.apiUrl+"services/images",body:JSON.stringify(e),token:t.user.token})}function instantUpdateDB(i,a,e){return new Promise(function(t,o){var r=indexedDB.open(e.uid);r.onsuccess=function(){var e=r.result.transaction(["activity"],"readwrite"),n=e.objectStore("activity");n.get(i.activityId).onsuccess=function(e){var t=e.target.result;if(t.editable=0,"share"===a&&(i.share.forEach(function(e){t.assignees.push(e)}),n.put(t)),"update"===a){t.schedule=i.schedule,t.attachment=i.attachment;for(var o=0;o<t.venue.length;o++)t.venue[o].geopoint={_latitude:i.venue[o].geopoint.latitude,_longitude:i.venue[o].geopoint.longitude};n.put(t)}"status"===a&&(t[a]=i[a],n.put(t))},e.oncomplete=function(){t(!0)},e.onerror=function(){o(!0)}}})}function updateMap(n,e){if("check-in"!==n.template){var r=e.objectStore("map");r.index("activityId").openCursor(n.activityId).onsuccess=function(e){var t=e.target.result;if(!t)return console.log("start adding"),n.venue.forEach(function(e){console.log("adding "+n.activityId,"location "+e.location),r.add({activityId:n.activityId,latitude:e.geopoint._latitude,longitude:e.geopoint._longitude,location:e.location,template:n.template,address:e.address,venueDescriptor:e.venueDescriptor,status:n.status,office:n.office,hidden:n.hidden})}),void console.log("finished adding to map");var o=t.delete();o.onsuccess=function(){console.log("deleted "+t.value.activityId),t.continue()},o.onerror=function(){instant({message:o.error.message})}}}}function updateCalendar(n,e){var r=e.objectStore("calendar");r.index("activityId").openCursor(n.activityId).onsuccess=function(e){var t=e.target.result;if(t){var o=t.delete();o.onsuccess=function(){console.log("remove calendar"),t.continue()},o.onerror=function(){instant({message:o.error.message})}}else n.schedule.forEach(function(e){e.startTime,e.endTime;var t={activityId:n.activityId,scheduleName:e.name,timestamp:n.timestamp,template:n.template,hidden:n.hidden,start:e.startTime,end:e.endTime,status:n.status,office:n.office};r.add(t)})}}function putAttachment(e,t,o){var n=t.objectStore("children"),r={activityId:e.activityId,status:e.status,template:e.template,office:e.office,attachment:e.attachment},i=o.user.phoneNumber;"employee"===e.template&&(r.employee=e.attachment["Employee Contact"].value,e.attachment["First Supervisor"].value!==i&&e.attachment["Second Supervisor"].value!==i||(r.team=1)),n.put(r)}function removeUserFromAssigneeInActivity(e,t){if(t.length){var o=e.transaction(["activity"],"readwrite"),r=o.objectStore("activity");t.forEach(function(n){r.get(n.id).onsuccess=function(e){var t=e.target.result;if(t){var o=t.assignees.indexOf(n.user);-1<o&&(t.assignees.splice(o,1),r.put(t))}}}),o.oncomplete=function(){console.log("user removed from assignee in activity where he once was if that activity existed")}}}function removeActivityFromDB(e,t,o){if(t.length){var n=e.transaction(["activity","list","children"],"readwrite"),r=n.objectStore("activity"),i=n.objectStore("list"),a=n.objectStore("children");t.forEach(function(e){r.delete(e),i.delete(e),a.delete(e)}),n.oncomplete=function(){mapAndCalendarRemovalRequest(activitiesToRemove,o)}}}function mapAndCalendarRemovalRequest(n,e){var r=indexedDB.open(e.user.uid);r.onsuccess=function(){var e=r.result.transaction(["calendar","map"],"readwrite"),t=e.objectStore("calendar").index("activityId"),o=e.objectStore("map").index("activityId");deleteByIndex(t,n),deleteByIndex(o,n),e.oncomplete=function(){console.log("activity is removed from all stores")},e.onerror=function(){instant({message:transaction.error.message})}}}function deleteByIndex(t,e){e.forEach(function(e){t.openCursor(e).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}})}function updateSubscription(o,e){var n=0,r=e.objectStore("subscriptions");r.index("officeTemplate").openCursor([o.office,o.template]).onsuccess=function(e){var t=e.target.result;if(!t)return o.count=n,void r.put(o);t.value.count&&(n=t.value.count),t.delete().onsuccess=function(){console.log("deleted"),t.continue()}}}function createListStore(o,e,t){var n={activityId:o.activityId,count:e[o.activityId],timestamp:o.timestamp,activityName:o.activityName,status:o.status},r=t.objectStore("list");r.get(o.activityId).onsuccess=function(e){var t=e.target.result;n.createdTime=t?t.createdTime:o.timestamp,r.put(n)}}function successResponse(e,o,t,n,r){var i=[],a=[],s=t.transaction(["map","calendar","children","list","subscriptions","activity","addendum","root","users"],"readwrite"),c=s.objectStore("addendum"),u=s.objectStore("activity"),d=s.objectStore("users"),l={};e.addendum.forEach(function(e){if(e.unassign&&(e.user==o.user.phoneNumber?i.push(e.activityId):a.push({id:e.activityId,user:e.user})),e.isComment){var t=e.activityId;l[t]=(l[t]||0)+1}c.add(e)}),removeActivityFromDB(t,i,o),removeUserFromAssigneeInActivity(t,a,o),e.activities.slice().reverse().forEach(function(e){e.canEdit,e.editable,u.put(e),updateMap(e,s),updateCalendar(e,s),putAttachment(e,s,o),0===e.hidden&&createListStore(e,l,s),e.assignees.forEach(function(e){d.put({displayName:e.displayName,mobile:e.phoneNumber,photoURL:e.photoURL})})}),e.templates.forEach(function(e){updateSubscription(e,s)}),updateRoot(e,s,o.user.uid),s.oncomplete=function(){return console.log("all completed"),n(!0)},s.onerror=function(){return r(s.error)}}function updateRoot(o,e,t){var n=e.objectStore("root");n.get(t).onsuccess=function(e){var t=e.target.result;t.fromTime=o.upto,console.log("start adding upto"),n.put(t)}}function updateIDB(a){return new Promise(function(t,o){var e=a.db.transaction(["root"]),n=e.objectStore("root"),r=void 0,i=void 0;n.get(a.meta.user.uid).onsuccess=function(e){r=e.target.result,i=r.fromTime},e.oncomplete=function(){http({method:"GET",url:a.meta.apiUrl+"read?from="+i,data:null,token:a.meta.user.token}).then(function(e){return successResponse(e,a.meta,a.db,t,o)}).catch(function(e){return o(e)})}})}self.onmessage=function(r){var e=indexedDB.open(r.data.meta.user.uid);e.onsuccess=function(){var t=e.result;"now"!==r.data.type?"removeFromOffice"!==r.data.type?"instant"!==r.data.type?"Null"!==r.data.type?requestFunctionCaller[r.data.type](r.data.body,r.data.meta).then(function(e){self.postMessage({response:e,success:!0}),console.log(e)}).catch(function(e){self.postMessage({response:e,success:!1}),console.log(e)}):updateIDB({meta:r.data.meta,db:t}).then(function(e){self.postMessage({response:e,success:!0})}).catch(function(e){self.postMessage({response:e,success:!1})}):instant(r.data.body,r.data.meta):removeFromOffice(r.data.body,r.data.meta,t):fetchServerTime(r.data.body,r.data.meta,t).then(function(o){var e=t.transaction(["root"],"readwrite"),n=e.objectStore("root");n.get(r.data.meta.user.uid).onsuccess=function(e){var t=e.target.result;t.serverTime=o.timestamp-Date.now(),n.put(t)},e.oncomplete=function(){self.postMessage({response:o,success:!0})}})},e.onerror=function(){}};