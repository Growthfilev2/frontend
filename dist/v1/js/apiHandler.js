importScripts("https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js");var deviceInfo=void 0,currentDevice=void 0;function getTime(){return Date.now()}var requestFunctionCaller={comment:comment,statusChange:statusChange,share:share,update:update,create:create,backblaze:backblaze};function sendSuccessRequestToMainThread(e,t){self.postMessage({response:e,success:!0})}function sendErrorRequestToMainThread(e){self.postMessage({response:e,success:!1})}function http(a){return new Promise(function(o,n){var r=new XMLHttpRequest;r.open(a.method,a.url,!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Authorization","Bearer "+a.token),r.onreadystatechange=function(){if(4===r.readyState){if(!r.status)return;if(226<r.status){var e=JSON.parse(r.response),t={res:JSON.parse(r.response),url:a.url,data:a.data,device:currentDevice,message:e.message,code:e.code};return n(t)}r.responseText?o(JSON.parse(r.responseText)):o("success")}},r.send(a.body||null)})}function fetchServerTime(i,s,c){return new Promise(function(e,t){currentDevice=i.device;var o=JSON.parse(currentDevice),n=s.apiUrl+"now?deviceId="+o.id+"&appVersion="+o.appVersion+"&os="+o.baseOs+"&deviceBrand="+o.deviceBrand+"&deviceModel="+o.deviceModel+"&registrationToken="+i.registerToken,r=c.transaction(["root"],"readwrite"),a=r.objectStore("root");a.get(s.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved&&(t.officesRemoved.forEach(function(e){n=n+"&removeFromOffice="+e.replace(" ","%20")}),delete t.officesRemoved),t.venuesSet&&(n+="&venues=true",delete t.venuesSet),a.put(t))},r.oncomplete=function(){http({method:"GET",url:n,body:null,token:s.user.token}).then(e).catch(t)}})}function instant(e,t){http({method:"POST",url:t.apiUrl+"services/logs",body:e,token:t.user.token}).then(function(e){console.log(e)}).catch(console.log)}function putServerTime(r){return console.log(r),new Promise(function(e,t){var o=r.db.transaction(["root"],"readwrite"),n=o.objectStore("root");n.get(r.meta.user.uid).onsuccess=function(e){var t=e.target.result;t.serverTime=r.ts-Date.now(),n.put(t)},o.oncomplete=function(){e({meta:r.meta,db:r.db})}})}function comment(e,t){return console.log(e),http({method:"POST",url:t.apiUrl+"activities/comment",body:JSON.stringify(e),token:t.user.token})}function statusChange(o,n){return new Promise(function(t,e){http({method:"PATCH",url:n.apiUrl+"activities/change-status",body:JSON.stringify(o),token:n.user.token}).then(function(e){t(!0)}).catch(sendApiFailToMainThread)})}function share(e,t){var o={method:"PATCH",url:t.apiUrl+"activities/share",body:JSON.stringify(e),token:t.user.token};return http(o)}function update(e,t){return http({method:"PATCH",url:t.apiUrl+"activities/update",body:JSON.stringify(e),token:t.user.token})}function create(e,t){return http({method:"POST",url:t.apiUrl+"activities/create",body:JSON.stringify(e),token:t.user.token})}function removeFromOffice(r,a,i){return new Promise(function(t,n){var e=i.transaction(["map","calendar","children","list","subscriptions","activity"],"readwrite");e.oncomplete=function(){var e=i.transaction(["root"],"readwrite"),o=e.objectStore("root");o.get(a.user.uid).onsuccess=function(e){var t=e.target.result;t&&(t.officesRemoved=r,o.put(t))},e.oncomplete=function(){console.log("run read after removal"),t({response:"Office Removed",success:!0})},e.onerror=function(e){n({response:e,success:!1})}},e.onerror=function(){console.log(tx.error)},removeActivity(r,e)})}function removeActivity(e,t){var o=t.objectStore("activity").index("office"),n=t.objectStore("list").index("office"),r=t.objectStore("children").index("office"),a=t.objectStore("map").index("office"),i=t.objectStore("calendar").index("office"),s=t.objectStore("subscriptions").index("office");e.forEach(function(e){removeByIndex(o,e),removeByIndex(n,e),removeByIndex(r,e),removeByIndex(a,e),removeByIndex(i,e),removeByIndex(s,e)})}function removeByIndex(e,t){e.openCursor(t).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}}function backblaze(e,t){return http({method:"POST",url:t.apiUrl+"services/images",body:JSON.stringify(e),token:t.user.token})}function instantUpdateDB(a,i,e){return new Promise(function(t,o){var r=indexedDB.open(e.uid);r.onsuccess=function(){var e=r.result.transaction(["activity"],"readwrite"),n=e.objectStore("activity");n.get(a.activityId).onsuccess=function(e){var t=e.target.result;if(t.editable=0,"share"===i&&(a.share.forEach(function(e){t.assignees.push(e)}),n.put(t)),"update"===i){t.schedule=a.schedule,t.attachment=a.attachment;for(var o=0;o<t.venue.length;o++)t.venue[o].geopoint={_latitude:a.venue[o].geopoint.latitude,_longitude:a.venue[o].geopoint.longitude};n.put(t)}"status"===i&&(t[i]=a[i],n.put(t))},e.oncomplete=function(){t(!0)},e.onerror=function(){o(!0)}}})}function updateMap(n,e){var r=e.objectStore("map");r.index("activityId").openCursor(n.activityId).onsuccess=function(e){var t=e.target.result;if(!t)return console.log("start adding"),console.log("adding "+n.activityId,"location "+n.location),r.add(n),void console.log("finished adding to map");var o=t.delete();o.onsuccess=function(){console.log("deleted "+t.value.activityId),t.continue()},o.onerror=function(){instant({message:o.error.message})}}}function updateCalendar(n,e){var r=e.objectStore("calendar");r.index("activityId").openCursor(n.activityId).onsuccess=function(e){var t=e.target.result;if(t){var o=t.delete();o.onsuccess=function(){console.log("remove calendar"),t.continue()},o.onerror=function(){instant({message:o.error.message})}}else n.schedule.forEach(function(e){e.startTime,e.endTime;var t={activityId:n.activityId,scheduleName:e.name,timestamp:n.timestamp,template:n.template,hidden:n.hidden,start:e.startTime,end:e.endTime,status:n.status,office:n.office};r.add(t)})}}function putAttachment(e,t,o){var n=t.objectStore("children"),r={activityId:e.activityId,status:e.status,template:e.template,office:e.office,attachment:e.attachment},a=o.user.phoneNumber;"employee"===e.template&&(r.employee=e.attachment["Employee Contact"].value,e.attachment["First Supervisor"].value!==a&&e.attachment["Second Supervisor"].value!==a||(r.team=1)),n.put(r)}function removeUserFromAssigneeInActivity(e,t){if(t.length){var o=e.transaction(["activity"],"readwrite"),r=o.objectStore("activity");t.forEach(function(n){r.get(n.id).onsuccess=function(e){var t=e.target.result;if(t){var o=t.assignees.indexOf(n.user);-1<o&&(t.assignees.splice(o,1),r.put(t))}}}),o.oncomplete=function(){console.log("user removed from assignee in activity where he once was if that activity existed")}}}function removeActivityFromDB(e,t,o){if(t.length){var n=e.transaction(["activity","list","children"],"readwrite"),r=n.objectStore("activity"),a=n.objectStore("list"),i=n.objectStore("children");t.forEach(function(e){r.delete(e),a.delete(e),i.delete(e)}),n.oncomplete=function(){mapAndCalendarRemovalRequest(activitiesToRemove,o)}}}function mapAndCalendarRemovalRequest(n,e){var r=indexedDB.open(e.user.uid);r.onsuccess=function(){var e=r.result.transaction(["calendar","map"],"readwrite"),t=e.objectStore("calendar").index("activityId"),o=e.objectStore("map").index("activityId");deleteByIndex(t,n),deleteByIndex(o,n),e.oncomplete=function(){console.log("activity is removed from all stores")},e.onerror=function(){instant({message:transaction.error.message})}}}function deleteByIndex(t,e){e.forEach(function(e){t.openCursor(e).onsuccess=function(e){var t=e.target.result;t&&(t.delete().onsuccess=function(){t.continue()})}})}function updateSubscription(o,e){var n=0,r=e.objectStore("subscriptions");r.index("officeTemplate").openCursor([o.office,o.template]).onsuccess=function(e){var t=e.target.result;if(!t)return o.count=n,void r.put(o);t.value.count&&(n=t.value.count),t.delete().onsuccess=function(){console.log("deleted"),t.continue()}}}function createListStore(o,e,t){var n={activityId:o.activityId,count:e[o.activityId],timestamp:o.timestamp,activityName:o.activityName,status:o.status},r=t.objectStore("list");r.get(o.activityId).onsuccess=function(e){var t=e.target.result;n.createdTime=t?t.createdTime:o.timestamp,r.put(n)}}function successResponse(e,t,o,n,r){var a=[],i=[],s=o.transaction(["map","calendar","children","list","subscriptions","activity","addendum","root","users"],"readwrite"),c=s.objectStore("addendum"),u=s.objectStore("activity"),d=s.objectStore("users"),m={},l={};e.addendum.forEach(function(e){e.unassign&&(e.user==t.user.phoneNumber?a.push(e.activityId):i.push({id:e.activityId,user:e.user}));e.activityId;l[e.user]={ts:e.timestamp,comment:e.comment},c.add(e)}),removeActivityFromDB(o,a,t),removeUserFromAssigneeInActivity(o,i,t),e.activities.slice().reverse().forEach(function(e){e.canEdit,e.editable,u.put(e),updateCalendar(e,s),putAttachment(e,s,t),0===e.hidden&&createListStore(e,m,s),e.assignees.forEach(function(e){var t={displayName:e.displayName,mobile:e.phoneNumber,photoURL:e.photoURL};l[e.phoneNumber]&&(t.timestamp=l[e.phoneNumber].ts,t.comment=l[e.phoneNumber].comment),d.put(t)})}),e.templates.forEach(function(e){updateSubscription(e,s)}),updateRoot(e,s,t.user.uid),s.oncomplete=function(){return console.log("all completed"),n(!0)},s.onerror=function(){return r(s.error)}}function updateRoot(o,e,t){var n=e.objectStore("root");n.get(t).onsuccess=function(e){var t=e.target.result;t.fromTime=o.upto,console.log("start adding upto"),n.put(t)}}function updateIDB(i){return new Promise(function(t,o){var e=i.db.transaction(["root"]),n=e.objectStore("root"),r=void 0,a=void 0;n.get(i.meta.user.uid).onsuccess=function(e){r=e.target.result,a=r.fromTime},e.oncomplete=function(){http({method:"GET",url:i.meta.apiUrl+"read?from="+a,data:null,token:i.meta.user.token}).then(function(e){return successResponse(e,i.meta,i.db,t,o)}).catch(function(e){return o(e)})}})}self.onmessage=function(a){var e=indexedDB.open(a.data.meta.user.uid);e.onsuccess=function(){var n=e.result;if("now"!==a.data.type)"instant"!==a.data.type?"Null"!==a.data.type?requestFunctionCaller[a.data.type](a.data.body,a.data.meta).then(sendSuccessRequestToMainThread).catch(sendErrorRequestToMainThread):updateIDB({meta:a.data.meta,db:n}).then(sendSuccessRequestToMainThread).catch(sendErrorRequestToMainThread):instant(a.data.body,a.data.meta);else{var r="";fetchServerTime(a.data.body,a.data.meta,n).then(function(o){var e=n.transaction(["root"],"readwrite"),t=e.objectStore("root");t.get(a.data.meta.user.uid).onsuccess=function(e){(r=e.target.result).serverTime=o.timestamp-Date.now(),t.put(r)},e.oncomplete=function(){if(o.venues){var t=n.transaction("map","readwrite");return o.venues.forEach(function(e){updateMap(e,t)}),t.oncomplete=function(){r.venues=!0,n.transaction("root","readwrite").objectStore("root").put(r),sendSuccessRequestToMainThread("venues-set")},void(t.onerror=function(){sendErrorRequestToMainThread(t.error)})}o.removeFromOffice?Array.isArray(o.removeFromOffice)&&o.removeFromOffice.length&&removeFromOffice(o.removeFromOffice,a.data.meta,n).then(sendSuccessRequestToMainThread).catch(sendErrorRequestToMainThread):self.postMessage({response:o,success:!0})}}).catch(sendErrorRequestToMainThread)}},e.onerror=function(){}};