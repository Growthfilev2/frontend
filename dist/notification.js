importScripts("external/js/moment.min.js"),self.onmessage=function(t){var n=t.data.dbName,e=t.data.type,a=t.data.updateTimestamp,o={urgent:function(t,o){var e=t.transaction(["calendar"]),n=e.objectStore("calendar").index("urgent"),r=[],i=moment().subtract(1,"days").format("YYYY-MM-DD"),u=moment().add(1,"days").format("YYYY-MM-DD"),a=IDBKeyRange.bound(["PENDING",0],["PENDING",0]);n.openCursor(a).onsuccess=function(t){var e=t.target.result;if(e){var n=moment(e.value.end,"YYYY-MM-DD"),a=moment(e.value.start,"YYYY-MM-DD");if(moment(i).isSameOrBefore(n)&&moment(u).isSameOrAfter(a)){var o={activityId:e.value.activityId,name:e.value.scheduleName,value:e.value.end};r.push(o)}e.continue()}},e.oncomplete=function(){var e,n=(e={},r.forEach(function(t){e.hasOwnProperty(t.activityId)?moment(e[t.activityId].value).valueOf()>moment(t.value).valueOf()&&(e[t.activityId]={id:t.activityId,name:t.name,value:t.value}):e[t.activityId]={id:t.activityId,name:t.name,value:t.value}}),e),t=Object.keys(n).sort(function(t,e){return moment(n[e].value)-moment(n[t].value).valueOf()}),a=[];t.forEach(function(t){a.push(n[t])}),c("urgent").then(function(){s("urgent",{data:a.reverse(),tsUpdate:o}).then(function(t){self.postMessage(t)})})}},nearBy:function(o,r,t){var e=o.transaction(["root"]);e.objectStore("root").get(t).onsuccess=function(t){var e=t.target.result;d={latitude:e.location.latitude,longitude:e.location.longitude}},e.oncomplete=function(){var t=o.transaction(["map"],"readwrite"),e=t.objectStore("map"),n=e.index("nearby"),a=IDBKeyRange.lowerBound(["PENDING",0]);n.openCursor(a).onsuccess=function(t){var e,n,a,o,r,i,u,c,s,l=t.target.result;l&&(v.push((e=d,n=l.value,a=m(e.latitude-n.latitude),o=m(e.longitude-n.longitude),r=m(e.latitude),i=m(n.latitude),u=Math.sin(a/2)*Math.sin(a/2)+Math.sin(o/2)*Math.sin(o/2)*Math.cos(r)*Math.cos(i),c=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),s=6371*c,{id:n.activityId,distance:s,name:n.venueDescriptor,value:n.location})),l.continue())},t.oncomplete=function(){var e,t=(e=1,v.filter(function(t){return t.distance<=e})),n=t.sort(function(t,e){return t.distance-e.distance});c("nearby").then(function(){s("nearby",{data:n.reverse(),tsUpdate:r}).then(function(t){self.postMessage(t)})}).catch(console.log)}}}},r=indexedDB.open(n),d=void 0,v=[];function c(r){return new Promise(function(e,a){var o=indexedDB.open(n);o.onsuccess=function(){var t=o.result.transaction(["list"],"readwrite"),n=t.objectStore("list");n.index("status").openCursor("PENDING").onsuccess=function(t){var e=t.target.result;e&&(e.value[r]&&(e.value[r]=!1,n.put(e.value)),e.continue())},t.oncomplete=function(){e(!0)},t.onerror=function(){a(t.error)}},o.onerror=function(){a(o.error)}})}function s(o,r){return new Promise(function(e,t){var a=indexedDB.open(n);a.onsuccess=function(){var t=a.result.transaction(["list"],"readwrite"),n=t.objectStore("list");r.data.forEach(function(t){n.get(t.id).onsuccess=function(t){var e=t.target.result;e&&(r.tsUpdate&&(e.timestamp=moment().valueOf()),e[o]=!0,n.put(e))}}),t.oncomplete=function(){e(o)}}})}function m(t){return t*Math.PI/180}r.onsuccess=function(){var t=r.result;o[e](t,a,n)}};